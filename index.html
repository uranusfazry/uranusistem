<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Laporan Administrasi Sekolah - Ultimate Enterprise Edition by Uranusfazry</title>
    
    <!-- LIBRARIES FOR PDF GENERATION -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- LIBRARIES FOR ZIP EXPORT/IMPORT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- NEW: LIBRARY FOR WORD (DOCX) EXPORT -->
    <script src="https://unpkg.com/html-docx-js@0.3.1/dist/html-docx.js"></script>

    <!-- PHOSPHOR ICONS (Premium Icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* =========================================
           1. RESET & UI SYSTEM (TAMPILAN WEB)
           ========================================= */
        :root {
            --bg-app: #f8fafc;
            --sidebar-width: 320px;
            --paper-width: 215mm; /* Lebar F4 */
            --paper-height: 330mm; /* Tinggi F4 */
            --margin-doc: 20mm;
            --primary-dark: #0f172a;
            --accent-blue: #3b82f6;
            --danger-red: #ef4444;
            --code-purple: #8b5cf6; /* Warna baru untuk fitur HTML */
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            color: #334155;
        }

        /* PRINT LOCK UI */
        body.printing {
            pointer-events: none;
            user-select: none;
        }

        /* EXPORTING MODE */
        body.exporting .btn-remove-page, 
        body.exporting .no-print-in-pdf,
        body.exporting .edit-badge,
        body.exporting .zoom-controls,
        body.exporting .duplicate-controls,
        body.exporting .zoom-indicator {
            display: none !important;
        }

        /* WRAPPER UTAMA */
        .app-container {
            display: flex;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Sidebar Control Panel */
        aside {
            width: var(--sidebar-width);
            background: var(--primary-dark);
            color: #f8fafc;
            padding: 25px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #334155;
            overflow-y: auto;
            z-index: 200;
            box-shadow: 4px 0 24px rgba(0,0,0,0.15);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        aside h2 { 
            font-size: 1.1rem; 
            margin-top: 0; 
            margin-bottom: 25px;
            border-bottom: 1px solid #334155; 
            padding-bottom: 15px; 
            letter-spacing: 0.5px;
            font-weight: 600;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Form Controls Styling */
        .control-group { margin-bottom: 18px; }
        .control-group label { 
            display: block; 
            font-size: 0.75rem; 
            margin-bottom: 6px; 
            color: #94a3b8; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        .control-group input { 
            width: 100%; 
            padding: 10px 12px; 
            border-radius: 6px; 
            border: 1px solid #475569; 
            background: #1e293b;
            color: white;
            font-size: 0.9rem; 
            transition: all 0.2s;
        }
        .control-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        /* Buttons */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%; 
            padding: 12px; 
            margin-bottom: 10px;
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            gap: 8px;
        }
        .btn-add { 
            background: #334155; 
            color: #e2e8f0; 
            border: 1px solid #475569;
        }
        .btn-add:hover { 
            background: var(--accent-blue); 
            color: white; 
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }
        .btn-print { 
            background: #10b981; 
            color: white; 
            margin-top: 20px; 
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        .btn-print:hover { 
            background: #059669; 
            transform: translateY(-1px);
        }
        
        .btn-danger { 
            background: rgba(239, 68, 68, 0.1); 
            color: #ef4444; 
            border: 1px solid rgba(239, 68, 68, 0.3);
            margin-top: 10px;
        }
        .btn-danger:hover {
            background: #ef4444;
            color: white;
        }

        .btn-edit {
            background: #e0e7ff; 
            color: #4338ca; 
            border: 1px solid #c7d2fe; 
            margin-top: 10px;
        }
        .btn-edit:hover {
            background: #c7d2fe;
        }

        /* NEW: HTML Editor Button Style */
        .btn-html-edit {
            background: #f3e8ff;
            color: #7e22ce;
            border: 1px solid #d8b4fe;
            margin-top: 5px;
        }
        .btn-html-edit:hover {
            background: #d8b4fe;
        }

        /* NEW: Reset Button Style */
        .btn-reset {
            background: transparent;
            color: #94a3b8;
            border: 1px dashed #475569;
            margin-top: 20px;
            font-size: 0.8rem;
        }
        .btn-reset:hover {
            background: rgba(255,255,255,0.05);
            color: #cbd5e1;
            border-color: #cbd5e1;
        }
        
        .section-divider {
            margin: 25px 0 15px 0;
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            padding-left: 10px;
        }
        .section-divider::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            background: #64748b;
            border-radius: 50%;
        }

        /* HAMBURGER MENU */
        .menu-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 500;
            background: var(--primary-dark);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            font-size: 24px;
            display: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        .menu-toggle:active { transform: scale(0.95); }

        /* Main Workspace */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: transparent;
            scroll-behavior: smooth;
        }

        /* =========================================
           2. RESPONSIVE LOGIC
           ========================================= */
        
        @media (max-width: 1024px) {
            .menu-toggle { display: flex; }
            aside {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100%;
                width: 280px;
                transform: translateX(0);
                transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            aside.active { left: 0; }
            aside.active::before {
                content: '';
                position: fixed;
                top: 0; left: 280px;
                width: 100vw; height: 100vh;
                background: rgba(0,0,0,0.5);
                z-index: -1;
            }
            main { padding-top: 80px; width: 100%; }
        }

        @media (min-width: 769px) and (max-width: 1200px) {
            .sheet { transform: scale(0.75); transform-origin: top center; margin-bottom: -200px !important; }
        }

        @media (max-width: 768px) {
            .sheet { transform: scale(0.55); transform-origin: top center; margin-bottom: -400px !important; }
            main { padding-left: 0; padding-right: 0; }
        }

        @media (min-width: 1600px) {
            main { max-width: 1800px; margin: 0 auto; }
        }

        /* =========================================
           3. DOCUMENT STYLE (TAMPILAN KERTAS)
           ========================================= */
        .sheet {
            background: white;
            width: var(--paper-width);
            min-height: var(--paper-height);
            padding: var(--margin-doc);
            margin-bottom: 40px;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.25);
            position: relative;
            font-family: 'Times New Roman', Times, serif;
            color: #000;
            line-height: 1.15;
            font-size: 12pt;
            transition: transform 0.3s ease;
            pointer-events: auto;
            break-inside: avoid;
        }

        /* Fitur Editable */
        [contenteditable="true"]:hover { background-color: rgba(255, 230, 0, 0.1); outline: 1px dashed #e2e8f0; cursor: text; }
        [contenteditable="true"]:focus { background-color: rgba(255, 245, 157, 0.3); outline: none; border-bottom: 2px solid var(--accent-blue); }
        
        textarea.print-safe {
            width: 100%;
            border: 1px dashed #cbd5e1;
            font-family: inherit;
            font-size: inherit;
            resize: none;
            background: transparent;
            overflow: hidden;
            min-height: 40px;
            padding: 5px;
            transition: border 0.2s;
        }
        textarea.print-safe:focus { border: 1px solid var(--accent-blue); background: #f8fafc; outline: none; }
        
        .text-center { text-align: center; }
        .text-bold { font-weight: bold; }
        .text-upper { text-transform: uppercase; }
        .full-width { width: 100%; }
        .mt-2 { margin-top: 10mm; }
        .mb-2 { margin-bottom: 10mm; }
        .text-small { font-size: 10pt; }

        .kop-surat { display: flex; align-items: center; border-bottom: 3px double #000; padding-bottom: 10px; margin-bottom: 20px; gap: 20px; }
        .kop-img { width: 80px; height: 90px; object-fit: contain; cursor: pointer; transition: opacity 0.2s; }
        .kop-img:hover { opacity: 0.7; }
        .kop-text { text-align: center; flex: 1; }
        .kop-text h3 { margin: 0; font-size: 14pt; font-weight: bold; }
        .kop-text h2 { margin: 0; font-size: 16pt; font-weight: bold; }
        .kop-text p { margin: 0; font-size: 10pt; }

        table.dinas { width: 100%; border-collapse: collapse; margin: 10px 0; }
        table.dinas th, table.dinas td { border: 1px solid #000; padding: 4px 8px; vertical-align: middle; }
        table.dinas th { background-color: #f3f4f6; text-align: center; font-weight: bold; }

        table.table-padat { width: 100%; border-collapse: collapse; font-size: 10pt; margin: 10px 0; }
        table.table-padat th, table.table-padat td { border: 1px solid #000; padding: 2px 4px; vertical-align: middle; }
        table.table-padat th { background-color: #f3f4f6; text-align: center; font-weight: bold; }
        table.table-padat input { border: none; width: 100%; text-align: center; font-family: inherit; font-size: inherit; outline: none; background: transparent; }

        .col-nilai-akhir { border-left: 2px solid #000 !important; border-right: 2px solid #000 !important; font-weight: bold; font-size: 1.1em; background: #fafafa; }

        table.table-grid { width: 100%; border-collapse: collapse; font-size: 9pt; table-layout: fixed; margin: 10px 0; page-break-inside: auto; }
        table.table-grid th, table.table-grid td { border: 1px solid #000; padding: 2px 0; text-align: center; vertical-align: middle; overflow: hidden; }
        table.table-grid th { font-size: 8pt; background: #eee; }
        table.table-grid tr { page-break-inside: avoid; }

        table.list-data { width: 100%; border: none; }
        table.list-data td { border: none; padding: 4px 0; vertical-align: top; }
        table.list-data td:first-child { width: 200px; }
        table.list-data td:nth-child(2) { width: 20px; text-align: center; }

        .program-list { list-style: none; padding: 0; margin: 0; }
        .program-list li { margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        input[type="checkbox"] { width: 16px; height: 16px; accent-color: #000; cursor: pointer; }

        .photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .photo-card { border: 1px solid #000; padding: 5px; page-break-inside: avoid; }
        .photo-placeholder { width: 100%; height: 200px; background: #f8fafc; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; border: 1px dashed #94a3b8; transition: background 0.2s; }
        .photo-placeholder:hover { background: #f1f5f9; }
        .photo-placeholder img { width: 100%; height: 100%; object-fit: cover; }
        .photo-caption { margin-top: 5px; font-size: 10pt; min-height: 20px; border-top: 1px dotted #ccc; }

        .signature-section { display: flex; justify-content: space-between; margin-top: 30px; page-break-inside: avoid; }
        .ttd-box { width: 40%; text-align: center; }
        .ttd-space { height: 80px; }

        .cover-border {
            border: 3px double #000;
            height: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            text-align: center;
        }

        .page-number { position: absolute; bottom: 10mm; left: 0; right: 0; text-align: center; font-size: 9pt; color: #444; z-index: 10;}

        /* KELAS KHUSUS LANDSCAPE */
        .sheet.landscape {
            width: 330mm !important;
            min-height: 215mm !important;
            padding: 20mm 25mm !important; /* Margin kiri & kanan diperlebar */
        }

        @media print {
            .sheet.landscape {
                width: 100% !important;
                min-height: 215mm !important;
                padding: 20mm 25mm !important; /* Mempertahankan margin di versi PDF */
                page-break-after: always;
            }
        }

        /* =========================================
           4. PREMIUM EDIT MODE UI
           ========================================= */
        /* Visual State saat Edit Aktif */
        .sheet.editing {
            outline: 3px solid var(--accent-blue);
            box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.15);
            z-index: 100; /* Angkat layer */
            cursor: text;
        }

        /* Hover effect pada elemen yang bisa diedit */
        .sheet.editing [contenteditable="true"]:hover {
            background-color: #fff7ed; /* Orange tipis premium */
            outline: 1px dashed #fdba74;
            border-radius: 2px;
        }

        /* Badge Indicator Floating */
        .edit-badge {
            position: absolute;
            top: -15px;
            left: 20px;
            background: var(--accent-blue);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            pointer-events: none;
            animation: slideDown 0.3s ease;
            z-index: 1001;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Lock Protection: Sembunyikan kontrol lain saat edit mode */
        .sheet.editing .sheet-controls,
        .sheet.editing input[type="checkbox"], 
        .sheet.editing input[type="text"],
        .sheet.editing textarea {
            pointer-events: none; /* Cegah interaksi elemen form asli */
            opacity: 0.7;
        }

        /* =========================================
           5. MODERN MODAL UI (COMMON)
           ========================================= */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.45);
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(6px);
            z-index: 99999;
        }

        .modal-box {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 340px;
            box-shadow: 0 25px 60px rgba(0,0,0,.25);
            animation: fadeIn .25s ease;
            font-family: 'Segoe UI', sans-serif;
            position: relative;
        }

        /* NEW: LARGE MODAL VARIANT FOR CODE EDITOR */
        .modal-box.modal-large {
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .modal-box h3 { margin-top: 0; color: #1e293b; }
        
        .modal-box select {
            width: 100%;
            padding: 12px;
            margin: 15px 0 25px 0;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: auto; /* Push to bottom in flex containers */
        }

        .modal-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        /* Delete Modal Specifics */
        #deleteModal .modal-actions button:first-child { background: #ef4444; color: white; }
        #deleteModal .modal-actions button:first-child:hover { background: #dc2626; }

        /* Edit Modal Specifics */
        #editModal .modal-actions button:first-child { background: var(--accent-blue); color: white; }
        #editModal .modal-actions button:first-child:hover { background: #2563eb; }

        /* NEW: HTML Editor Modal Specifics */
        #htmlEditorModal .modal-actions button.btn-save-html { background: var(--code-purple); color: white; }
        #htmlEditorModal .modal-actions button.btn-save-html:hover { background: #7c3aed; }
        
        #htmlEditorModal .modal-actions button.btn-preview-html { background: #e0e7ff; color: #4338ca; border: 1px solid #c7d2fe; }
        #htmlEditorModal .modal-actions button.btn-preview-html:hover { background: #c7d2fe; }

        .modal-actions button:last-child { background: #e2e8f0; color: #475569; }
        .modal-actions button:last-child:hover { background: #cbd5e1; }

        /* NEW: CODE EDITOR STYLES */
        .code-editor-container {
            flex: 1;
            margin: 15px 0;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: #1e1e1e; /* Dark Theme */
        }

        .code-textarea {
            flex: 1;
            width: 100%;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            color: #d4d4d4;
            background: #1e1e1e;
            border: none;
            resize: none;
            outline: none;
            white-space: pre;
            overflow: auto;
        }

        .code-textarea::selection {
            background: #264f78;
        }

        .code-toolbar {
            padding: 8px 15px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            color: #ccc;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @keyframes fadeIn{
            from{opacity:0; transform:translateY(20px);}
            to{opacity:1; transform:translateY(0);}
        }

        /* =========================================
           6. PRINT QUERY
           ========================================= */
        @media print {
            @page { size: 215mm 330mm; margin: 0; }
            body { background: white; display: block; height: auto; overflow: visible; }
            aside, .btn, .menu-toggle, .modal { display: none !important; }
            .app-container { display: block !important; height: auto !important; overflow: visible !important; }
            main { display: block !important; padding: 0; margin: 0; max-width: none; overflow: visible !important; }
            .sheet { width: 100%; min-height: 330mm; margin: 0; box-shadow: none; page-break-after: always; transform: none !important; margin-bottom: 0 !important; }
            [contenteditable="true"] { outline: none !important; background: transparent !important; border-bottom: none !important; }
            textarea.print-safe { border: none; resize: none; padding: 0; margin: 0; }
            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            input[type="checkbox"] { appearance: none; -webkit-appearance: none; width: 15px; height: 15px; border: 1px solid #000; background: #fff; display: inline-block; vertical-align: middle; }
            input[type="checkbox"]:checked { background: #000; position: relative; }
            input[type="checkbox"]:checked:after { content: '‚úì'; color: #fff; font-size: 12px; position: absolute; top: -2px; left: 1px; }
        }

        /* =========================================
           7. NEW EMBED ENGINE STYLES
           ========================================= */
        .embed-safe-zone {
            width: 100%;
            /* Pastikan konten tidak merusak layout F4 */
            overflow: hidden; 
            position: relative;
            /* Reset CSS dasar agar style user tidak konflik parah */
            font-family: initial;
            font-size: initial;
            line-height: initial;
            color: initial;
        }

        /* Penanda visual di mode edit */
        .sheet[data-page-type="embed"]::before {
            content: "RAW HTML EMBED";
            position: absolute;
            top: 0; left: 0;
            background: #f1f5f9;
            color: #94a3b8;
            font-size: 9px;
            padding: 2px 5px;
            opacity: 0.5;
            pointer-events: none;
            z-index: 20;
        }
    </style>

    <!-- =========================================
       8. NEW UX OVERLAY STYLES (ENTERPRISE UI)
       ========================================= -->
    <style id="ux-styles">
        /* Scoped to prevent conflict using prefix 'ux-' */
        
        /* UX Toast Notification */
        .ux-toast-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 100000;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: none;
        }
        
        .ux-toast {
            background: white;
            border-left: 5px solid;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15), 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: auto;
            font-family: 'Segoe UI', sans-serif;
            font-size: 0.95rem;
        }
        
        .ux-toast.visible { transform: translateX(0); }
        .ux-toast.success { border-color: #10b981; }
        .ux-toast.error { border-color: #ef4444; }
        .ux-toast.warning { border-color: #eab308; }
        .ux-toast.info { border-color: #3b82f6; }
        .ux-toast i { font-size: 1.4rem; }
        .ux-toast.success i { color: #10b981; }
        .ux-toast.error i { color: #ef4444; }
        .ux-toast.warning i { color: #eab308; }
        .ux-toast.info i { color: #3b82f6; }

        /* UX Loading Overlay */
        .ux-loader-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(8px);
            z-index: 200000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .ux-loader-overlay.active { opacity: 1; pointer-events: all; }
        
        .ux-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }
        
        .ux-loader-text {
            color: white;
            font-weight: 500;
            letter-spacing: 0.5px;
            font-size: 1.1rem;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* UX Button Loading State */
        .btn.ux-btn-loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }
        .btn.ux-btn-loading::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }

        /* UX Confirmation Modal (Replacing Native Confirm) */
        .ux-confirm-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 100001;
            display: none;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', sans-serif;
        }
        .ux-confirm-box {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 400px;
            max-width: 90vw;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .ux-confirm-modal.active { display: flex; }
        .ux-confirm-modal.active .ux-confirm-box { transform: scale(1); opacity: 1; }
        
        .ux-confirm-icon {
            width: 48px;
            height: 48px;
            background: #fee2e2;
            color: #ef4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .ux-confirm-title { font-size: 1.25rem; font-weight: 700; color: #1e293b; margin: 0 0 10px 0; }
        .ux-confirm-desc { color: #64748b; margin: 0 0 25px 0; line-height: 1.5; }
        
        .ux-confirm-actions { display: flex; gap: 12px; justify-content: flex-end; }
        
        .ux-btn { padding: 10px 18px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; transition: 0.2s; }
        .ux-btn-cancel { background: #f1f5f9; color: #475569; }
        .ux-btn-cancel:hover { background: #e2e8f0; }
        .ux-btn-confirm { background: #ef4444; color: white; }
        .ux-btn-confirm:hover { background: #dc2626; }

        /* Auto Save Indicator */
        .ux-save-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #0f172a;
            color: #e2e8f0;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.8rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 999;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ux-save-indicator.active { transform: translateX(-50%) translateY(0); }
        .ux-save-spinner { width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.2); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
    </style>

    <!-- =========================================
         NEW OVERRIDE STYLES (NON-DESTRUCTIVE)
         ========================================= -->
    <style id="custom-override-styles">
        /* 1. OVERRIDE COVER TANPA HAPUS CODE LAMA */
        .cover-border .text-upper {
            text-transform: none !important;
        }

        .cover-border h1,
        .cover-border h2,
        .cover-border h3,
        .cover-border p,
        .cover-border span {
            text-transform: none !important;
        }

        /* 2. MEMASTIKAN NAMA GURU & KEPSEK TIDAK OTOMATIS KAPITAL DI SELURUH HALAMAN (TERMASUK TTD) */
        .data-guru,
        .data-kepsek,
        .signature-section .text-upper,
        .text-upper .data-guru,
        .text-upper .data-kepsek {
            text-transform: none !important;
        }

        /* 3. FONT GLOBAL TIMES NEW ROMAN */
        body,
        .sheet,
        .cover-border,
        table,
        td,
        th,
        input,
        textarea,
        select,
        .embed-safe-zone,
        .embed-safe-zone * {
            font-family: "Times New Roman", Times, serif !important;
        }
    </style>

    <!-- =========================================
         NEW: FITUR ORIENTASI HALAMAN (ADDITIVE)
         ========================================= -->
    <style id="orientation-additive-styles">
        /* Pastikan Portrait spesifik 215x330mm */
        .sheet.portrait {
            width: 215mm !important;
            min-height: 330mm !important;
            padding: var(--margin-doc) !important;
        }
        
        /* Landscape sudah terdefinisi di kode awal, 
           namun kita override memastikan konsistensi */
        .sheet.landscape {
            width: 330mm !important;
            min-height: 215mm !important;
            padding: 20mm 25mm !important;
        }
    </style>

    <!-- =========================================
         NEW: LAYOUT DRAG & ZOOM STYLES (ADDITIVE)
         ========================================= -->
    <style id="layout-drag-styles">
        .sheet {
            /* Hapus flex agar tinggi alami (F4/Overflow) tidak rusak */
            display: block !important;
        }
        .layout-stage {
            position: relative;
            width: 100%;
            min-height: 100%; 
            overflow: hidden;
            display: block;
        }
        .layout-movable {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100%;
            transform-origin: top left !important; /* PENTING UNTUK ZOOM PRESISI */
            transition: box-shadow 0.2s ease, outline 0.2s ease;
        }
        
        /* DRAG MODE ACTIVE */
        body.layout-drag-mode {
            touch-action: none; /* Mencegah layar scroll/pull-to-refresh saat geser di HP */
        }
        
        body.layout-drag-mode .layout-movable {
            cursor: move !important;
            user-select: none !important;
            outline: 2px dashed #3b82f6 !important;
            background: rgba(59, 130, 246, 0.05) !important;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1) !important;
            z-index: 50;
        }
        
        body.layout-drag-mode .sheet.editing {
            outline: none !important;
            box-shadow: none !important;
        }
        body.layout-drag-mode [contenteditable="true"] {
            pointer-events: none !important;
        }

        /* --- ADDITIVE ZOOM UI STYLES --- */
        .zoom-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.95);
            padding: 4px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 100;
            opacity: 0.1; /* Transparan default agar tidak ganggu dokumen */
            transition: opacity 0.2s ease, transform 0.2s ease;
            border: 1px solid #cbd5e1;
        }
        .sheet:hover .zoom-controls {
            opacity: 1; /* Muncul penuh saat sheet di-hover */
        }
        body.layout-drag-mode .zoom-controls {
            display: none !important; /* Sembunyikan saat mode drag full */
        }
        .zoom-btn {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            color: #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
        }
        .zoom-btn:hover { background: #e2e8f0; }

        /* PERBAIKAN ZOOM: Button UI & Value Status */
        .zoom-value {
            min-width: 48px;
            font-variant-numeric: tabular-nums;
            transition: all 0.2s ease;
        }
        .zoom-btn:disabled {
            opacity: 0.4 !important;
            cursor: not-allowed !important;
            background: #e2e8f0 !important;
            color: #94a3b8 !important;
        }

        .zoom-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 23, 42, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 24px;
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 200;
            backdrop-filter: blur(4px);
        }
        .zoom-indicator.show { opacity: 1; }

        /* --- ADDITIVE: DUPLICATE UI STYLES --- */
        .duplicate-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 100;
            opacity: 0.1;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .sheet:hover .duplicate-controls {
            opacity: 1;
        }
        body.layout-drag-mode .duplicate-controls,
        body.exporting .duplicate-controls {
            display: none !important;
        }
        .duplicate-btn-sheet {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            color: #10b981;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        .duplicate-btn-sheet:hover {
            background: #d1fae5;
            border-color: #34d399;
            transform: translateY(-1px);
        }
        .checkbox-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* --- ADDITIVE: AUTO FLOW & GUIDES STYLES --- */
        .page-break {
            page-break-before: always;
            break-before: page;
            width: 100%;
            height: 1px;
            border-top: 2px dashed #f43f5e;
            margin: 20px 0;
            position: relative;
            clear: both;
        }
        .page-break::after {
            content: '--- PAGE BREAK ---';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0 10px;
            color: #f43f5e;
            font-size: 10px;
            font-family: monospace;
        }
        
        .no-break {
            page-break-inside: avoid;
            break-inside: avoid;
        }
        
        @media print {
            .page-break::after { display: none !important; }
            .page-break { border-top: none !important; margin: 0 !important; }
        }

        body.show-margin-guides .sheet::after {
            content: '';
            position: absolute;
            top: var(--margin-doc);
            bottom: var(--margin-doc);
            left: var(--margin-doc);
            right: var(--margin-doc);
            border: 1px dashed rgba(59, 130, 246, 0.4);
            pointer-events: none;
            z-index: 50;
        }
        
        /* Landscape Guide Override */
        body.show-margin-guides .sheet.landscape::after {
            top: 20mm; bottom: 20mm; left: 25mm; right: 25mm;
        }
    </style>

    <!-- =========================================
         NEW: PAPER SIZE STYLES (ADDITIVE)
         ========================================= -->
    <style id="paper-size-additive-styles">
        .paper-size-badge {
            position: absolute;
            bottom: -30px; 
            right: 20px;
            background: #f1f5f9;
            color: #64748b;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
            font-family: 'Inter', sans-serif;
            z-index: 100;
        }
        body.exporting .paper-size-badge { display: none !important; }
        @media print { .paper-size-badge { display: none !important; } }
        
        #customPaperInputs { display: none; gap: 10px; margin-bottom: 25px; }
        #customPaperInputs input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; }
    </style>

    <!-- =========================================
         NEW: CUSTOM MARGIN STYLES (ADDITIVE)
         ========================================= -->
    <style id="margin-additive-styles">
        /* Menyesuaikan garis panduan (margin guides) secara dinamis menggunakan variabel lokal 
           Bypass default margin-doc ketika diatur custom */
        body.show-margin-guides .sheet::after {
            top: var(--m-top, var(--margin-doc)) !important;
            right: var(--m-right, var(--margin-doc)) !important;
            bottom: var(--m-bottom, var(--margin-doc)) !important;
            left: var(--m-left, var(--margin-doc)) !important;
        }
    </style>

    <!-- =========================================
         NEW: TABLE MODE STYLES (ADDITIVE)
         ========================================= -->
    <style id="table-mode-styles">
        .table-toolbar {
            position: absolute;
            background: white;
            border: 1px solid #cbd5e1;
            padding: 5px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: flex;
            gap: 5px;
            animation: fadeIn 0.2s ease;
        }
        .table-toolbar button {
            background: #10b981;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }
        .table-toolbar button:hover {
            background: #059669;
        }
        /* Sembunyikan saat ekspor/print */
        body.exporting .table-toolbar { display: none !important; }
        @media print { .table-toolbar { display: none !important; } }

        /* Highlight visual tabel saat mode tabel aktif */
        body.table-mode table {
            outline: 2px dashed rgba(16, 185, 129, 0.4);
            cursor: pointer;
        }
        body.table-mode table:hover {
            outline: 2px dashed rgba(16, 185, 129, 0.8);
            background: rgba(16, 185, 129, 0.02);
        }
    </style>

    <!-- =========================================
         NEW: FIND & REPLACE STYLES (ADDITIVE)
         ========================================= -->
    <style id="find-replace-styles">
        .find-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.45);
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(6px);
            z-index: 99999;
        }

        .find-box {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 340px;
            box-shadow: 0 25px 60px rgba(0,0,0,.25);
            animation: fadeIn .25s ease;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .find-box h3 { 
            margin: 0 0 10px 0; 
            color: #1e293b; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 18px; 
            font-weight: 600; 
        }

        .find-box input {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 0.9rem;
            outline: none;
        }
        .find-box input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .find-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 5px;
        }

        .find-actions button {
            flex: 1 1 30%;
            padding: 6px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .find-actions button:nth-child(1),
        .find-actions button:nth-child(2) {
            background: #3b82f6;
            color: white;
        }
        .find-actions button:nth-child(1):hover,
        .find-actions button:nth-child(2):hover { background: #2563eb; }

        .find-actions button:nth-child(3),
        .find-actions button:nth-child(4) {
            background: #f59e0b;
            color: white;
        }
        .find-actions button:nth-child(3):hover,
        .find-actions button:nth-child(4):hover { background: #d97706; }

        .find-actions button:nth-child(5) {
            background: #6b7280;
            color: white;
        }
        .find-actions button:nth-child(5):hover { background: #4b5563; }

        .find-actions button:nth-child(6) {
            background: #e5e7eb;
            color: #374151;
        }
        .find-actions button:nth-child(6):hover { background: #d1d5db; }

        .find-highlight {
            background: #fff59d; /* Kuning soft profesional */
            border-radius: 2px;
            color: #000;
        }

        .find-active {
            background: #ffb74d !important; /* Oranye aktif */
            color: #000 !important;
            font-weight: 600;
        }
        
        #findCounter {
            font-size: 0.8rem;
            color: #64748b;
            text-align: right;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <!-- HAMBURGER MENU BUTTON -->
    <button class="menu-toggle">‚ò∞</button>

    <!-- APP WRAPPER -->
    <div class="app-container">

        <!-- SIDEBAR -->
        <aside>
            <h2>
                <i class="ph ph-buildings" style="font-size: 24px;"></i> Uranus Word
            </h2>
            
            <div class="section-divider">Halaman</div>
            
            <!-- TEMPLATE CUSTOM & EMBED (THE ONLY ONES LEFT) -->
            <button class="btn btn-add" onclick="handleAddPage('custom', this)"><i class="ph ph-magic-wand"></i> Halaman Custom</button>
            <button class="btn btn-add" style="border-style: dashed;" onclick="openEmbedModal()"><i class="ph ph-code"></i> Embed HTML / Code</button>

            <div class="section-divider">Actions</div>

            <!-- NEW: HISTORY BUTTONS (ADDITIVE) -->
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button class="btn btn-edit" style="margin: 0; flex: 1; background: #f8fafc; border-color: #cbd5e1; color: #475569;" onclick="handleUndo()" title="Undo (Ctrl+Z)">
                    <i class="ph ph-arrow-counter-clockwise"></i> Undo
                </button>
                <button class="btn btn-edit" style="margin: 0; flex: 1; background: #f8fafc; border-color: #cbd5e1; color: #475569;" onclick="handleRedo()" title="Redo (Ctrl+Y)">
                    <i class="ph ph-arrow-clockwise"></i> Redo
                </button>
            </div>

            <!-- NEW: BUTTON FIND & REPLACE (ADDITIVE) -->
            <button class="btn btn-edit" style="background:#fffbeb; color:#d97706; border-color:#fde68a;" onclick="openFindModal()" title="Cari (Ctrl+F)">
                <i class="ph ph-magnifying-glass"></i> üîé Cari & Ganti Teks
            </button>
            
            <!-- BUTTON DELETE DI SIDEBAR -->
            <button class="btn btn-danger" onclick="openDeleteModal()">
                <i class="ph ph-trash"></i> Hapus Halaman
            </button>

            <!-- BUTTON EDIT MODE -->
            <button class="btn btn-edit" onclick="openEditModal()">
                <i class="ph ph-pencil"></i> Edit Custom Halaman
            </button>

            <!-- BUTTON EDIT HTML -->
            <button class="btn btn-html-edit" onclick="openHtmlEditSelectionModal()">
                <i class="ph ph-code-block"></i> üß© Edit HTML Halaman
            </button>

            <!-- NEW: BUTTON PAGE STYLE INSPECTOR (ADDITIVE) -->
            <button class="btn btn-edit" style="background:#f0fdf4; color:#15803d; border-color:#bbf7d0;" onclick="openPageStyleModal()">
                <i class="ph ph-paint-brush"></i> üé® Gaya & Tipografi Halaman
            </button>

            <!-- NEW: BUTTON TEXT STYLE INSPECTOR (ADDITIVE) -->
            <button class="btn btn-edit" style="background:#eff6ff; color:#1d4ed8; border-color:#bfdbfe;" onclick="openTextStyleModal()">
                <i class="ph ph-text-t"></i> üÖ∞Ô∏è Gaya Teks (Per Kata)
            </button>

            <!-- NEW: BUTTON TABLE MODE (ADDITIVE) -->
            <button class="btn btn-edit" style="background:#fdf4ff; color:#a21caf; border-color:#f5d0fe;" onclick="toggleTableMode(this)">
                <i class="ph ph-table"></i> üßæ Mode Tabel
            </button>

            <!-- NEW: BUTTON DUPLICATE MULTI (ADDITIVE) -->
            <button class="btn btn-edit" style="background:#ccfbf1; color:#065f46; border-color:#99f6e4;" onclick="openDuplicateMultiModal()">
                <i class="ph ph-copy"></i> üìÑ Duplicate Multi Halaman
            </button>

            <!-- NEW: BUTTON ORIENTASI (ADDITIVE) -->
            <button class="btn btn-edit" style="background:#fef08a; color:#854d0e; border-color:#fde047;" onclick="openOrientationModal()">
                <i class="ph ph-arrows-left-right"></i> üîÑ Ubah Orientasi
            </button>

            <!-- NEW: BUTTON PAPER SIZE (ADDITIVE) -->
            <button class="btn btn-edit" style="background:#f3e8ff; color:#6b21a8; border-color:#d8b4fe;" onclick="openPaperSizeModal()">
                <i class="ph ph-ruler"></i> üìè Ubah Ukuran Kertas
            </button>

            <!-- NEW: BUTTON MARGIN (ADDITIVE) -->
            <button class="btn btn-edit" style="background:#fee2e2; color:#991b1b; border-color:#fca5a5;" onclick="openMarginModal()">
                <i class="ph ph-bounding-box"></i> üìê Atur Margin Halaman
            </button>

            <!-- NEW: BUTTON GESER LAYOUT (ADDITIVE) -->
            <button class="btn btn-edit" style="background:#dcfce7; color:#166534; border-color:#bbf7d0;" onclick="toggleLayoutDragMode(this)">
                <i class="ph ph-arrows-out-cardinal"></i> üß≠ Mode Geser Layout
            </button>

            <div class="section-divider">Smart Layout Engine</div>
            
            <!-- NEW: AUTO FLOW TRIGGER -->
            <button class="btn btn-edit" style="background:#e0e7ff; color:#3730a3; border-color:#a5b4fc;" onclick="triggerAutoFlowEngine()">
                <i class="ph ph-magic-wand"></i> Rapikan Halaman (Auto Flow)
            </button>

            <!-- NEW: MARGIN GUIDES TOGGLE -->
            <button class="btn btn-edit" style="background:#f1f5f9; color:#475569; border-color:#cbd5e1;" onclick="toggleMarginGuides(this)">
                <i class="ph ph-frame-corners"></i> Tampilkan Garis Margin
            </button>

            <div class="section-divider">Data Management</div>

            <!-- FITUR BARU: EXPORT & IMPORT ZIP -->
            <button class="btn btn-add" style="background:#4f46e5; border-color:#4338ca;" onclick="exportToZip()">
                <i class="ph ph-package"></i> Export ZIP (Backup Data)
            </button>
            <button class="btn btn-add" style="background:#0284c7; border-color:#3730a3;" onclick="importFromZipTrigger()">
                <i class="ph ph-file-zip"></i> Import ZIP (Restore)
            </button>
            <!-- Hidden input file untuk sistem Load ZIP -->
            <input type="file" id="zipLoader" accept=".zip" style="display:none;" onchange="processZipImport(event)">

            <!-- WRAPPED SAFE PRINT HANDLER -->
            <button class="btn btn-print" onclick="handleSafePrint(this)"><i class="ph ph-printer"></i> Download PDF (F4)</button>

            <!-- NEW: WRAPPED SAFE WORD EXPORT HANDLER -->
            <button class="btn btn-print" style="background:#2563eb; margin-top:10px; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);" onclick="handleExportWordWrapper(this)">
                <i class="ph ph-file-doc"></i> Download Word (.docx)
            </button>

            <!-- WRAPPED RESET HANDLER -->
            <button class="btn btn-reset" onclick="handleResetAllPages()"><i class="ph ph-arrows-counter-clockwise"></i> Reset Semua Halaman</button>
            
            <p style="font-size:0.7rem; color:#94a3b8; text-align:center; margin-top:20px;">
                v10.0 Auto Flow | Multi-Duplicate | F4 Engine
            </p>
        </aside>

        <!-- MAIN DOCUMENT AREA -->
        <main id="document-area">
            <!-- Halaman akan muncul di sini -->
        </main>
    
    </div> <!-- End App Container -->

    <!-- MODAL DELETE SYSTEM (EXISTING - PRESERVED) -->
    <div id="deleteModal" class="modal">
       <div class="modal-box">
            <h3>Hapus Halaman</h3>
            <p style="font-size:0.9rem; color:#64748b; margin-bottom:5px;">Pilih halaman yang ingin dihapus:</p>

            <select id="deletePageSelect"></select>

            <div class="modal-actions">
                <button onclick="handleConfirmDelete()">Hapus</button>
                <button onclick="closeDeleteModal()">Batal</button>
            </div>
       </div>
    </div>

    <!-- MODAL EDIT SYSTEM (EXISTING - PRESERVED) -->
    <div id="editModal" class="modal">
       <div class="modal-box">
            <h3>Edit Custom Halaman</h3>
            <p style="font-size:0.9rem; color:#64748b; margin-bottom:5px;">Pilih halaman untuk masuk mode edit:</p>

            <select id="editPageSelect"></select>

            <div class="modal-actions">
                <button onclick="handleConfirmEditMode()">‚úÖ Aktifkan Edit</button>
                <button onclick="closeEditModal()">Batal</button>
            </div>
       </div>
    </div>

    <!-- NEW MODAL: HTML SELECT SYSTEM -->
    <div id="htmlEditSelectModal" class="modal">
       <div class="modal-box">
            <h3><i class="ph ph-code-block" style="color:var(--code-purple)"></i> Edit HTML Halaman</h3>
            <p style="font-size:0.9rem; color:#64748b; margin-bottom:5px;">Pilih halaman yang ingin diedit kode sumbernya:</p>

            <select id="htmlPageSelect"></select>

            <div class="modal-actions">
                <button style="background:var(--code-purple); color:white;" onclick="handleOpenHtmlEditor()">Buka Editor</button>
                <button onclick="closeHtmlEditSelectModal()">Batal</button>
            </div>
       </div>
    </div>

    <!-- NEW MODAL: LARGE HTML EDITOR -->
    <div id="htmlEditorModal" class="modal">
       <div class="modal-box modal-large">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;"><i class="ph ph-file-code"></i> Source Code Editor</h3>
                <span id="editorPageInfo" style="font-size:0.8rem; background:#f1f5f9; padding:4px 8px; border-radius:4px; color:#64748b;">Halaman ?</span>
            </div>
            
            <div class="code-editor-container">
                <div class="code-toolbar">
                    <span>HTML / Embed Source</span>
                    <span style="font-size:0.7rem; opacity:0.7;">Auto-Sanitized ‚Ä¢ Monospace</span>
                </div>
                <!-- Textarea for Coding -->
                <textarea id="htmlCodeInput" class="code-textarea" spellcheck="false"></textarea>
            </div>

            <div class="alert-box" style="background:#fffbeb; color:#9f1239; border:1px solid #fecdd3; padding:10px; border-radius:6px; font-size:0.8rem; margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                <i class="ph ph-warning-circle" style="font-size:1.2rem;"></i>
                Perhatian: Jangan menghapus tag dengan class 'layout-stage' atau 'layout-movable' agar fitur geser/zoom berfungsi optimal. (Gunakan &lt;div class="page-break"&gt;&lt;/div&gt; untuk break manual).
            </div>

            <div class="modal-actions">
                <button class="btn-preview-html" onclick="handlePreviewHtml()">üëÅ Preview</button>
                <button class="btn-save-html" onclick="handleSaveHtmlChange()">üíæ Simpan Perubahan</button>
                <button onclick="closeHtmlEditorModal()">Batal</button>
            </div>
       </div>
    </div>

    <!-- NEW MODAL: ORIENTASI HALAMAN (ADDITIVE) -->
    <div id="orientationModal" class="modal">
       <div class="modal-box">
           <h3><i class="ph ph-arrows-left-right" style="color:#854d0e"></i> Ubah Orientasi</h3>
           <p style="font-size:0.9rem; color:#64748b; margin-bottom:5px;">Pilih halaman dan orientasinya:</p>

           <select id="orientationPageSelect"></select>
           <select id="orientationModeSelect">
               <option value="portrait">Portrait (Tegak)</option>
               <option value="landscape">Landscape (Mendatar)</option>
           </select>

           <div class="modal-actions">
               <button onclick="confirmOrientationChange()" style="background:#eab308; color:white;">üíæ Simpan</button>
               <button onclick="closeOrientationModal()">Batal</button>
           </div>
       </div>
    </div>

    <!-- NEW MODAL: PAPER SIZE (ADDITIVE) -->
    <div id="paperSizeModal" class="modal">
       <div class="modal-box">
           <h3><i class="ph ph-ruler" style="color:#6b21a8"></i> Ubah Ukuran Kertas</h3>
           <p style="font-size:0.9rem; color:#64748b; margin-bottom:5px;">Pilih halaman dan ukuran kertas:</p>

           <select id="paperSizePageSelect"></select>
           <select id="paperSizePresetSelect" onchange="toggleCustomPaperInputs()">
               <option value="F4">F4 (215 x 330 mm)</option>
               <option value="A4">A4 (210 x 297 mm)</option>
               <option value="Letter">Letter (216 x 279 mm)</option>
               <option value="Legal">Legal (216 x 356 mm)</option>
               <option value="Custom">Custom Ukuran...</option>
           </select>
           
           <div id="customPaperInputs">
               <div style="flex:1;">
                   <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Lebar (mm)</label>
                   <input type="number" id="customPaperW" placeholder="210" value="210">
               </div>
               <div style="flex:1;">
                   <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Tinggi (mm)</label>
                   <input type="number" id="customPaperH" placeholder="297" value="297">
               </div>
           </div>

           <div class="modal-actions">
               <button onclick="confirmPaperSizeChange()" style="background:#9333ea; color:white;">üíæ Simpan</button>
               <button onclick="closePaperSizeModal()">Batal</button>
           </div>
       </div>
    </div>

    <!-- NEW MODAL: MARGIN HALAMAN (ADDITIVE) -->
    <div id="marginModal" class="modal">
       <div class="modal-box">
           <h3><i class="ph ph-bounding-box" style="color:#b91c1c"></i> Atur Margin Kertas</h3>
           <p style="font-size:0.9rem; color:#64748b; margin-bottom:15px;">Pilih halaman dan atur margin (mm):</p>

           <select id="marginPageSelect"></select>
           
           <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
               <div>
                   <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Atas (mm)</label>
                   <input type="number" id="marginTopInput" value="20" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1;">
               </div>
               <div>
                   <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Kanan (mm)</label>
                   <input type="number" id="marginRightInput" value="20" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1;">
               </div>
               <div>
                   <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Bawah (mm)</label>
                   <input type="number" id="marginBottomInput" value="20" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1;">
               </div>
               <div>
                   <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Kiri (mm)</label>
                   <input type="number" id="marginLeftInput" value="20" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1;">
               </div>
           </div>

           <div class="modal-actions">
               <button onclick="confirmMarginChange()" style="background:#dc2626; color:white;">üíæ Simpan</button>
               <button onclick="closeMarginModal()">Batal</button>
           </div>
       </div>
    </div>

    <!-- NEW MODAL: DUPLICATE MULTIPLE SYSTEM -->
    <div id="duplicateMultiModal" class="modal">
       <div class="modal-box" style="width: 500px; max-width: 90vw;">
           <h3><i class="ph ph-copy" style="color:#059669"></i> Duplicate Multiple Halaman</h3>
           <p style="font-size:0.9rem; color:#64748b; margin-bottom:5px;">Pilih halaman yang ingin diduplikasi sekaligus:</p>
           
           <div style="margin-bottom: 10px;">
               <button type="button" class="btn-reset" style="margin-top:0; padding:4px 8px; font-size:0.75rem;" onclick="selectAllDuplicate(true)">Pilih Semua</button>
               <button type="button" class="btn-reset" style="margin-top:0; padding:4px 8px; font-size:0.75rem;" onclick="selectAllDuplicate(false)">Batal Pilih</button>
           </div>

           <div id="duplicateCheckboxContainer" class="checkbox-grid"></div>

           <div class="modal-actions">
               <button onclick="confirmDuplicateMulti()" style="background:#10b981; color:white;">üìÑ Proses Duplicate</button>
               <button onclick="closeDuplicateMultiModal()">Batal</button>
           </div>
       </div>
    </div>

    <!-- MODAL EMBED HTML SYSTEM (EXISTING - PRESERVED) -->
    <div id="embedModal" class="modal">
       <div class="modal-box" style="width: 600px; max-width: 90vw;">
            <h3>Embed HTML Code</h3>
            <p style="font-size:0.9rem; color:#64748b; margin-bottom:15px;">
                Tempel kode HTML Anda di bawah. Script tag akan dihapus otomatis demi keamanan.
            </p>

            <textarea id="embedInput" style="width:100%; height:300px; padding:10px; border:1px solid #cbd5e1; border-radius:8px; font-family:monospace; font-size:12px; resize:vertical; outline:none;" placeholder="<!-- Paste your HTML here... -->&#10;<div>&#10;  <h1>Judul Dokumen</h1>&#10;  <p>Isi dokumen...</p>&#10;</div>"></textarea>

            <div class="modal-actions" style="margin-top: 20px;">
                <button onclick="handleConfirmEmbed()" style="background: #10b981; color: white;">‚úÖ Tambahkan Halaman</button>
                <button onclick="closeEmbedModal()">Batal</button>
            </div>
       </div>
    </div>

    <!-- NEW MODAL: FIND & REPLACE (ADDITIVE) -->
    <div id="findReplaceModal" class="find-modal no-print-in-pdf">
        <div class="find-box">
            <h3><i class="ph ph-magnifying-glass" style="color:#d97706"></i> Cari & Ganti Teks</h3>

            <input type="text" id="findInput" placeholder="Cari teks..." />
            <input type="text" id="replaceInput" placeholder="Ganti dengan..." />

            <div class="find-actions">
                <button onclick="executeFind()" style="background: #3b82f6; color: white;">Cari</button>
                <button onclick="findPrevious()" style="background: #3b82f6; color: white;">Sebelumnya</button>
                <button onclick="findNext()" style="background: #3b82f6; color: white;">Selanjutnya</button>
            </div>
            <div class="find-actions">
                <button onclick="replaceOne()">Ganti</button>
                <button onclick="replaceAll()">Ganti Semua</button>
                <button onclick="clearFindResults()">Clear</button>
                <button onclick="closeFindModal()">Tutup</button>
            </div>

            <div id="findCounter">0 hasil ditemukan</div>
        </div>
    </div>

    <!-- NEW MODAL: PAGE STYLE INSPECTOR (ADDITIVE) -->
    <div id="pageStyleModal" class="modal">
      <div class="modal-box">
        <h3><i class="ph ph-paint-brush" style="color:#15803d"></i> Pengaturan Gaya Halaman</h3>

        <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Pilih Halaman</label>
        <select id="pageStyleSelect" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; margin-bottom: 15px; outline:none;"></select>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
            <div>
                <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Font Family</label>
                <select id="pageFontSelect" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; outline:none;">
                  <option value="Times New Roman">Times New Roman</option>
                  <option value="Arial">Arial</option>
                  <option value="Calibri">Calibri</option>
                  <option value="Verdana">Verdana</option>
                  <option value="Tahoma">Tahoma</option>
                  <option value="Courier New">Courier New</option>
                </select>
            </div>
            <div>
                <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Ukuran Font (px)</label>
                <input type="number" id="pageFontSizeInput" value="16" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; outline:none;">
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <!-- Gunakan preventDefault agar saat diklik tidak menghilangkan fokus blok teks (Selection) -->
            <button onmousedown="event.preventDefault()" onclick="togglePageBold()" style="flex:1; padding:8px; border-radius:6px; border:1px solid #cbd5e1; background:#f8fafc; font-weight:bold; cursor:pointer;">B</button>
            <button onmousedown="event.preventDefault()" onclick="togglePageItalic()" style="flex:1; padding:8px; border-radius:6px; border:1px solid #cbd5e1; background:#f8fafc; font-style:italic; font-family:serif; cursor:pointer;">I</button>
            <button onmousedown="event.preventDefault()" onclick="togglePageUnderline()" style="flex:1; padding:8px; border-radius:6px; border:1px solid #cbd5e1; background:#f8fafc; text-decoration:underline; cursor:pointer;">U</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
            <div>
                <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Alignment</label>
                <select id="pageAlignSelect" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; outline:none;">
                  <option value="left">Left (Kiri)</option>
                  <option value="center">Center (Tengah)</option>
                  <option value="right">Right (Kanan)</option>
                  <option value="justify">Justify (Rata)</option>
                </select>
            </div>
            <div>
                <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Line Height</label>
                <input type="number" step="0.1" id="pageLineHeightInput" value="1.5" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; outline:none;">
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
            <div>
                <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Spasi Huruf (px)</label>
                <input type="number" id="pageLetterSpacingInput" value="0" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; outline:none;">
            </div>
            <div>
                <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Warna Teks</label>
                <input type="color" id="pageColorInput" value="#000000" style="width:100%; height:38px; padding:2px; border-radius:6px; border:1px solid #cbd5e1; cursor:pointer; outline:none;">
            </div>
        </div>

        <div class="section-divider" style="margin: 10px 0;">Upload Font Custom (Halaman)</div>
        <div style="margin-bottom: 20px;">
            <input type="file" id="pageFontUploader" accept=".ttf,.otf,.woff,.woff2" style="font-size: 0.8rem; width: 100%;">
        </div>

        <div class="modal-actions">
          <button onclick="applyPageStyle()" style="background:#15803d; color:white;">üíæ Terapkan</button>
          <button onclick="closePageStyleModal()">Tutup</button>
        </div>
      </div>
    </div>

    <!-- NEW MODAL: TEXT STYLE INSPECTOR (ADDITIVE) -->
    <div id="textStyleModal" class="modal no-print-in-pdf">
      <div class="modal-box">
        <h3><i class="ph ph-text-t" style="color:#1d4ed8"></i> Gaya Teks Terpilih</h3>
        <p style="font-size:0.8rem; color:#64748b; margin-bottom:15px;">Blok teks di dokumen, lalu atur gayanya di sini.</p>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
            <div>
                <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Font</label>
                <select id="textFontSelect" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; outline:none; margin:0;"></select>
            </div>
            <div>
                <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Ukuran (px)</label>
                <input type="number" id="textFontSizeInput" value="14" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; outline:none;">
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button onmousedown="event.preventDefault()" onclick="toggleTextStyleCmd('bold')" style="flex:1; padding:8px; border-radius:6px; border:1px solid #cbd5e1; background:#f8fafc; font-weight:bold; cursor:pointer;">B</button>
            <button onmousedown="event.preventDefault()" onclick="toggleTextStyleCmd('italic')" style="flex:1; padding:8px; border-radius:6px; border:1px solid #cbd5e1; background:#f8fafc; font-style:italic; font-family:serif; cursor:pointer;">I</button>
            <button onmousedown="event.preventDefault()" onclick="toggleTextStyleCmd('underline')" style="flex:1; padding:8px; border-radius:6px; border:1px solid #cbd5e1; background:#f8fafc; text-decoration:underline; cursor:pointer;">U</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
            <div>
                <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Alignment</label>
                <select id="textAlignSelect" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; outline:none;">
                  <option value="">(Default)</option>
                  <option value="left">Left (Kiri)</option>
                  <option value="center">Center (Tengah)</option>
                  <option value="right">Right (Kanan)</option>
                  <option value="justify">Justify (Rata)</option>
                </select>
            </div>
            <div>
                <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Line Height</label>
                <input type="number" step="0.1" id="textLineHeightInput" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; outline:none;" placeholder="(Default)">
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
            <div>
                <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Warna</label>
                <input type="color" id="textColorInput" style="width:100%; height:38px; padding:2px; border-radius:6px; border:1px solid #cbd5e1; cursor:pointer; outline:none;">
            </div>
            <div>
                <label style="font-size:0.8rem;color:#64748b;display:block;margin-bottom:4px;">Spasi Huruf (px)</label>
                <input type="number" id="textLetterSpacingInput" value="0" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; outline:none;">
            </div>
        </div>

        <div class="section-divider" style="margin: 10px 0;">Upload Font Custom</div>
        <div style="margin-bottom: 20px;">
            <input type="file" id="fontUploader" accept=".ttf,.otf,.woff,.woff2" style="font-size: 0.8rem; width: 100%;">
        </div>

        <div class="modal-actions">
          <button onclick="applyTextStyle()" style="background:#1d4ed8; color:white;">üíæ Terapkan ke Teks</button>
          <button onclick="closeTextStyleModal()">Tutup</button>
        </div>
      </div>
    </div>

    <!-- =========================================
       9. NEW GLOBAL UI OVERLAYS (INJECTED)
       ========================================= -->
    
    <!-- 1. Loading Overlay -->
    <div id="uxLoader" class="ux-loader-overlay">
        <div class="ux-spinner"></div>
        <div class="ux-loader-text" id="uxLoaderText">Memproses data...</div>
    </div>

    <!-- 2. Toast Container -->
    <div id="uxToastContainer" class="ux-toast-container"></div>

    <!-- 3. Modern Confirmation Modal -->
    <div id="uxConfirmModal" class="ux-confirm-modal">
        <div class="ux-confirm-box">
            <div class="ux-confirm-icon">
                <i class="ph ph-warning"></i>
            </div>
            <h3 class="ux-confirm-title" id="uxConfirmTitle">Konfirmasi</h3>
            <p class="ux-confirm-desc" id="uxConfirmDesc">Apakah Anda yakin ingin melakukan tindakan ini?</p>
            <div class="ux-confirm-actions">
                <button class="ux-btn ux-btn-cancel" id="uxBtnCancel">Batal</button>
                <button class="ux-btn ux-btn-confirm" id="uxBtnConfirm">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>

    <!-- 4. Save Indicator -->
    <div id="uxSaveIndicator" class="ux-save-indicator">
        <div class="ux-save-spinner"></div>
        <span>Menyimpan...</span>
    </div>

    <script>
        // ================= GLOBAL STATE MANAGEMENT =================
        let pagesDB = [];
        const STORAGE_KEY = "school_pages_db";
        let isImportingZip = false; // FLAG PENTING: Mencegah auto-paginate memecah halaman saat import
        let isStrictRestore = false; // FLAG PENTING: Mencegah modifikasi struktur DOM saat import

        /* =========================================
           UNDO / REDO HISTORY ENGINE (ADDITIVE)
           ========================================= */
        let historyStack = [];
        let redoStack = [];
        let isRestoringHistory = false;
        const MAX_HISTORY = 50;

        function pushHistoryState() {
            if (isRestoringHistory) return;
            if (typeof isAutoFlowing !== 'undefined' && isAutoFlowing) return; // Hindari konflik auto flow

            const snapshot = JSON.stringify(pagesDB);

            // Hindari duplikasi state yang sama berturut-turut
            if (historyStack.length > 0 && historyStack[historyStack.length - 1] === snapshot) {
                return;
            }

            historyStack.push(snapshot);

            // Batasi jumlah history agar memori browser tidak berat
            if (historyStack.length > MAX_HISTORY) {
                historyStack.shift();
            }

            // Reset redo stack jika ada perubahan state baru yang ter-push
            redoStack = [];
        }

        function handleUndo() {
            if (historyStack.length <= 1) {
                uxToast("Tidak ada perubahan untuk di-Undo", "info");
                return;
            }

            isRestoringHistory = true;

            // Ambil state terakhir saat ini dan simpan ke redo stack
            const currentState = historyStack.pop();
            redoStack.push(currentState);

            // Terapkan state sebelumnya sebagai state aktif
            const previousState = historyStack[historyStack.length - 1];
            pagesDB = JSON.parse(previousState);

            localStorage.setItem(STORAGE_KEY, previousState);
            renderPages();

            uxToast("Undo berhasil", "success");

            // Beri sedikit jeda waktu sebelum user bisa undo lagi untuk stabilitas DOM
            setTimeout(() => {
                isRestoringHistory = false;
            }, 100);
        }

        function handleRedo() {
            if (redoStack.length === 0) {
                uxToast("Tidak ada perubahan untuk di-Redo", "info");
                return;
            }

            isRestoringHistory = true;

            // Ambil state dari redo stack dan kembalikan ke history stack
            const nextState = redoStack.pop();
            historyStack.push(nextState);

            pagesDB = JSON.parse(nextState);

            localStorage.setItem(STORAGE_KEY, nextState);
            renderPages();

            uxToast("Redo berhasil", "success");

            setTimeout(() => {
                isRestoringHistory = false;
            }, 100);
        }

        // ================= STORAGE HELPER FUNCTIONS (HARDENED) =================
        function saveToStorage() {
            // Kita harus mensinkronkan DOM saat ini kembali ke pagesDB
            // karena user mungkin telah mengedit halaman Standard.
            
            const sheets = document.querySelectorAll('.sheet');
            
            // Rebuild DB from Current DOM State
            pagesDB = Array.from(sheets).map((sheet, index) => {
                const isEmbed = sheet.dataset.pageType === 'embed';
                const pageId = parseInt(sheet.dataset.id) || (Date.now() + index);

                // Ekstrak Data-X, Data-Y, dan Data-Scale untuk disimpan (Bahkan dari Embed)
                const movable = sheet.querySelector('.layout-movable');
                const lx = movable ? (parseFloat(movable.getAttribute('data-x')) || 0) : 0;
                const ly = movable ? (parseFloat(movable.getAttribute('data-y')) || 0) : 0;
                const ls = movable ? (parseFloat(movable.getAttribute('data-scale')) || 1) : 1;

                // Ekstrak nilai Orientasi secara persisten
                const isLandscape = sheet.classList.contains('landscape');
                const isPortrait = sheet.classList.contains('portrait');
                let orientationStr = isLandscape ? 'landscape' : (isPortrait ? 'portrait' : 'portrait');

                // ADDITIVE: Ekstrak nilai Paper Size secara persisten dari DOM ke JSON
                const paperPreset = sheet.getAttribute('data-paper-preset') || 'F4';
                const paperW = parseFloat(sheet.getAttribute('data-paper-width')) || 215;
                const paperH = parseFloat(sheet.getAttribute('data-paper-height')) || 330;
                const paperSize = { preset: paperPreset, width: paperW, height: paperH };

                // ADDITIVE: Ekstrak nilai Margin secara persisten dari DOM ke JSON
                const marginT = parseFloat(sheet.getAttribute('data-margin-top')) || 20;
                const marginR = parseFloat(sheet.getAttribute('data-margin-right')) || 20;
                const marginB = parseFloat(sheet.getAttribute('data-margin-bottom')) || 20;
                const marginL = parseFloat(sheet.getAttribute('data-margin-left')) || 20;
                const marginObj = { top: marginT, right: marginR, bottom: marginB, left: marginL };

                // ADDITIVE: Ekstrak nilai Page Style persisten
                const pageStyleObj = {
                    font: sheet.getAttribute('data-style-font') || '',
                    size: sheet.getAttribute('data-style-size') || '',
                    align: sheet.getAttribute('data-style-align') || '',
                    lineHeight: sheet.getAttribute('data-style-lineheight') || '',
                    letterSpacing: sheet.getAttribute('data-style-letterspacing') || '',
                    color: sheet.getAttribute('data-style-color') || ''
                };

                if (isEmbed) {
                    // UNTUK EMBED: JANGAN ambil innerHTML (karena itu hasil render)
                    // Ambil dari hidden textarea yang kita tanam saat renderPages()
                    const rawStorage = sheet.querySelector('.raw-storage');
                    return {
                        id: pageId,
                        type: 'embed',
                        rawHTML: rawStorage ? rawStorage.value : '', // Source of Truth
                        layoutX: lx,
                        layoutY: ly,
                        layoutScale: ls,
                        orientation: orientationStr,
                        paperSize: paperSize, // Additive injection
                        margin: marginObj, // Additive injection
                        pageStyle: pageStyleObj // Additive injection
                    };
                } else {
                    // UNTUK STANDARD: Ambil innerHTML karena user mengedit langsung di DOM
                    return {
                        id: pageId,
                        type: 'standard', // atau undefined (legacy support)
                        html: sheet.innerHTML,
                        layoutX: lx,
                        layoutY: ly,
                        layoutScale: ls,
                        orientation: orientationStr,
                        paperSize: paperSize, // Additive injection
                        margin: marginObj, // Additive injection
                        pageStyle: pageStyleObj // Additive injection
                    };
                }
            });
            
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(pagesDB));
                
                // ADDITIVE: Simpan history state setiap kali penyimpanan berhasil di trigger
                pushHistoryState();
            } catch (e) {
                console.error("Storage Full or Error", e);
            }
        }

        function loadFromStorage() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                try {
                    pagesDB = JSON.parse(data);
                    return true;
                } catch (e) {
                    console.error("Storage corrupt", e);
                    localStorage.removeItem(STORAGE_KEY);
                    return false;
                }
            }
            return false;
        }

        function resetAllPages() {
            if(confirm("Yakin ingin mereset semua halaman dan menghapus penyimpanan?")) {
                localStorage.removeItem(STORAGE_KEY);
                pagesDB = [];
                location.reload(); 
            }
        }

        // ================= RENDER ENGINE (UPDATED) =================
        function renderPages() {
            const container = document.getElementById('document-area');
            container.innerHTML = ''; // Reset container

            pagesDB.forEach((page, pageIndex) => {
                const sheet = document.createElement('div');
                sheet.className = 'sheet';
                sheet.dataset.id = page.id || Date.now(); // Maintain Identity

                // A. RENDER LOGIC BASED ON TYPE
                if (page.type === 'embed') {
                    // --- EMBED RENDERING ---
                    sheet.dataset.pageType = 'embed';

                    // 1. Simpan Raw HTML di Hidden Textarea (Untuk Save System nanti)
                    const rawStorage = document.createElement('textarea');
                    rawStorage.className = 'raw-storage';
                    rawStorage.style.display = 'none';
                    rawStorage.value = page.rawHTML;
                    sheet.appendChild(rawStorage);

                    // 2. Buat Safe Container
                    const wrapper = document.createElement('div');
                    wrapper.className = 'embed-safe-zone';
                    
                    try {
                        // 3. Inject HTML Only at Render Time
                        wrapper.innerHTML = page.rawHTML;
                        sheet.appendChild(wrapper);
                    } catch (e) {
                        wrapper.innerHTML = '<p style="color:red; text-align:center;">Gagal merender HTML Embed.</p>';
                        sheet.appendChild(wrapper);
                    }

                } else {
                    // --- STANDARD RENDERING ---
                    // Inject langsung innerHTML (Contenteditable support)
                    // (Ini sudah mengembalikan elemen stage dan movable yang tersimpan dari JSON)
                    sheet.innerHTML = page.html;
                }

                // Cek penanda landscape dari dalam template (fallback lama)
                if (sheet.querySelector('.landscape-marker')) {
                    sheet.classList.add('landscape');
                }

                // NEW ADDITION: Restore Orientasi secara eksplisit dari atribut JSON
                if (page.orientation === 'landscape') {
                    sheet.classList.add('landscape');
                    sheet.classList.remove('portrait');
                } else if (page.orientation === 'portrait') {
                    sheet.classList.add('portrait');
                    sheet.classList.remove('landscape');
                }

                // ADDITIVE: PAPER SIZE OVERRIDE
                if (!page.paperSize) {
                    page.paperSize = { preset: "F4", width: 215, height: 330 };
                }
                sheet.setAttribute('data-paper-preset', page.paperSize.preset);
                sheet.setAttribute('data-paper-width', page.paperSize.width);
                sheet.setAttribute('data-paper-height', page.paperSize.height);

                let w = page.paperSize.width;
                let h = page.paperSize.height;

                // Jika landscape aktif ‚Üí swap, gunakan !important agar menimpa css style asli
                if (sheet.classList.contains('landscape')) {
                    sheet.style.setProperty('width', h + "mm", 'important');
                    sheet.style.setProperty('min-height', w + "mm", 'important');
                } else {
                    sheet.style.setProperty('width', w + "mm", 'important');
                    sheet.style.setProperty('min-height', h + "mm", 'important');
                }

                // Visual Badge untuk Info Ukuran Kertas
                if (!sheet.querySelector('.paper-size-badge')) {
                    const badge = document.createElement('div');
                    badge.className = "paper-size-badge no-print-in-pdf";
                    badge.innerText = `${page.paperSize.preset} (${w}√ó${h}mm)`;
                    sheet.appendChild(badge);
                } else {
                    sheet.querySelector('.paper-size-badge').innerText = `${page.paperSize.preset} (${w}√ó${h}mm)`;
                }

                // --- ADDITIVE: MARGIN OVERRIDE SECARA INLINE ---
                if (!page.margin) {
                    page.margin = { top: 20, right: 20, bottom: 20, left: 20 };
                }
                
                sheet.setAttribute('data-margin-top', page.margin.top);
                sheet.setAttribute('data-margin-right', page.margin.right);
                sheet.setAttribute('data-margin-bottom', page.margin.bottom);
                sheet.setAttribute('data-margin-left', page.margin.left);

                sheet.style.setProperty('padding-top', page.margin.top + "mm", 'important');
                sheet.style.setProperty('padding-right', page.margin.right + "mm", 'important');
                sheet.style.setProperty('padding-bottom', page.margin.bottom + "mm", 'important');
                sheet.style.setProperty('padding-left', page.margin.left + "mm", 'important');

                // Custom property untuk menyesuaikan visual guide margin
                sheet.style.setProperty('--m-top', page.margin.top + "mm");
                sheet.style.setProperty('--m-right', page.margin.right + "mm");
                sheet.style.setProperty('--m-bottom', page.margin.bottom + "mm");
                sheet.style.setProperty('--m-left', page.margin.left + "mm");

                // --- ADDITIVE: PAGE STYLE OVERRIDE ---
                if (page.pageStyle) {
                    sheet.setAttribute('data-style-font', page.pageStyle.font || '');
                    sheet.setAttribute('data-style-size', page.pageStyle.size || '');
                    sheet.setAttribute('data-style-align', page.pageStyle.align || '');
                    sheet.setAttribute('data-style-lineheight', page.pageStyle.lineHeight || '');
                    sheet.setAttribute('data-style-letterspacing', page.pageStyle.letterSpacing || '');
                    sheet.setAttribute('data-style-color', page.pageStyle.color || '');

                    // Terapkan paksa style dominan ke konten
                    const contentArea = sheet.querySelector('.page-content');
                    if (contentArea) {
                        if(page.pageStyle.font) contentArea.style.fontFamily = page.pageStyle.font;
                        if(page.pageStyle.size) contentArea.style.fontSize = page.pageStyle.size + "px";
                        if(page.pageStyle.align) contentArea.style.textAlign = page.pageStyle.align;
                        if(page.pageStyle.lineHeight) contentArea.style.lineHeight = page.pageStyle.lineHeight;
                        if(page.pageStyle.letterSpacing) contentArea.style.letterSpacing = page.pageStyle.letterSpacing + "px";
                        if(page.pageStyle.color) contentArea.style.color = page.pageStyle.color;
                    }
                }

                // --- NEW ADDITION: ENFORCE LAYOUT STRUCTURE SECARA ADDITIVE ---
                if (!isStrictRestore) { // ONLY RESTRUCTURE IF NOT IMPORTING STRICTLY
                    let stage = sheet.querySelector('.layout-stage');
                    if (!stage) {
                        stage = document.createElement('div');
                        stage.className = 'layout-stage';
                        const movable = document.createElement('div');
                        movable.className = 'layout-movable';
                        
                        // Kita memindahkan anak DOM lama yang bukan elemen sistem operasi aplikasi (page number, marker)
                        const systemClasses = ['page-number', 'edit-badge', 'raw-storage', 'landscape-marker', 'zoom-controls', 'zoom-indicator', 'duplicate-controls'];
                        const childrenToMove = [];
                        Array.from(sheet.children).forEach(child => {
                            if (child.tagName !== 'TEXTAREA' || !child.classList.contains('raw-storage')) {
                               if (!systemClasses.some(cls => child.classList.contains(cls))) {
                                   childrenToMove.push(child);
                               }
                            }
                        });
                        childrenToMove.forEach(c => movable.appendChild(c));
                        stage.appendChild(movable);
                        
                        const marker = sheet.querySelector('.landscape-marker');
                        if (marker) marker.after(stage);
                        else sheet.insertBefore(stage, sheet.firstChild);
                    }
                }

                // Restore posisi Layout Drag & Drop + Zoom (utamakan memori page, fallback attribut DOM lama)
                const movable = sheet.querySelector('.layout-movable');
                if (movable) {
                    const lx = page.layoutX !== undefined ? page.layoutX : (parseFloat(movable.getAttribute('data-x')) || 0);
                    const ly = page.layoutY !== undefined ? page.layoutY : (parseFloat(movable.getAttribute('data-y')) || 0);
                    const ls = page.layoutScale !== undefined ? page.layoutScale : (parseFloat(movable.getAttribute('data-scale')) || 1);
                    
                    movable.setAttribute('data-x', lx);
                    movable.setAttribute('data-y', ly);
                    movable.setAttribute('data-scale', ls);
                    movable.style.transform = `translate(${lx}px, ${ly}px) scale(${ls})`;
                }

                // B. SYSTEM COMPONENTS (Jika belum ada)
                // Cek apakah page number sudah ada
                if (!sheet.querySelector('.page-number')) {
                    const pageNum = document.createElement('div');
                    pageNum.className = 'page-number';
                    sheet.appendChild(pageNum);
                }

                // --- PERBAIKAN: Bersihkan zoom controls lama jika tidak memiliki class zoom-value ---
                const existingZoomCtrl = sheet.querySelector('.zoom-controls');
                if (existingZoomCtrl && !existingZoomCtrl.querySelector('.zoom-value')) {
                    existingZoomCtrl.remove();
                }

                // --- ADDITIVE: Injeksi UI Zoom Controls jika belum ada ---
                if (!sheet.querySelector('.zoom-controls')) {
                    const zoomCtrl = document.createElement('div');
                    zoomCtrl.className = 'zoom-controls no-print-in-pdf';
                    zoomCtrl.innerHTML = `
                        <button class="zoom-btn zoom-out-btn" onclick="handleZoomClick(this, 'out')" title="Zoom Out">‚ûñ</button>
                        <button class="zoom-btn zoom-value" onclick="handleZoomClick(this, 'reset')" title="Reset 100%">100%</button>
                        <button class="zoom-btn zoom-in-btn" onclick="handleZoomClick(this, 'in')" title="Zoom In">‚ûï</button>
                    `;
                    sheet.appendChild(zoomCtrl);
                }

                // --- SINKRONISASI UI ZOOM CONTROLS ---
                const activeMovable = sheet.querySelector('.layout-movable');
                if (activeMovable) {
                    const ls = parseFloat(activeMovable.getAttribute('data-scale')) || 1;
                    const percent = Math.round(ls * 100);
                    const zoomValueBtn = sheet.querySelector('.zoom-value');
                    const outBtn = sheet.querySelector('.zoom-out-btn');
                    const inBtn = sheet.querySelector('.zoom-in-btn');

                    if (zoomValueBtn) {
                        zoomValueBtn.innerText = percent + '%';
                        zoomValueBtn.title = `Reset (Aktual: ${percent}%)`;
                    }
                    if (outBtn) outBtn.disabled = ls <= 0.5;
                    if (inBtn) inBtn.disabled = ls >= 2.0;
                }

                // --- ADDITIVE: Injeksi Indikator Zoom ---
                if (!sheet.querySelector('.zoom-indicator')) {
                    const zoomInd = document.createElement('div');
                    zoomInd.className = 'zoom-indicator';
                    sheet.appendChild(zoomInd);
                }

                // --- ADDITIVE: Injeksi Duplicate Controls ---
                if (!sheet.querySelector('.duplicate-controls')) {
                    const dupCtrl = document.createElement('div');
                    dupCtrl.className = 'duplicate-controls no-print-in-pdf';
                    
                    dupCtrl.innerHTML = `
                        <button class="duplicate-btn-sheet" onclick="handleDuplicateSingle(${pageIndex})" title="Duplicate Halaman Ini (Ctrl+D)">
                            <i class="ph ph-copy"></i> Duplicate
                        </button>
                    `;
                    sheet.appendChild(dupCtrl);
                } else {
                    // Pastikan index update jika ada halaman yang dihapus/ditambah
                    const dupCtrlBtn = sheet.querySelector('.duplicate-btn-sheet');
                    if (dupCtrlBtn) {
                        dupCtrlBtn.setAttribute('onclick', `handleDuplicateSingle(${pageIndex})`);
                    }
                }

                container.appendChild(sheet);
            });

            updatePageNumbers();
        }

        // ================= AUTO SAVE ENGINE (DEBOUNCE) =================
        let saveTimeout;
        let flowDebounce; // New debounce specifically for Auto Flow

        document.addEventListener("input", function(e) {
            // Hanya trigger jika perubahan terjadi di dalam .sheet atau input/textarea
            if(e.target.closest('.sheet') || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                
                // DEPRECATED: Old naive autoPaginateCustomPages() is replaced by Advanced Auto Flow Engine
                // We use debouncedAutoFlow() instead to prevent layout thrashing on every keystroke
                if (e.target.closest('.page-content')) {
                    clearTimeout(flowDebounce);
                    flowDebounce = setTimeout(() => {
                        debouncedAutoFlow();
                    }, 1200); // 1.2s debounce to avoid lag while typing fast
                }

                // Standard Auto Save
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    saveToStorage();
                }, 500); 
            }
        });

        // ================= NEW EMBED ARCHITECTURE (NO IFRAME) =================

        // 1. SANITIZER: Membersihkan Script Berbahaya
        function cleanHTML(htmlString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');

            // Hapus tag berbahaya yang tidak boleh ada di dokumen cetak
            const bannedTags = ['script', 'iframe', 'object', 'embed', 'form']; 
            bannedTags.forEach(tag => {
                doc.querySelectorAll(tag).forEach(el => el.remove());
            });

            // Hapus event handler inline (onclick, onmouseover, dll)
            const allElements = doc.body.querySelectorAll('*');
            allElements.forEach(el => {
                Array.from(el.attributes).forEach(attr => {
                    if (attr.name.startsWith('on')) {
                        el.removeAttribute(attr.name);
                    }
                });
            });

            return doc.body.innerHTML;
        }

        // 2. CORE: ADD EMBED PAGE
        function addEmbedPage(userHTML) {
            if (!userHTML || userHTML.trim() === '') {
                alert("Kode HTML tidak boleh kosong.");
                return;
            }

            try {
                // Step A: Sanitize
                const safeContent = cleanHTML(userHTML);

                // Step B: Create Page Object
                const newPage = {
                    id: Date.now() + "_" + Math.random().toString(36).substr(2, 5),
                    type: 'embed',
                    rawHTML: safeContent // Simpan Source Asli
                };

                // Step C: Update DB & Save
                pagesDB.push(newPage);
                
                // Force Update Storage (Single Source of Truth Logic)
                // Kita update DB dulu, baru save, baru render.
                localStorage.setItem(STORAGE_KEY, JSON.stringify(pagesDB));

                // Step D: Render UI
                renderPages();

                // Step E: UX
                setTimeout(() => {
                    const newSheet = document.getElementById('document-area').lastElementChild;
                    if(newSheet) {
                        newSheet.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);

                if (window.innerWidth <= 1024) {
                    sidebar.classList.remove('active');
                }

            } catch (err) {
                console.error(err);
                alert("Gagal membuat halaman embed. Periksa kode HTML Anda.");
            }
        }

        // Embed Modal Handlers
        function openEmbedModal() {
            document.getElementById('embedInput').value = ''; 
            document.getElementById('embedModal').style.display = 'flex';
            setTimeout(() => document.getElementById('embedInput').focus(), 100);
        }

        function closeEmbedModal() {
            document.getElementById('embedModal').style.display = 'none';
        }

        function confirmEmbed() {
            const code = document.getElementById('embedInput').value;
            
            if(!code || code.trim().length < 5) {
                alert("Kode HTML terlalu pendek.");
                return;
            }
            
            addEmbedPage(code);
            closeEmbedModal();
        }

        // ================= MODIFIED SYSTEM CORE =================

        function openDeleteModal(){
            const sheets = document.querySelectorAll('.sheet');
            if(sheets.length === 0){
                uxToast("Tidak ada halaman untuk dihapus.", "error");
                return;
            }
            refreshDeleteDropdown();
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function closeDeleteModal(){
            document.getElementById('deleteModal').style.display = 'none';
        }

        function refreshDeleteDropdown(){
            const dropdown = document.getElementById('deletePageSelect');
            if(!dropdown) return;

            dropdown.innerHTML = '';

            document.querySelectorAll('.sheet').forEach((sheet, i)=>{
                const option = document.createElement('option');
                option.value = i;
                
                let title = "Halaman " + (i+1);
                const content = sheet.textContent || sheet.innerText;
                
                if(content.includes('CUSTOM PAGE')) title += " (Custom)";
                
                option.textContent = title;
                dropdown.appendChild(option);
            });
        }

        function confirmDelete(){
            const index = document.getElementById('deletePageSelect').value;
            deletePageByIndex(parseInt(index));
            closeDeleteModal();
        }

        function deletePageByIndex(index){
            const sheets = document.querySelectorAll('.sheet');

            if(index < 0 || index >= sheets.length){
                return; 
            }

            const sheet = sheets[index];

            sheet.style.transition = "all .25s ease";
            sheet.style.opacity = "0";
            sheet.style.transform = "scale(.9)";

            setTimeout(()=>{
                sheet.remove();
                saveToStorage();
                updatePageNumbers(); 
            },250);
        }

        // ================= PDF ENGINE (UPGRADED PRINT SHOP QUALITY) =================
        async function safePrint(){
            const { jsPDF } = window.jspdf;
            const sheets = document.querySelectorAll('.sheet');

            if(!sheets.length){
                alert('Tidak ada halaman untuk didownload!');
                return;
            }

            // Jalankan Smart Layout Engine sesaat sebelum Print agar sempurna
            if(!isAutoFlowing) await triggerAutoFlowEngine(true);

            // Persiapan DOM sebelum dirender html2canvas
            document.body.classList.add('exporting');
            // Matikan Margin Guides khusus saat print
            document.body.classList.remove('show-margin-guides');
            void document.body.offsetHeight; // force reflow

            try {
                const firstIsLandscape = sheets[0].classList.contains('landscape');
                
                // ADDITIVE: Ambil paper size dari halaman pertama untuk set awal PDF
                const firstPage = pagesDB[0] || {};
                const fw = firstPage.paperSize?.width || 215;
                const fh = firstPage.paperSize?.height || 330;
                
                // PENGATURAN WAJIB 2: PDF Kualitas Maksimal
                const pdf = new jsPDF({
                    orientation: firstIsLandscape ? 'landscape' : 'portrait',
                    unit: 'mm',
                    format: firstIsLandscape ? [fh, fw] : [fw, fh],
                    compress: false, // compress: false sesuai instruksi agar tidak ada loss
                    precision: 16  // precision 16 untuk layouting mm ke px yang sangat presisi
                });

                for(let i=0; i<sheets.length; i++){
                    const sheet = sheets[i];
                    const isLandscape = sheet.classList.contains('landscape');
                    
                    // PENGATURAN WAJIB 1, 4 & 6: Resolusi Tinggi
                    const canvas = await html2canvas(sheet, {
                        scale: 4, // Level Print Shop (approx 384 DPI for F4)
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: "#ffffff", // Menghindari transparansi blur
                        logging: false,
                        onclone: (clonedDoc) => {
                            // PENGATURAN WAJIB 5 & 8: Pastikan presisi canvas saat diclone
                            const clonedSheets = clonedDoc.querySelectorAll('.sheet');
                            clonedSheets.forEach(s => {
                                s.style.transform = "none";
                                s.style.boxShadow = "none";
                                s.style.margin = "0";
                            });
                        }
                    });

                    // PENGATURAN WAJIB 3: Format PNG untuk ketajaman vektor teks/tabel
                    const imgData = canvas.toDataURL('image/png', 1.0);

                    // ADDITIVE: Ambil paper size spesifik halaman ini (PDF Dinamis)
                    const pageData = pagesDB[i];
                    let pWidth = pageData?.paperSize?.width || 215;
                    let pHeight = pageData?.paperSize?.height || 330;

                    if(i !== 0){
                        pdf.addPage(isLandscape ? [pHeight, pWidth] : [pWidth, pHeight], isLandscape ? 'landscape' : 'portrait');
                    }

                    // Tambahkan ke PDF sesuai ukuran dinamis
                    if (isLandscape) {
                        pdf.addImage(imgData, 'PNG', 0, 0, pHeight, pWidth, undefined, 'FAST');
                    } else {
                        pdf.addImage(imgData, 'PNG', 0, 0, pWidth, pHeight, undefined, 'FAST');
                    }
                }

                pdf.save('Laporan-Sekolah-Premium.pdf');

            } catch (error) {
                console.error("PDF Generation Error:", error);
                alert("Gagal membuat PDF. Coba refresh halaman.");
            } finally {
                document.body.classList.remove('exporting');
            }
        }

        // ================= UI LOGIC =================
        
        const menuToggle = document.querySelector('.menu-toggle');
        const sidebar = document.querySelector('aside');
        
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 1024) {
                if (!sidebar.contains(e.target) && !menuToggle.contains(e.target) && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                }
            }
        });

        // ================= DATA LOGIC =================

        function addPage(type) {
            const htmlContent = templates[type];
            if (!htmlContent) return;

            const newPage = {
                id: Date.now() + "_" + Math.random().toString(36).substr(2, 5),
                type: 'standard',
                html: htmlContent
            };

            pagesDB.push(newPage);
            renderPages();
            saveToStorage();
            
            const newSheet = document.getElementById('document-area').lastElementChild;
            if(newSheet) {
                newSheet.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            if (window.innerWidth <= 1024) {
                sidebar.classList.remove('active');
            }
        }

        function updatePageNumbers() {
            const pages = document.querySelectorAll('.page-number');
            pages.forEach((el, index) => {
                el.innerText = `- ${index + 1} -`;
            });
        }

        function triggerUpload(el) { el.querySelector('input').click(); }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const container = input.parentElement;
                    const img = container.querySelector('img');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    saveToStorage();
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ================= PREMIUM EDIT ENGINE =================

        function toggleEditMode(sheet) {
            document.querySelectorAll('.sheet').forEach(s => {
                if (s !== sheet) deactivateEditMode(s);
            });

            if (sheet.classList.contains('editing')) {
                deactivateEditMode(sheet);
            } else {
                activateEditMode(sheet);
            }
        }

        function activateEditMode(sheet) {
            sheet.classList.add('editing');
            const badge = document.createElement('div');
            badge.className = 'edit-badge';
            badge.innerText = '‚úèÔ∏è EDITING MODE';
            sheet.appendChild(badge);

            const textElements = sheet.querySelectorAll('p, span, td, th, div, h1, h2, h3, h4, h5, h6, li, u, b, strong, em');
            
            textElements.forEach(el => {
                if (
                    el.closest('.sheet-controls') || 
                    el.closest('.page-number') || 
                    el.closest('.photo-placeholder') ||
                    el.classList.contains('edit-badge') ||
                    el.tagName === 'INPUT' || 
                    el.tagName === 'TEXTAREA' || 
                    el.tagName === 'SELECT' ||
                    el.contentEditable === 'true' 
                ) {
                    return;
                }

                if(el.children.length === 0 || el.tagName === 'DIV' || el.tagName === 'TD'){
                     el.setAttribute('contenteditable', 'true');
                }
            });
        }

        function deactivateEditMode(sheet) {
            sheet.classList.remove('editing');
            const badge = sheet.querySelector('.edit-badge');
            if(badge) badge.remove();

            const editableElements = sheet.querySelectorAll('[contenteditable="true"]');
            editableElements.forEach(el => {
                if(['P','H1','H2','H3','H4','H5','H6','SPAN','LI','DIV'].includes(el.tagName)){
                     el.removeAttribute('contenteditable');
                }
            });
            saveToStorage();
        }

        function openEditModal() {
            const sheets = document.querySelectorAll('.sheet');
            if(sheets.length === 0) {
                uxToast("Belum ada halaman untuk diedit.", "error");
                return;
            }
            
            const dropdown = document.getElementById('editPageSelect');
            dropdown.innerHTML = '';

            sheets.forEach((sheet, i) => {
                const option = document.createElement('option');
                option.value = i;
                
                let title = "Halaman " + (i+1);
                const content = sheet.textContent || sheet.innerText;
                if(content.includes('CUSTOM PAGE')) title += " (Custom)";
                
                option.textContent = title;
                dropdown.appendChild(option);
            });

            document.getElementById('editModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function confirmEditMode() {
            const index = document.getElementById('editPageSelect').value;
            const sheets = document.querySelectorAll('.sheet');
            
            if(sheets[index]) {
                toggleEditMode(sheets[index]);
                sheets[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            closeEditModal();
        }

        document.addEventListener('dblclick', function(e) {
            // Cek pencegah edit jika sedang berada dalam mode geser layout
            if (document.body.classList.contains('layout-drag-mode')) return;

            const sheet = e.target.closest('.sheet');
            if (sheet && 
                !e.target.closest('.sheet-controls') && 
                !e.target.closest('.zoom-controls') &&
                !e.target.closest('.duplicate-controls') &&
                e.target.tagName !== 'INPUT' && 
                e.target.tagName !== 'TEXTAREA') {
                toggleEditMode(sheet);
            }
        });

        // ================= TEMPLATES =================

        const templates = {
            // Struktur Template Custom baru dengan sistem layouting terintegrasi!
            custom: `
                <div class="layout-stage">
                    <div class="layout-movable" data-x="0" data-y="0" data-scale="1" style="transform: translate(0px, 0px) scale(1);">
                        <div style="min-height: 100%; display: flex; flex-direction: column;">
                            <div class="text-center text-bold" style="margin-bottom: 20px; font-size: 14pt;">CUSTOM PAGE</div>
                            <div class="page-content" contenteditable="true" style="flex: 1; outline: none; padding: 10px;">
                                <p>Silakan ketik atau tempel konten Anda di sini...</p>
                                <p>&nbsp;</p>
                                <p>&nbsp;</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="page-number"></div>
            `
        };

        // Init Default Page
        window.onload = function() {
            if (!loadFromStorage()) {
                addPage('custom');
            } else {
                renderPages();
            }
            // ADDITIVE: Simpan inisialisasi awal ke history
            pushHistoryState();
        }

    </script>
    
    <!-- =========================================
       10. NEW UX LOGIC (NON-DESTRUCTIVE)
       ========================================= -->
    <script id="ux-logic">
        // --- UX HELPER FUNCTIONS ---

        function uxToast(message, type = 'success') {
            const container = document.getElementById('uxToastContainer');
            const toast = document.createElement('div');
            
            // Icon Logic
            let iconClass = 'ph-check-circle';
            if(type === 'error') iconClass = 'ph-warning-circle';
            if(type === 'warning') iconClass = 'ph-warning';
            if(type === 'info') iconClass = 'ph-info';

            toast.className = `ux-toast ${type}`;
            toast.innerHTML = `
                <i class="ph ${iconClass}"></i>
                <span>${message}</span>
            `;

            container.appendChild(toast);
            
            // Trigger Animation
            requestAnimationFrame(() => toast.classList.add('visible'));

            // Remove after 3s
            setTimeout(() => {
                toast.classList.remove('visible');
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        function uxShowLoader(text = "Memproses...") {
            const loader = document.getElementById('uxLoader');
            document.getElementById('uxLoaderText').innerText = text;
            loader.classList.add('active');
        }

        function uxHideLoader() {
            const loader = document.getElementById('uxLoader');
            loader.classList.remove('active');
        }

        function uxBtnLoad(btn, start = true) {
            if(!btn) return;
            if (start) {
                btn.classList.add('ux-btn-loading');
                btn.dataset.originalText = btn.innerText;
            } else {
                btn.classList.remove('ux-btn-loading');
            }
        }

        function uxConfirm(title, desc) {
            return new Promise((resolve) => {
                const modal = document.getElementById('uxConfirmModal');
                const titleEl = document.getElementById('uxConfirmTitle');
                const descEl = document.getElementById('uxConfirmDesc');
                const btnConfirm = document.getElementById('uxBtnConfirm');
                const btnCancel = document.getElementById('uxBtnCancel');

                titleEl.innerText = title;
                descEl.innerText = desc;
                
                modal.classList.add('active');

                const cleanup = () => {
                    modal.classList.remove('active');
                    btnConfirm.removeEventListener('click', onConfirm);
                    btnCancel.removeEventListener('click', onCancel);
                };

                const onConfirm = () => {
                    cleanup();
                    resolve(true);
                };

                const onCancel = () => {
                    cleanup();
                    resolve(false);
                };

                btnConfirm.addEventListener('click', onConfirm);
                btnCancel.addEventListener('click', onCancel);
            });
        }

        // --- UX SAVING INDICATOR HOOK ---
        const saveIndicator = document.getElementById('uxSaveIndicator');
        let hideSaveIndicatorTimeout;

        // Override existing listener logic via new listener
        document.addEventListener('input', (e) => {
            if(e.target.closest('.sheet') || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                saveIndicator.classList.add('active');
                clearTimeout(hideSaveIndicatorTimeout);
                
                hideSaveIndicatorTimeout = setTimeout(() => {
                    saveIndicator.classList.remove('active');
                }, 1500);
            }
        });

        // --- WRAPPER FUNCTIONS (THE EXTEND STRATEGY) ---

        // Wrapper for Add Page
        function handleAddPage(type, btn) {
            uxBtnLoad(btn, true);
            setTimeout(() => {
                try {
                    addPage(type);
                    uxToast("Halaman berhasil ditambahkan");
                } catch(e) {
                    uxToast("Gagal menambah halaman", "error");
                    console.error(e);
                } finally {
                    uxBtnLoad(btn, false);
                }
            }, 300); // Fake delay for UX feel
        }

        // Wrapper for Print
        async function handleSafePrint(btn) {
            uxShowLoader("Menyiapkan Resolusi Tinggi..."); // Pesan loader diupdate untuk mencerminkan proses rendering kualitas tinggi
            uxBtnLoad(btn, true);
            
            try {
                // Wait small delay to allow UI to render loader
                await new Promise(r => setTimeout(r, 100));
                
                await safePrint();
                uxToast("PDF Print Shop Quality Berhasil Diunduh!", "success");
            } catch (e) {
                uxToast("Gagal membuat PDF", "error");
            } finally {
                uxHideLoader();
                uxBtnLoad(btn, false);
            }
        }

        // Wrapper for Delete Confirmation
        async function handleConfirmDelete() {
            // No async logic needed for delete execution, but good for UI consistency
            try {
                confirmDelete();
                uxToast("Halaman dihapus", "info");
            } catch(e) {
                uxToast("Gagal menghapus", "error");
            }
        }

        // Wrapper for Embed Confirmation
        function handleConfirmEmbed() {
            confirmEmbed();
            // Toasts handled inside validation logic or we can add here if successful
        }

        // Wrapper for Edit Mode
        function handleConfirmEditMode() {
            confirmEditMode();
            uxToast("Mode Edit Diaktifkan", "info");
        }

        // Wrapper for Reset All (The Trickiest One)
        async function handleResetAllPages() {
            const confirmed = await uxConfirm(
                "Reset Semua Data?", 
                "Tindakan ini akan menghapus semua halaman dan data tersimpan. Tidak bisa dibatalkan."
            );

            if (confirmed) {
                // TRICK: Override window.confirm temporarily so the original function doesn't popup a second native alert
                const originalConfirm = window.confirm;
                window.confirm = () => true; 
                
                uxShowLoader("Mereset Sistem...");
                
                setTimeout(() => {
                    resetAllPages(); // This calls reload, so loader stays until reload
                    window.confirm = originalConfirm; // Restore just in case reload fails
                }, 500);
            }
        }

        // =========================================
        // 11. HTML EDITOR LOGIC (ADDITIVE)
        // =========================================
        let currentEditingIndex = -1;

        // 1. SELECTOR MODAL
        function openHtmlEditSelectionModal() {
            const dropdown = document.getElementById('htmlPageSelect');
            if(!dropdown) return;
            dropdown.innerHTML = '';
            
            const sheets = document.querySelectorAll('.sheet');
            if(sheets.length === 0) {
                uxToast("Tidak ada halaman.", "error");
                return;
            }

            sheets.forEach((sheet, i)=>{
                const option = document.createElement('option');
                option.value = i;
                
                let title = `Halaman ${i+1}`;
                const content = sheet.textContent || sheet.innerText;
                const type = sheet.dataset.pageType === 'embed' ? ' [EMBED]' : '';
                
                if(content.includes('CUSTOM PAGE')) title += " (Custom)";
                
                option.textContent = title + type;
                dropdown.appendChild(option);
            });

            document.getElementById('htmlEditSelectModal').style.display = 'flex';
        }

        function closeHtmlEditSelectModal() {
            document.getElementById('htmlEditSelectModal').style.display = 'none';
        }

        // 2. OPEN EDITOR
        function handleOpenHtmlEditor() {
            const index = document.getElementById('htmlPageSelect').value;
            if(index === "") return;

            currentEditingIndex = parseInt(index);
            const sheets = document.querySelectorAll('.sheet');
            const sheet = sheets[currentEditingIndex];

            if(!sheet) return;

            closeHtmlEditSelectModal();

            // Determine Content Source (Crucial: Protect Embeds)
            let contentToEdit = "";
            const isEmbed = sheet.dataset.pageType === 'embed';

            if(isEmbed) {
                // Source of truth for embed is the hidden textarea .raw-storage
                const storage = sheet.querySelector('.raw-storage');
                contentToEdit = storage ? storage.value : "<!-- Error: Raw Storage not found -->";
                document.getElementById('editorPageInfo').innerText = `Halaman ${currentEditingIndex+1} (Embed Mode)`;
            } else {
                // Source of truth for standard page is innerHTML
                contentToEdit = sheet.innerHTML;
                document.getElementById('editorPageInfo').innerText = `Halaman ${currentEditingIndex+1} (Standard Mode)`;
            }

            // Load into textarea
            const textarea = document.getElementById('htmlCodeInput');
            
            // Optional: Basic pretty print for readability (add newlines after block tags)
            // But we keep it relatively raw to avoid breaking spacing
            textarea.value = formatHtmlForEditor(contentToEdit);
            
            document.getElementById('htmlEditorModal').style.display = 'flex';
        }

        function closeHtmlEditorModal() {
            document.getElementById('htmlEditorModal').style.display = 'none';
            currentEditingIndex = -1;
        }

        // 3. LIVE PREVIEW LOGIC
        function handlePreviewHtml() {
            if(currentEditingIndex === -1) return;

            const code = document.getElementById('htmlCodeInput').value;
            const sheets = document.querySelectorAll('.sheet');
            const sheet = sheets[currentEditingIndex];
            const isEmbed = sheet.dataset.pageType === 'embed';

            try {
                // Sanitize first
                const safeCode = cleanHTML(code);

                if(isEmbed) {
                    // For embed, we update the .embed-safe-zone wrapper
                    let wrapper = sheet.querySelector('.embed-safe-zone');
                    if(!wrapper) {
                        // Recreate if missing
                         wrapper = document.createElement('div');
                         wrapper.className = 'embed-safe-zone';
                         sheet.innerHTML = '';
                         sheet.appendChild(wrapper);
                    }
                    wrapper.innerHTML = safeCode;
                } else {
                    // For standard, direct innerHTML update (REPLACED WITH SAFE INJECTION)
                    let movable = sheet.querySelector('.layout-movable');
                    
                    // VALIDASI: Extract content safely
                    const tempParser = document.createElement('div');
                    tempParser.innerHTML = safeCode;
                    let contentToInject = safeCode;
                    
                    const parsedMovable = tempParser.querySelector('.layout-movable');
                    if (parsedMovable) {
                        // User retained the structure, copy inner part
                        contentToInject = parsedMovable.innerHTML;
                    } else {
                        // User deleted layout-movable, clean system UI elements if any
                        tempParser.querySelectorAll('.zoom-controls, .zoom-indicator, .page-number, .edit-badge, .landscape-marker, .duplicate-controls').forEach(el => el.remove());
                        contentToInject = tempParser.innerHTML;
                    }

                    if (movable) {
                        // Simpan nilai lama
                        const x = movable.getAttribute('data-x') || '0';
                        const y = movable.getAttribute('data-y') || '0';
                        const scale = movable.getAttribute('data-scale') || '1';
                        
                        // Replace hanya area konten
                        movable.innerHTML = contentToInject;
                        
                        // Restore atribut posisi & zoom
                        movable.setAttribute('data-x', x);
                        movable.setAttribute('data-y', y);
                        movable.setAttribute('data-scale', scale);
                        movable.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
                    } else {
                        // System auto re-wrap fallback jika hilang
                        const stage = document.createElement('div');
                        stage.className = 'layout-stage';
                        movable = document.createElement('div');
                        movable.className = 'layout-movable';
                        movable.setAttribute('data-x', '0');
                        movable.setAttribute('data-y', '0');
                        movable.setAttribute('data-scale', '1');
                        movable.innerHTML = contentToInject;
                        stage.appendChild(movable);
                        
                        // Bersihkan elemen konten lama tapi biarkan UI sistem utuh
                        Array.from(sheet.children).forEach(child => {
                            if (!['page-number', 'zoom-controls', 'zoom-indicator', 'landscape-marker', 'edit-badge', 'duplicate-controls'].some(c => child.classList.contains(c))) {
                                child.remove();
                            }
                        });
                        
                        const marker = sheet.querySelector('.landscape-marker');
                        if (marker) marker.after(stage);
                        else sheet.insertBefore(stage, sheet.firstChild);
                    }
                }

                uxToast("Preview diperbarui", "info");

                // Scroll to preview behind modal (optional, might be covered)
                sheet.scrollIntoView({ behavior: 'smooth', block: 'center' });

            } catch(e) {
                uxToast("HTML Invalid. Cek tag.", "error");
                console.error(e);
            }
        }

        // 4. SAVE LOGIC
        function handleSaveHtmlChange() {
            if(currentEditingIndex === -1) return;

            const code = document.getElementById('htmlCodeInput').value;
            const sheets = document.querySelectorAll('.sheet');
            const sheet = sheets[currentEditingIndex];
            const isEmbed = sheet.dataset.pageType === 'embed';

            try {
                // 1. Sanitize
                const safeCode = cleanHTML(code);

                // 2. Update DOM & DB based on Type
                if (isEmbed) {
                    // Update DOM
                    let wrapper = sheet.querySelector('.embed-safe-zone');
                    if(!wrapper) {
                         wrapper = document.createElement('div');
                         wrapper.className = 'embed-safe-zone';
                         sheet.innerHTML = '';
                         sheet.appendChild(wrapper);
                    }
                    wrapper.innerHTML = safeCode;

                    // Update Hidden Storage (DOM Source of Truth)
                    let storage = sheet.querySelector('.raw-storage');
                    if(!storage) {
                        storage = document.createElement('textarea');
                        storage.className = 'raw-storage';
                        storage.style.display = 'none';
                        sheet.appendChild(storage);
                    }
                    storage.value = safeCode;

                    // Update DB (Memory)
                    if(pagesDB[currentEditingIndex]) {
                        pagesDB[currentEditingIndex].rawHTML = safeCode;
                    }

                } else {
                    // Standard Page
                    let movable = sheet.querySelector('.layout-movable');
                    
                    // Parsing safeCode to handle user tampering
                    const tempParser = document.createElement('div');
                    tempParser.innerHTML = safeCode;
                    let contentToInject = safeCode;
                    
                    const parsedMovable = tempParser.querySelector('.layout-movable');
                    if (parsedMovable) {
                        // Ambil isi dalam layout-movable
                        contentToInject = parsedMovable.innerHTML;
                    } else {
                        // Jika layout dihapus manual, buang elemen sistem yang terikut agar tidak double
                        tempParser.querySelectorAll('.zoom-controls, .zoom-indicator, .page-number, .edit-badge, .landscape-marker, .duplicate-controls').forEach(el => el.remove());
                        contentToInject = tempParser.innerHTML;
                    }

                    if (movable) {
                        // Simpan nilai lama drag & zoom
                        const x = movable.getAttribute('data-x') || '0';
                        const y = movable.getAttribute('data-y') || '0';
                        const scale = movable.getAttribute('data-scale') || '1';
                        
                        // Replace HANYA area konten yang movable
                        movable.innerHTML = contentToInject;
                        
                        // Restore atribut
                        movable.setAttribute('data-x', x);
                        movable.setAttribute('data-y', y);
                        movable.setAttribute('data-scale', scale);
                        movable.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
                    } else {
                        // Auto-rewrap fallback jika user menghapus strukturnya
                        const stage = document.createElement('div');
                        stage.className = 'layout-stage';
                        movable = document.createElement('div');
                        movable.className = 'layout-movable';
                        movable.setAttribute('data-x', '0');
                        movable.setAttribute('data-y', '0');
                        movable.setAttribute('data-scale', '1');
                        movable.innerHTML = contentToInject;
                        stage.appendChild(movable);
                        
                        // Bersihkan elemen konten lama tapi biarkan UI sistem utuh
                        Array.from(sheet.children).forEach(child => {
                            if (!['page-number', 'zoom-controls', 'zoom-indicator', 'landscape-marker', 'edit-badge', 'duplicate-controls'].some(c => child.classList.contains(c))) {
                                child.remove();
                            }
                        });
                        
                        const marker = sheet.querySelector('.landscape-marker');
                        if (marker) marker.after(stage);
                        else sheet.insertBefore(stage, sheet.firstChild);
                    }
                    
                    // Update DB (Memory) menggunakan sheet.innerHTML yang sudah ter-update & dipertahankan strukturnya
                    if(pagesDB[currentEditingIndex]) {
                        pagesDB[currentEditingIndex].html = sheet.innerHTML;
                    }
                }

                // 3. Persist to Storage
                saveToStorage();

                // 4. Re-sync Dynamic Data (Variables & Page Numbers)
                updatePageNumbers();

                uxToast("HTML Berhasil Disimpan", "success");
                closeHtmlEditorModal();

                // 5. Scroll to edited page
                setTimeout(() => {
                    sheet.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
                
                // Trigger Smart Flow Analysis
                debouncedAutoFlow();

            } catch(e) {
                uxToast("Gagal menyimpan. Cek error console.", "error");
                console.error(e);
            }
        }

        // Helper: Basic pretty print (very simple)
        function formatHtmlForEditor(html) {
            // Add newlines after block closing tags for readability in textarea
            // This is non-destructive
            return html
                .replace(/<\/div>/g, '</div>\n')
                .replace(/<\/p>/g, '</p>\n')
                .replace(/<\/tr>/g, '</tr>\n')
                .replace(/<br>/g, '<br>\n');
        }

    </script>

    <!-- =========================================
       12. NEW: WORD (DOCX) EXPORT LOGIC (ADDITIVE)
       ========================================= -->
    <script id="word-export-logic">
        async function handleExportWordWrapper(btn) {
            uxShowLoader("Menyiapkan file Word (.docx)...");
            uxBtnLoad(btn, true);
            
            try {
                // Jalankan Smart Layout Engine jika belum di-run
                if(!isAutoFlowing) await triggerAutoFlowEngine(true);
                // Wait small delay to allow UI to render loader
                await new Promise(r => setTimeout(r, 100));
                await executeWordExport();
            } catch (e) {
                console.error(e);
                uxToast("Gagal export Word. Cek koneksi internet untuk library.", "error");
            } finally {
                uxHideLoader();
                uxBtnLoad(btn, false);
            }
        }

        async function executeWordExport() {
            if (typeof htmlDocx === 'undefined') {
                throw new Error("Library htmlDocx belum dimuat!");
            }

            const sheets = document.querySelectorAll('.sheet');
            if(!sheets.length) {
                alert('Tidak ada halaman untuk didownload!');
                return;
            }

            // Pastikan nilai terbaru tersimpan ke atribut DOM
            document.querySelectorAll('.sheet input[type="text"], .sheet input[type="number"]').forEach(el => {
                el.setAttribute('value', el.value);
            });
            document.querySelectorAll('.sheet textarea').forEach(el => {
                el.innerHTML = el.value.replace(/\n/g, '<br>');
            });

            // 1. Kumpulkan semua CSS yang aktif di halaman untuk menjaga styling tabel, dll.
            let activeStyles = '';
            document.querySelectorAll('style').forEach(s => {
                activeStyles += s.innerHTML;
            });

            // 2. Tambahkan MSO khusus untuk mengatur kertas F4 (215x330mm) ke Twip/Inch Word
            activeStyles += `
                @page {
                    size: 8.46in 12.99in; /* F4 width 215mm, height 330mm */
                    margin: 0.79in; /* 20mm */
                }
                @page SectionPortrait {
                    size: 8.46in 12.99in;
                    margin: 0.79in;
                    mso-page-orientation: portrait;
                }
                @page SectionLandscape {
                    size: 12.99in 8.46in;
                    margin: 0.79in;
                    mso-page-orientation: landscape;
                }
                div.SectionPortrait { page: SectionPortrait; }
                div.SectionLandscape { page: SectionLandscape; }
                
                /* Override agar sesuai spesifikasi di prompt */
                body, p, span, td, th, div, h1, h2, h3, h4, table {
                    font-family: "Times New Roman", Times, serif !important;
                }
            `;

            // ADDITIVE: Konversi mm ke inch khusus untuk Export Word Docx
            const mmToIn = mm => mm * 0.0393701;

            // 3. Bangun HTML untuk Word
            let htmlContent = `
            <!DOCTYPE html>
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head>
                <meta charset="utf-8">
                <style>${activeStyles}</style>
            </head>
            <body>
            `;

            // 4. Proses per halaman untuk mapping sempurna
            sheets.forEach((sheet, index) => {
                const isLandscape = sheet.classList.contains('landscape');
                const clone = sheet.cloneNode(true); // Clone agar DOM asli tidak rusak

                // --- FIX POSISI DRAG & DROP UNTUK WORD ---
                // Word mengabaikan CSS transform, jadi kita ubah ke margin (Skala/Zoom tidak disupport Word di sini, jadi dirender posisi original/scaled normal)
                clone.querySelectorAll('.layout-movable').forEach(movable => {
                    const x = parseFloat(movable.getAttribute('data-x')) || 0;
                    const y = parseFloat(movable.getAttribute('data-y')) || 0;
                    
                    movable.style.position = 'relative';
                    if (x !== 0 || y !== 0) {
                        movable.style.left = `${x}px`;
                        movable.style.top = `${y}px`;
                        movable.style.transform = 'none'; // Bersihkan transform agar aman
                    }
                });

                // --- PEMBERSIHAN ELEMEN UI (Termasuk Zoom Controls Baru & Duplicate) ---
                clone.querySelectorAll('.edit-badge, .sheet-controls, .menu-toggle, aside, .page-number, input[type="file"], .zoom-controls, .zoom-indicator, .duplicate-controls').forEach(el => el.remove());

                // --- TRANSFORMASI FORM ELEMENT KE TEKS ---
                clone.querySelectorAll('input[type="text"], input[type="number"]').forEach(el => {
                    const span = document.createElement('span');
                    span.innerText = el.value || el.getAttribute('value') || '';
                    span.style.cssText = el.style.cssText;
                    span.className = el.className;
                    el.replaceWith(span);
                });

                clone.querySelectorAll('textarea').forEach(el => {
                    const div = document.createElement('div');
                    div.innerHTML = (el.value || el.innerHTML || '').replace(/\n/g, '<br>');
                    div.style.cssText = el.style.cssText;
                    div.className = el.className;
                    el.replaceWith(div);
                });

                clone.querySelectorAll('input[type="checkbox"]').forEach(el => {
                    const span = document.createElement('span');
                    span.innerHTML = el.checked ? '&#9745;' : '&#9744;'; // Unicode checked/unchecked box
                    span.style.fontFamily = 'Arial'; // Renders symbol better in Word
                    span.style.fontSize = '12pt';
                    el.replaceWith(span);
                });

                // --- TRANSFORMASI FLEXBOX KE TABLE (KUNCI PRESISI WORD) ---
                // Word tidak bisa Flexbox, jadi Flexbox harus diubah jadi Table Layout
                
                // A. Kop Surat
                clone.querySelectorAll('.kop-surat').forEach(kop => {
                    const imgContainer = kop.querySelector('.kop-img');
                    const img = imgContainer ? imgContainer.querySelector('img') : null;
                    const text = kop.querySelector('.kop-text');

                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderBottom = '3px double #000';
                    table.style.marginBottom = '20px';
                    table.setAttribute('cellpadding', '0');
                    table.setAttribute('cellspacing', '0');

                    let imgHtml = '';
                    if (img && img.src) {
                         imgHtml = `<img src="${img.src}" style="width:80px; height:90px;" />`;
                    }

                    table.innerHTML = `
                        <tr>
                            <td style="width:15%; text-align:center; vertical-align:middle; padding-bottom:10px;">
                                ${imgHtml}
                            </td>
                            <td style="width:85%; text-align:center; vertical-align:middle; padding-bottom:10px;">
                                ${text ? text.innerHTML : ''}
                            </td>
                        </tr>
                    `;
                    kop.replaceWith(table);
                });

                // B. Signature Section
                clone.querySelectorAll('.signature-section').forEach(sig => {
                    const boxes = sig.querySelectorAll('.ttd-box');
                    if (boxes.length >= 2) {
                        const table = document.createElement('table');
                        table.style.width = '100%';
                        table.style.marginTop = '30px';
                        table.style.pageBreakInside = 'avoid';
                        table.setAttribute('cellpadding', '0');
                        table.setAttribute('cellspacing', '0');
                        table.innerHTML = `
                            <tr>
                                <td style="width:50%; text-align:center; vertical-align:top;">
                                    ${boxes[0].innerHTML}
                                </td>
                                <td style="width:50%; text-align:center; vertical-align:top;">
                                    ${boxes[1].innerHTML}
                                </td>
                            </tr>
                        `;
                        sig.replaceWith(table);
                    }
                });

                // C. Photo Grid
                clone.querySelectorAll('.photo-grid').forEach(grid => {
                    const cards = grid.querySelectorAll('.photo-card');
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.marginTop = '10px';
                    table.setAttribute('cellpadding', '5');
                    table.setAttribute('cellspacing', '0');
                    
                    let rows = '';
                    for (let i = 0; i < cards.length; i += 2) {
                        rows += `<tr>`;
                        rows += `<td style="width:50%; vertical-align:top; border:1px solid #000;">${cards[i] ? cleanPhotoCardForWord(cards[i]) : ''}</td>`;
                        rows += `<td style="width:50%; vertical-align:top; border:1px solid #000;">${cards[i+1] ? cleanPhotoCardForWord(cards[i+1]) : ''}</td>`;
                        rows += `</tr>`;
                    }
                    table.innerHTML = rows;
                    grid.replaceWith(table);
                });

                function cleanPhotoCardForWord(card) {
                    const img = card.querySelector('img');
                    const cap = card.querySelector('.photo-caption');
                    let res = '';
                    
                    // Bersihkan span placeholder jika ada
                    const span = card.querySelector('span');
                    if(span) span.remove();

                    if(img && img.src && !img.src.includes('display:none')) {
                         res += `<div style="text-align:center;"><img src="${img.src}" style="max-width:100%; height:200px;" /></div>`;
                    } else {
                         res += `<div style="height:200px; text-align:center; color:#999;"><br><br><br><br>[Area Foto]</div>`;
                    }
                    if(cap) {
                         res += `<div style="text-align:center; margin-top:5px; border-top:1px dotted #ccc; padding-top:5px;">${cap.innerHTML}</div>`;
                    }
                    return res;
                }

                // --- PASTIKAN BORDER TABEL WORD MUNCUL (INLINE BORDER) ---
                clone.querySelectorAll('table').forEach(t => {
                    t.style.borderCollapse = 'collapse';
                });
                clone.querySelectorAll('table.dinas th, table.dinas td, table.table-padat th, table.table-padat td, table.table-grid th, table.table-grid td').forEach(cell => {
                    cell.style.border = '1px solid #000';
                });

                // --- FIX TEXT ROTATION UNTUK LANDSCAPE TABEL (SETORAN HAFALAN) ---
                clone.querySelectorAll('th div[style*="transform: rotate"]').forEach(div => {
                    // MSO Specific property untuk memutar teks di Word
                    div.style.writingMode = 'vertical-rl';
                    div.style.msoTextDirection = 'tb-rl';
                    // Hilangkan transform CSS biasa agar tidak rancu
                    div.style.transform = 'none';
                });

                // --- TAMBAHKAN NOMOR HALAMAN MANUALLY ---
                const pageNumDiv = document.createElement('div');
                pageNumDiv.style.textAlign = 'center';
                pageNumDiv.style.fontSize = '9pt';
                pageNumDiv.style.marginTop = '20px';
                pageNumDiv.innerText = `- ${index + 1} -`;
                clone.appendChild(pageNumDiv);

                // ADDITIVE: Dinamiskan @page style untuk Word berdasarkan Paper Size halaman ini
                const pageData = pagesDB[index] || {};
                let wMM = pageData.paperSize?.width || 215;
                let hMM = pageData.paperSize?.height || 330;
                
                // ADDITIVE: Konversi Margin ke inch
                let mTopIn = mmToIn(pageData.margin?.top || 20).toFixed(2);
                let mRightIn = mmToIn(pageData.margin?.right || 20).toFixed(2);
                let mBottomIn = mmToIn(pageData.margin?.bottom || 20).toFixed(2);
                let mLeftIn = mmToIn(pageData.margin?.left || 20).toFixed(2);

                let dynamicStyle = "";
                const sectionClass = `SectionDyn${index}`;
                
                if (isLandscape) {
                    const widthIn = mmToIn(hMM).toFixed(2);
                    const heightIn = mmToIn(wMM).toFixed(2);
                    dynamicStyle = `
                        <style>
                            @page ${sectionClass} { size: ${widthIn}in ${heightIn}in; mso-page-orientation: landscape; margin: ${mTopIn}in ${mRightIn}in ${mBottomIn}in ${mLeftIn}in; }
                            div.${sectionClass} { page: ${sectionClass}; }
                        </style>
                    `;
                } else {
                    const widthIn = mmToIn(wMM).toFixed(2);
                    const heightIn = mmToIn(hMM).toFixed(2);
                    dynamicStyle = `
                        <style>
                            @page ${sectionClass} { size: ${widthIn}in ${heightIn}in; mso-page-orientation: portrait; margin: ${mTopIn}in ${mRightIn}in ${mBottomIn}in ${mLeftIn}in; }
                            div.${sectionClass} { page: ${sectionClass}; }
                        </style>
                    `;
                }

                // --- BUNGKUS DENGAN SECTION KERTAS ---
                htmlContent += dynamicStyle;
                htmlContent += `<div class="${sectionClass}">\n`;
                htmlContent += clone.innerHTML;
                htmlContent += `\n</div>\n`;

                // Add Page Break if not last page
                if (index < sheets.length - 1) {
                    htmlContent += `<br clear="all" style="page-break-before:always" />\n`;
                }
            });

            htmlContent += `
            </body>
            </html>
            `;

            // Gunakan html-docx-js untuk konversi ke DOCX format
            const converted = htmlDocx.asBlob(htmlContent);
            saveAs(converted, "Laporan-Sekolah.docx");
            
            uxToast("Word (.docx) Berhasil Diunduh!", "success");
        }
    </script>

    <!-- =========================================
       13. ZIP EXPORT & IMPORT LOGIC (UPGRADED)
       ========================================= -->
    <script id="zip-logic">
        // Fungsi Export ZIP
        async function exportToZip() {
            uxShowLoader("Menyiapkan file ZIP...");
            
            // 1. Sinkronisasi input form ke atribut value/innerHTML
            document.querySelectorAll('.sheet input[type="text"], .sheet input[type="number"]').forEach(el => {
                el.setAttribute('value', el.value);
            });
            document.querySelectorAll('.sheet textarea').forEach(el => {
                el.innerHTML = el.value;
            });
            document.querySelectorAll('.sheet input[type="checkbox"]').forEach(el => {
                if(el.checked) el.setAttribute('checked', 'checked');
                else el.removeAttribute('checked');
            });

            // 2. Simpan state terbaru ke pagesDB
            saveToStorage();

            // 3. Clone DB untuk dimanipulasi agar layar aktif tidak rusak
            let exportDB = JSON.parse(JSON.stringify(pagesDB));
            
            // 4. Inisialisasi JSZip
            const zip = new JSZip();
            const imgFolder = zip.folder("images");
            let imgCounter = 1;

            // 5. Ekstrak gambar base64 ke bentuk file, dan simpan seluruh struktur asli
            exportDB.forEach((page, pageIndex) => {
                if (page.type === 'standard' && page.html) {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(page.html, 'text/html');
                    
                    doc.querySelectorAll('img').forEach((img, imgIndex) => {
                        const src = img.getAttribute('src');
                        if (src && src.startsWith('data:image/')) {
                            try {
                                const parts = src.split(',');
                                const mimeInfo = parts[0].match(/:(.*?);/);
                                if (mimeInfo) {
                                    const mime = mimeInfo[1];
                                    const ext = mime.split('/')[1] || 'png';
                                    const b64Data = parts[1];
                                    const fileName = `img_p${pageIndex}_${imgIndex}_${imgCounter++}.${ext}`;
                                    
                                    // Simpan base64 ke dalam folder images di dalam file ZIP
                                    imgFolder.file(fileName, b64Data, {base64: true});
                                    
                                    // Ubah src di HTML menjadi path relatif
                                    img.setAttribute('src', `images/${fileName}`);
                                }
                            } catch(e) {
                                console.error("Gagal memproses gambar:", e);
                            }
                        }
                    });

                    // Bersihkan value cache dari input file demi keamanan data JSON
                    doc.querySelectorAll('input[type="file"]').forEach(inp => {
                        inp.removeAttribute('value');
                    });
                    
                    page.html = doc.body.innerHTML;
                }
            });

            // 6. Masukkan data.json (beserta penanda versi & checksum) ke root ZIP
            const exportData = {
                version: "10.0",
                pages: exportDB
            };
            zip.file("data.json", JSON.stringify(exportData, null, 2));

            // 7. Generate dan Download ZIP
            try {
                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, "Laporan-Sekolah-Lengkap.zip");
                uxToast("Export ZIP Berhasil!", "success");
            } catch (err) {
                console.error(err);
                uxToast("Gagal men-generate ZIP", "error");
            } finally {
                uxHideLoader();
            }
        }

        // Fungsi Trigger Import ZIP
        function importFromZipTrigger() {
            document.getElementById('zipLoader').click();
        }

        // Fungsi Proses Import ZIP
        function processZipImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            uxShowLoader("Mengekstrak file ZIP...");
            
            const zip = new JSZip();
            zip.loadAsync(file).then(async (loadedZip) => {
                try {
                    // Cek apakah data.json ada di dalam ZIP
                    const jsonFile = loadedZip.file("data.json");
                    if (!jsonFile) {
                        throw new Error("File data.json tidak ditemukan di dalam ZIP!");
                    }

                    // Parse data.json
                    const jsonDataStr = await jsonFile.async("string");
                    let parsedData;
                    try {
                        parsedData = JSON.parse(jsonDataStr);
                    } catch (e) {
                        throw new Error("Format data.json rusak atau bukan JSON yang valid.");
                    }

                    let importedDB = [];
                    let version = "Legacy";

                    // CHECKSUM & VERSIONING VALIDATION
                    if (Array.isArray(parsedData)) {
                        importedDB = parsedData;
                    } else if (parsedData && Array.isArray(parsedData.pages)) {
                        importedDB = parsedData.pages;
                        version = parsedData.version || "Unknown";
                    } else {
                        throw new Error("Struktur data.json tidak valid. Kehilangan array halaman.");
                    }

                    if (version !== "9.9" && version !== "10.0" && version !== "Legacy") {
                        uxToast(`Warning: Memuat ZIP dari versi berbeda (${version})`, "warning");
                    }

                    // Proses setiap halaman untuk mengembalikan path gambar menjadi base64/dataURI
                    for (let i = 0; i < importedDB.length; i++) {
                        const page = importedDB[i];
                        if (page.type === 'standard' && page.html) {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(page.html, 'text/html');
                            
                            const images = Array.from(doc.querySelectorAll('img'));
                            for (let img of images) {
                                const src = img.getAttribute('src');
                                // Jika src mengarah ke folder images/
                                if (src && src.startsWith('images/')) {
                                    const imgFileInZip = loadedZip.file(src);
                                    if (imgFileInZip) {
                                        // Baca base64 dari zip yang diekstrak di memory
                                        const b64 = await imgFileInZip.async("base64");
                                        
                                        // Deteksi mime type dari ekstensi file
                                        const ext = src.split('.').pop().toLowerCase();
                                        let mime = 'image/png';
                                        if(ext === 'jpg' || ext === 'jpeg') mime = 'image/jpeg';
                                        else if(ext === 'gif') mime = 'image/gif';
                                        else if(ext === 'svg') mime = 'image/svg+xml';
                                        else if(ext === 'webp') mime = 'image/webp';

                                        // Kembalikan src ke format base64 agar browser bisa render kembali secara instan
                                        img.setAttribute('src', `data:${mime};base64,${b64}`);
                                    }
                                }
                            }
                            // Update HTML halaman dengan gambar yang sudah ditautkan ulang
                            page.html = doc.body.innerHTML;
                        }
                    }

                    // --- FLAG PENTING ---
                    // Mencegah auto-pagination memecah halaman saat di-render yang dapat merubah layout & tinggi
                    isImportingZip = true;
                    // Mencegah modifikasi struktur DOM, mempertahankan HTML persis seperti hasil zip
                    isStrictRestore = true;

                    // Terapkan ke state utama
                    pagesDB = importedDB;
                    renderPages();      // Render ulang menggunakan function bawaan (HTML structure dipertahankan)
                    
                    // JANGAN PANGGIL saveToStorage() KARENA AKAN MEMBACA ULANG DARI DOM DAN MERUSAK STRUKTUR ASLI
                    // Sebagai gantinya kita masukkan array asli ke storage persisten:
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(pagesDB)); 
                    pushHistoryState(); // Simpan state import pertama
                    
                    isImportingZip = false;
                    isStrictRestore = false;

                    // Run Auto Flow Analysis Post-Import
                    triggerAutoFlowEngine(true);

                    uxToast("Import ZIP Berhasil!", "success");
                } catch (err) {
                    console.error("Import error:", err);
                    uxToast(err.message || "Gagal memproses file ZIP", "error");
                } finally {
                    uxHideLoader();
                    event.target.value = ''; // Reset input agar event onchange selalu ke-trigger walau file sama
                }
            }).catch(err => {
                console.error("JSZip error:", err);
                uxToast("Gagal membaca ZIP. File corrupt.", "error");
                uxHideLoader();
                event.target.value = ''; // Reset input
            });
        }
    </script>

    <!-- =========================================
       14. TAB INDENTATION LOGIC (PRESERVED)
       ========================================= -->
    <script id="tab-indent-logic">
        document.addEventListener('keydown', function(e) {
            // Hanya deteksi ketika tombol Tab ditekan
            if (e.key === 'Tab') {
                const activeElement = document.activeElement;
                
                // PENGECUALIAN: Biarkan Tab bekerja normal (pindah fokus) jika sedang berada di input form sidebar
                if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'SELECT')) {
                    return; 
                }

                // Cek apakah area saat ini bisa diedit
                const isContentEditable = activeElement && activeElement.isContentEditable || (e.target && e.target.closest && e.target.closest('[contenteditable="true"]'));
                
                if (isContentEditable) {
                    e.preventDefault(); // Mencegah default behavior (kursor tidak akan lompat keluar)

                    const selection = window.getSelection();
                    if (!selection.rangeCount) return;
                    const range = selection.getRangeAt(0);

                    if (!e.shiftKey) {
                        // ==========================================
                        // TEKAN TAB (TANPA SHIFT): Tambah 4 Spasi
                        // ==========================================
                        if (!range.collapsed) {
                            range.deleteContents(); // Hapus teks jika user sedang mem-blok teks lalu menekan Tab
                        }
                        
                        // Gunakan Non-Breaking Space (\u00a0) agar jarak tidak diciutkan oleh HTML
                        const tabText = document.createTextNode('\u00a0\u00a0\u00a0\u00a0');
                        range.insertNode(tabText);
                        
                        // Pindahkan kursor secara otomatis ke kanan (setelah spasi yang baru disisipkan)
                        range.setStartAfter(tabText);
                        range.setEndAfter(tabText);
                        selection.removeAllRanges();
                        selection.addRange(range);

                    } else {
                        // ==========================================
                        // TEKAN SHIFT + TAB: Kurangi 4 Spasi (Hapus ke kiri)
                        // ==========================================
                        if (!range.collapsed) return; // Abaikan jika sedang mem-blok teks

                        if (range.startContainer.nodeType === Node.TEXT_NODE) {
                            const text = range.startContainer.textContent;
                            const offset = range.startOffset;
                            
                            let spacesToRemove = 0;
                            // Cari mundur maksimal 4 karakter, hitung berapa spasi yang ada
                            for (let i = 1; i <= 4; i++) {
                                const charIndex = offset - i;
                                if (charIndex >= 0) {
                                    const char = text[charIndex];
                                    // Deteksi Spasi biasa atau Non-breaking space
                                    if (char === ' ' || char === '\u00a0') {
                                        spacesToRemove++;
                                    } else {
                                        break; // Berhenti jika menemui huruf
                                    }
                                } else {
                                    break;
                                }
                            }

                            // Hapus spasi yang ditemukan
                            if (spacesToRemove > 0) {
                                const newText = text.slice(0, offset - spacesToRemove) + text.slice(offset);
                                range.startContainer.textContent = newText;
                                
                                // Kembalikan posisi kursor agar tidak melompat ke awal
                                range.setStart(range.startContainer, offset - spacesToRemove);
                                range.setEnd(range.startContainer, offset - spacesToRemove);
                                selection.removeAllRanges();
                                selection.addRange(range);
                            }
                        }
                    }
                    
                    // Trigger input event secara manual agar fitur Auto-Save sistem menangkap perubahan ini
                    if (e.target && e.target.dispatchEvent) {
                        e.target.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
            }
        });
    </script>

    <!-- =========================================
         15. NEW: ORIENTATION CONTROL LOGIC (ADDITIVE)
         ========================================= -->
    <script id="orientation-logic">
        // Fungsi untuk membuka modal orientasi
        function openOrientationModal() {
            const sheets = document.querySelectorAll('.sheet');
            if(sheets.length === 0){
                uxToast("Tidak ada halaman untuk diubah orientasinya.", "error");
                return;
            }

            const dropdown = document.getElementById('orientationPageSelect');
            dropdown.innerHTML = '';
            
            sheets.forEach((sheet, i) => {
                const option = document.createElement('option');
                option.value = i;
                
                let title = "Halaman " + (i+1);
                const content = sheet.textContent || sheet.innerText;
                
                if(content.includes('CUSTOM PAGE')) title += " (Custom)";

                // Tampilkan label orientasi saat ini di pilihan
                const isLandscape = sheet.classList.contains('landscape');
                title += isLandscape ? " [Landscape]" : " [Portrait]";

                option.textContent = title;
                dropdown.appendChild(option);
            });

            // Setelan awal berdasarkan halaman pertama yang ter-select
            updateOrientationSelectTarget();

            // Pasang event listener ketika dropdown halaman diubah
            dropdown.onchange = updateOrientationSelectTarget;

            document.getElementById('orientationModal').style.display = 'flex';
        }

        // Fungsi memperbarui dropdown mode sesuai dengan halaman yang dipilih
        function updateOrientationSelectTarget() {
            const index = document.getElementById('orientationPageSelect').value;
            const sheet = document.querySelectorAll('.sheet')[index];
            if(sheet) {
                const modeDropdown = document.getElementById('orientationModeSelect');
                modeDropdown.value = sheet.classList.contains('landscape') ? 'landscape' : 'portrait';
            }
        }

        // Fungsi menutup modal orientasi
        function closeOrientationModal() {
            document.getElementById('orientationModal').style.display = 'none';
        }

        // Fungsi konfirmasi trigger perubahan orientasi
        function confirmOrientationChange() {
            const index = document.getElementById('orientationPageSelect').value;
            const mode = document.getElementById('orientationModeSelect').value;
            handleChangeOrientation(parseInt(index), mode);
            closeOrientationModal();
        }

        // CORE LOGIC: Fungsi utama mengubah orientasi halaman terpilih
        function handleChangeOrientation(pageIndex, mode) {
            const sheets = document.querySelectorAll('.sheet');
            const sheet = sheets[pageIndex];
            if (!sheet) return;

            if (mode === 'landscape') {
                sheet.classList.remove('portrait');
                sheet.classList.add('landscape');

                // Sisipkan tag .landscape-marker agar renderPages() mendeteksinya setelah direload
                if (!sheet.querySelector('.landscape-marker')) {
                    const marker = document.createElement('div');
                    marker.className = 'landscape-marker';
                    marker.style.display = 'none';
                    sheet.insertBefore(marker, sheet.firstChild);
                }
            } else if (mode === 'portrait') {
                sheet.classList.remove('landscape');
                sheet.classList.add('portrait');

                // Hilangkan marker jika ada
                const markers = sheet.querySelectorAll('.landscape-marker');
                markers.forEach(m => m.remove());
            }

            // Integrasi ke RawHTML khusus halaman embed agar marker tidak hilang
            if (sheet.dataset.pageType === 'embed') {
                const storage = sheet.querySelector('.raw-storage');
                if (storage) {
                    if (mode === 'landscape' && !storage.value.includes('landscape-marker')) {
                         storage.value = '<div class="landscape-marker" style="display:none;"></div>\n' + storage.value;
                    } else if (mode === 'portrait') {
                         storage.value = storage.value.replace(/<div class="landscape-marker" style="display:none;"><\/div>\n?/g, '');
                    }
                    if (pagesDB[pageIndex]) pagesDB[pageIndex].rawHTML = storage.value;
                }
            } else {
                 if (pagesDB[pageIndex]) pagesDB[pageIndex].html = sheet.innerHTML;
            }

            // Simpan status ke penyimpanan database agar tidak hilang saat direfresh
            saveToStorage();
            uxToast("Orientasi berhasil diubah ke " + (mode === 'landscape' ? 'Landscape' : 'Portrait'), "success");

            // Gulung/Scroll layar agar pengguna melihat perubahannya langsung
            setTimeout(() => {
                sheet.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }
    </script>

    <!-- =========================================
         16. NEW: ZOOM & LAYOUT DRAG ENGINE (ADDITIVE)
         ========================================= -->
    <script id="layout-drag-logic-engine">
        let isDraggingLayout = false;
        let dragTarget = null;
        let startMouseX = 0;
        let startMouseY = 0;
        let startObjX = 0;
        let startObjY = 0;

        // Fungsi Trigger Button Sidebar
        function toggleLayoutDragMode(btn) {
            const body = document.body;
            if (body.classList.contains('layout-drag-mode')) {
                body.classList.remove('layout-drag-mode');
                btn.style.background = '#dcfce7';
                btn.style.color = '#166534';
                btn.innerHTML = '<i class="ph ph-arrows-out-cardinal"></i> üß≠ Mode Geser Layout';
                uxToast("Mode Geser Layout Dinonaktifkan", "info");
            } else {
                body.classList.add('layout-drag-mode');
                btn.style.background = '#166534';
                btn.style.color = '#ffffff';
                btn.innerHTML = '<i class="ph ph-check-circle"></i> ‚úÖ Selesai Geser';
                
                // Matikan mode edit text di semua sheet jika sedang aktif
                document.querySelectorAll('.sheet.editing').forEach(sheet => deactivateEditMode(sheet));
                
                uxToast("Mode Geser Layout Aktif! Tarik/drag konten halaman untuk memindahkannya.", "success");
            }
        }

        // --- CORE EVENT LISTENERS UNTUK DRAG ---
        document.addEventListener('mousedown', (e) => {
            if (!document.body.classList.contains('layout-drag-mode')) return;
            
            const movable = e.target.closest('.layout-movable');
            if (movable) {
                isDraggingLayout = true;
                dragTarget = movable;
                startMouseX = e.clientX;
                startMouseY = e.clientY;
                startObjX = parseFloat(movable.getAttribute('data-x')) || 0;
                startObjY = parseFloat(movable.getAttribute('data-y')) || 0;
                
                // Nonaktifkan CSS transition agar responsif ditarik
                movable.style.transition = 'none';
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDraggingLayout || !dragTarget) return;

            // Kalkulasi zoom scale luar (app zoom) vs scale dalam (layout scale)
            const sheet = dragTarget.closest('.sheet');
            let scaleApp = 1;
            if (sheet) {
                const style = window.getComputedStyle(sheet);
                const matrix = new DOMMatrixReadOnly(style.transform);
                if (matrix.a !== 1) {
                    scaleApp = matrix.a; // Asumsi 'a' pada matriks adalah scaleX/scaleY wrapper window
                }
            }

            const dx = (e.clientX - startMouseX) / scaleApp;
            const dy = (e.clientY - startMouseY) / scaleApp;
            
            let newX = startObjX + dx;
            let newY = startObjY + dy;

            // Baca Layout Scale yang tersimpan agar tidak di-reset saat drag
            const ls = parseFloat(dragTarget.getAttribute('data-scale')) || 1;

            // --- BATASAN KERTAS (LIMITER) ---
            const stage = dragTarget.parentElement;
            if (stage) {
                const stageRect = stage.getBoundingClientRect();
                
                // Batas toleransi ditarik keluar adalah 90% (disesuaikan dengan skala app, tidak masalah dengan scale internal layout)
                const limitX = (stageRect.width / scaleApp) * 0.9;
                const limitY = (stageRect.height / scaleApp) * 0.9;

                newX = Math.max(-limitX, Math.min(newX, limitX));
                newY = Math.max(-limitY, Math.min(newY, limitY));
            }

            // Terapkan translasi dan scale sekaligus
            dragTarget.style.transform = `translate(${newX}px, ${newY}px) scale(${ls})`;
            
            // Simpan posisi terkini ke dalam atribut (digunakan saat re-render / auto save)
            dragTarget.setAttribute('data-x', newX);
            dragTarget.setAttribute('data-y', newY);
        });

        document.addEventListener('mouseup', () => {
            if (isDraggingLayout && dragTarget) {
                // Kembalikan efek CSS transition
                dragTarget.style.transition = 'box-shadow 0.2s ease, outline 0.2s ease';
                
                // Trigger Auto Save Sistem untuk menyimpan posisi x & y baru
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    saveToStorage();
                }, 500);

                isDraggingLayout = false;
                dragTarget = null;
            }
        });

        // --- ADDITIVE: MOBILE TOUCH DRAG & PINCH ZOOM SUPPORT ---
        let isTouchDragging = false;
        let touchStartX = 0;
        let touchStartY = 0;
        let touchStartObjX = 0;
        let touchStartObjY = 0;
        let initialPinchDistance = null;
        let initialPinchScale = 1;

        document.addEventListener('touchstart', (e) => {
            if (!document.body.classList.contains('layout-drag-mode')) return;
            if (e.target.closest('[contenteditable="true"]')) return; // Mencegah konflik saat mode text

            const movable = e.target.closest('.layout-movable');
            if (!movable) return;

            // BONUS: Mode Pinch Zoom (2 Jari)
            if (e.touches.length === 2) {
                isTouchDragging = false; // Batalkan drag jika user ingin zoom
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                initialPinchDistance = Math.hypot(dx, dy);
                initialPinchScale = parseFloat(movable.getAttribute('data-scale')) || 1;
                dragTarget = movable;
                return;
            }

            // Mode Geser (1 Jari)
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                isTouchDragging = true;
                dragTarget = movable;

                touchStartX = touch.clientX;
                touchStartY = touch.clientY;

                touchStartObjX = parseFloat(movable.getAttribute('data-x')) || 0;
                touchStartObjY = parseFloat(movable.getAttribute('data-y')) || 0;

                movable.style.transition = 'none'; // Matikan animasi saat jari menggeser
            }
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            if (!document.body.classList.contains('layout-drag-mode')) return;

            e.preventDefault(); // Mencegah native scrolling di browser HP

            // Logika Pinch Zoom (2 Jari)
            if (e.touches.length === 2 && dragTarget && initialPinchDistance) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const currentDistance = Math.hypot(dx, dy);
                
                // Menghitung delta skala pinch
                const scaleDiff = (currentDistance / initialPinchDistance) - 1;
                const newScale = initialPinchScale + (scaleDiff * 0.8); // 0.8 adalah rasio speed zoom
                
                updateZoom(dragTarget, newScale);
                return;
            }

            // Logika Geser Layout (1 Jari)
            if (!isTouchDragging || !dragTarget || e.touches.length !== 1) return;

            const touch = e.touches[0];
            const sheet = dragTarget.closest('.sheet');

            let scaleApp = 1;
            if (sheet) {
                const style = window.getComputedStyle(sheet);
                const matrix = new DOMMatrixReadOnly(style.transform);
                if (matrix.a !== 1) scaleApp = matrix.a;
            }

            const dx = (touch.clientX - touchStartX) / scaleApp;
            const dy = (touch.clientY - touchStartY) / scaleApp;

            let newX = touchStartObjX + dx;
            let newY = touchStartObjY + dy;

            const ls = parseFloat(dragTarget.getAttribute('data-scale')) || 1;

            // --- BATASAN KERTAS (LIMITER) ---
            const stage = dragTarget.parentElement;
            if (stage) {
                const stageRect = stage.getBoundingClientRect();
                const limitX = (stageRect.width / scaleApp) * 0.9;
                const limitY = (stageRect.height / scaleApp) * 0.9;

                newX = Math.max(-limitX, Math.min(newX, limitX));
                newY = Math.max(-limitY, Math.min(newY, limitY));
            }

            dragTarget.style.transform = `translate(${newX}px, ${newY}px) scale(${ls})`;
            
            dragTarget.setAttribute('data-x', newX);
            dragTarget.setAttribute('data-y', newY);

        }, { passive: false });

        document.addEventListener('touchend', (e) => {
            // Reset state Pinch Zoom jika jari diangkat
            if (e.touches.length < 2) {
                initialPinchDistance = null; 
            }

            if (!isTouchDragging || !dragTarget) return;

            dragTarget.style.transition = 'box-shadow 0.2s ease, outline 0.2s ease';

            // Auto Save Sistem
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveToStorage();
            }, 500);

            isTouchDragging = false;
            
            // Lepas target hanya jika benar-benar tidak ada jari yang menyentuh layar
            if (e.touches.length === 0) {
                dragTarget = null;
            }
        });

        // --- ADDITIVE: ZOOM ENGINE ---
        function updateZoom(movable, newScale) {
            // Batasan Scale antara 50% hingga 200%
            newScale = Math.max(0.5, Math.min(newScale, 2.0));
            
            const x = parseFloat(movable.getAttribute('data-x')) || 0;
            const y = parseFloat(movable.getAttribute('data-y')) || 0;
            
            movable.setAttribute('data-scale', newScale);
            movable.style.transform = `translate(${x}px, ${y}px) scale(${newScale})`;
            
            const percent = Math.round(newScale * 100);

            // Tampilkan Indikator Zoom (Persentase)
            const sheet = movable.closest('.sheet');
            if (sheet) {
                const indicator = sheet.querySelector('.zoom-indicator');
                if (indicator) {
                    indicator.innerText = percent + '%';
                    indicator.classList.add('show');
                    
                    clearTimeout(indicator.hideTimeout);
                    indicator.hideTimeout = setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 800);
                }

                // SINKRONISASI TOMBOL ZOOM (PERBAIKAN UTAMA)
                const zoomValueBtn = sheet.querySelector('.zoom-value');
                const outBtn = sheet.querySelector('.zoom-out-btn');
                const inBtn = sheet.querySelector('.zoom-in-btn');

                if (zoomValueBtn) {
                    zoomValueBtn.innerText = percent + '%';
                    zoomValueBtn.title = `Reset (Aktual: ${percent}%)`;
                }

                if (outBtn) outBtn.disabled = newScale <= 0.5;
                if (inBtn) inBtn.disabled = newScale >= 2.0;
            }
            
            // Auto Save posisi scale baru
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveToStorage(), 500);
        }

        function handleZoomClick(btn, action) {
            const sheet = btn.closest('.sheet');
            const movable = sheet.querySelector('.layout-movable');
            if (!movable) return;

            let scale = parseFloat(movable.getAttribute('data-scale')) || 1;
            
            if (action === 'in') updateZoom(movable, scale + 0.1);
            else if (action === 'out') updateZoom(movable, scale - 0.1);
            else if (action === 'reset') updateZoom(movable, 1);
        }

        // Fitur Enterprise: Zoom dengan Ctrl + Mouse Scroll
        document.addEventListener('wheel', (e) => {
            if (e.ctrlKey) {
                // Cari sheet tempat kursor berada
                const sheet = e.target.closest('.sheet');
                if (sheet) {
                    e.preventDefault(); // Cegah zooming browser bawaan
                    
                    const movable = sheet.querySelector('.layout-movable');
                    if (movable) {
                        let scale = parseFloat(movable.getAttribute('data-scale')) || 1;
                        let delta = e.deltaY < 0 ? 0.05 : -0.05; // Scrol up = Zoom In, Scroll down = Zoom Out
                        
                        updateZoom(movable, scale + delta);
                    }
                }
            }
        }, { passive: false });
    </script>

    <!-- =========================================
         17. NEW: DUPLICATE ENGINE (ADDITIVE)
         ========================================= -->
    <script id="duplicate-engine-logic">
        // Generator ID Unik untuk memastikan page conflict tidak terjadi
        const generateUniqueId = () => Date.now() + "_" + Math.random().toString(36).substr(2, 5);

        // Core Duplicate Function (Single Page)
        async function handleDuplicateSingle(index) {
            // Sinkronisasi data DOM ke DB (Pastikan ketikan/form yang belum disave tetap terbawa)
            saveToStorage();

            const confirmed = await uxConfirm(
                "Duplicate Halaman", 
                `Apakah Anda yakin ingin menduplikat halaman ke-${index + 1}?`
            );

            if (!confirmed) return;

            uxShowLoader("Menduplikasi halaman...");
            
            setTimeout(() => {
                executeDuplicate(index);
                uxHideLoader();
            }, 300);
        }

        function executeDuplicate(index) {
            const original = pagesDB[index];
            if (!original) return;

            // Clone Object (Deep Copy untuk primitive/string, bypass resiko corrupt DOM)
            const clonedPage = {
                id: generateUniqueId(),
                type: original.type,
                html: original.html,
                rawHTML: original.rawHTML,
                layoutX: original.layoutX,
                layoutY: original.layoutY,
                layoutScale: original.layoutScale,
                orientation: original.orientation,
                paperSize: original.paperSize ? JSON.parse(JSON.stringify(original.paperSize)) : { preset: "F4", width: 215, height: 330 }, // Additive property clone
                margin: original.margin ? JSON.parse(JSON.stringify(original.margin)) : { top: 20, right: 20, bottom: 20, left: 20 }, // Additive property clone
                pageStyle: original.pageStyle ? JSON.parse(JSON.stringify(original.pageStyle)) : undefined // Additive property clone
            };

            // Insert tepat setelah halaman yang di-duplicate
            pagesDB.splice(index + 1, 0, clonedPage);

            // Simpan state & Render ulang (Sistem existing akan otomatis apply Zoom/Drag)
            localStorage.setItem(STORAGE_KEY, JSON.stringify(pagesDB));
            renderPages();

            uxToast("Halaman berhasil diduplikat!", "success");

            // Scroll dengan efek highlight ke halaman baru
            setTimeout(() => {
                const sheets = document.querySelectorAll('.sheet');
                const newSheet = sheets[index + 1];
                if (newSheet) {
                    newSheet.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Highlight transisi (Visual cue)
                    newSheet.style.transition = "box-shadow 0.5s ease";
                    newSheet.style.boxShadow = "0 0 0 5px #10b981, 0 20px 50px -12px rgba(0,0,0,0.25)";
                    setTimeout(() => {
                        newSheet.style.boxShadow = "0 20px 50px -12px rgba(0,0,0,0.25)";
                    }, 1500);
                }
            }, 100);
        }

        // Shortcut Cerdas Ctrl + D
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key.toLowerCase() === 'd') {
                e.preventDefault(); // Cegah fungsi bookmark browser bawaan

                // Cari halaman yang sedang paling fokus (paling tengah posisinya di viewport)
                const sheets = document.querySelectorAll('.sheet');
                if (sheets.length === 0) return;

                let targetIndex = -1;
                let minDistance = Infinity;
                const windowCenter = window.innerHeight / 2;

                sheets.forEach((sheet, index) => {
                    const rect = sheet.getBoundingClientRect();
                    const sheetCenter = rect.top + (rect.height / 2);
                    const distance = Math.abs(windowCenter - sheetCenter);
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        targetIndex = index;
                    }
                });

                if (targetIndex !== -1) {
                    handleDuplicateSingle(targetIndex);
                }
            }
        });

        // ================= MULTIPLE DUPLICATE SYSTEM =================
        function openDuplicateMultiModal() {
            const sheets = document.querySelectorAll('.sheet');
            if (sheets.length === 0) {
                uxToast("Tidak ada halaman untuk diduplikat.", "error");
                return;
            }

            const container = document.getElementById('duplicateCheckboxContainer');
            container.innerHTML = '';

            sheets.forEach((sheet, i) => {
                const isLandscape = sheet.classList.contains('landscape');
                const isEmbed = sheet.dataset.pageType === 'embed';
                const labelStr = `Hal ${i + 1} ` + 
                                 (isEmbed ? '[EMBED]' : '(Custom)') + 
                                 (isLandscape ? ' [Landscape]' : ' [Portrait]');

                const label = document.createElement('label');
                label.className = 'checkbox-item';
                label.innerHTML = `
                    <input type="checkbox" class="dup-multi-check" value="${i}">
                    <span>${labelStr}</span>
                `;
                container.appendChild(label);
            });

            document.getElementById('duplicateMultiModal').style.display = 'flex';
        }

        function closeDuplicateMultiModal() {
            document.getElementById('duplicateMultiModal').style.display = 'none';
        }

        function selectAllDuplicate(state) {
            document.querySelectorAll('.dup-multi-check').forEach(chk => chk.checked = state);
        }

        async function confirmDuplicateMulti() {
            const checkboxes = document.querySelectorAll('.dup-multi-check:checked');
            if (checkboxes.length === 0) {
                uxToast("Pilih minimal satu halaman.", "warning");
                return;
            }

            saveToStorage(); // Sinkronisasi sebelum clone

            const confirmed = await uxConfirm(
                "Duplicate Multiple", 
                `Anda akan menduplikat ${checkboxes.length} halaman. Hasilnya akan ditambahkan ke akhir dokumen.`
            );

            if (!confirmed) return;

            uxShowLoader("Memproses duplikasi massal...");
            closeDuplicateMultiModal();

            setTimeout(() => {
                const indexesToClone = Array.from(checkboxes).map(c => parseInt(c.value));
                let newPages = [];

                indexesToClone.forEach(idx => {
                    const original = pagesDB[idx];
                    if (original) {
                        newPages.push({
                            id: generateUniqueId(),
                            type: original.type,
                            html: original.html,
                            rawHTML: original.rawHTML,
                            layoutX: original.layoutX,
                            layoutY: original.layoutY,
                            layoutScale: original.layoutScale,
                            orientation: original.orientation,
                            paperSize: original.paperSize ? JSON.parse(JSON.stringify(original.paperSize)) : { preset: "F4", width: 215, height: 330 }, // Additive property clone
                            margin: original.margin ? JSON.parse(JSON.stringify(original.margin)) : { top: 20, right: 20, bottom: 20, left: 20 }, // Additive property clone
                            pageStyle: original.pageStyle ? JSON.parse(JSON.stringify(original.pageStyle)) : undefined // Additive property clone
                        });
                    }
                });

                // Tambahkan koleksi batch ke akhir array
                pagesDB = pagesDB.concat(newPages);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(pagesDB));
                renderPages();

                uxHideLoader();
                uxToast(`${newPages.length} halaman berhasil diduplikat!`, "success");

                // Auto-scroll ke blok duplikat yang pertama
                setTimeout(() => {
                    const sheets = document.querySelectorAll('.sheet');
                    const firstNewIndex = pagesDB.length - newPages.length;
                    if (sheets[firstNewIndex]) {
                        sheets[firstNewIndex].scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 300);

            }, 500);
        }
    </script>

    <!-- =========================================
         18. NEW: AUTO PAGE FLOW ENGINE (PROFESSIONAL)
         ========================================= -->
    <script id="auto-flow-engine">
        let isAutoFlowing = false;

        // Visual Margin Guide Toggle
        function toggleMarginGuides(btn) {
            document.body.classList.toggle('show-margin-guides');
            if(document.body.classList.contains('show-margin-guides')) {
                btn.innerHTML = '<i class="ph ph-frame-corners"></i> Sembunyikan Garis Margin';
                btn.style.background = '#e2e8f0';
            } else {
                btn.innerHTML = '<i class="ph ph-frame-corners"></i> Tampilkan Garis Margin';
                btn.style.background = '#f1f5f9';
            }
        }

        // Wrapper Trigger untuk User (Manual) & Debounced Trigger (Auto)
        async function triggerAutoFlowEngine(silent = false) {
            if (isAutoFlowing) return;
            isAutoFlowing = true;
            
            if (!silent) uxShowLoader("Menyesuaikan Layout Halaman...");

            try {
                // Tunggu sebentar agar browser selesai merender CSS terbaru (terutama jika setelah import)
                await new Promise(r => setTimeout(r, 150));
                
                // Sinkronisasi data ke DOM terbaru sebelum diproses
                saveToStorage();

                let sheets = document.querySelectorAll('.sheet[data-page-type="standard"]');
                let i = 0;
                
                // Gunakan loop While karena jumlah sheet bisa bertambah secara dinamis di tengah proses
                while (i < sheets.length) {
                    let sheet = sheets[i];
                    let didFlow = executeNodeFlow(sheet, i);
                    
                    if (didFlow) {
                        // Jika ada halaman baru ditambahkan akibat flow, perbarui NodeList
                        sheets = document.querySelectorAll('.sheet[data-page-type="standard"]');
                    }
                    i++; // Pindah ke sheet berikutnya yang sudah aman
                }

                // Simpan hasil akhir yang sudah dirapikan kembali ke memori & LocalStorage
                saveToStorage();
                updatePageNumbers();
                
                if (!silent) uxToast("Layout halaman berhasil dirapikan", "success");

            } catch (e) {
                console.error("Auto Flow Engine Error:", e);
                if (!silent) uxToast("Gagal merapikan layout otomatis", "error");
            } finally {
                isAutoFlowing = false;
                if (!silent) uxHideLoader();
            }
        }

        function debouncedAutoFlow() {
            clearTimeout(flowDebounce);
            flowDebounce = setTimeout(() => {
                triggerAutoFlowEngine(true); // silent true
            }, 1000);
        }

        function mmToPx(mm) {
            return mm * (96 / 25.4);
        }

        // --- CORE ALGORITHM: NODE-LEVEL DOM MANIPULATION ---
        function executeNodeFlow(sheet, currentIndex) {
            const movable = sheet.querySelector('.layout-movable');
            if (!movable) return false;

            // Kontainer tempat pengguna mengetik (Asumsi: .page-content. Jika tidak ada, gunakan movable)
            const contentArea = movable.querySelector('.page-content') || movable;
            if (!contentArea || contentArea.children.length === 0) return false;

            // ==========================================
            // MARGIN-AWARE LIMIT CALCULATION (UPGRADE)
            // ==========================================
            
            // Tinggi fisik kertas
            const sheetHeight = sheet.clientHeight;
            
            // Ambil margin dari attribute (mm)
            const marginTopMM = parseFloat(sheet.getAttribute("data-margin-top")) || 20;
            const marginBottomMM = parseFloat(sheet.getAttribute("data-margin-bottom")) || 20;
            
            // Konversi ke pixel
            const marginTopPx = mmToPx(marginTopMM);
            const marginBottomPx = mmToPx(marginBottomMM);
            
            // Hitung batas maksimal area konten
            const limitHeightPx = sheetHeight - marginTopPx - marginBottomPx - 5;
            
            // App Scale memengaruhi dimensi koordinat rect, kita harus menormalisasinya
            let scaleApp = 1;
            const computedStyle = window.getComputedStyle(sheet);
            const matrix = new DOMMatrixReadOnly(computedStyle.transform);
            if (matrix.a !== 1) scaleApp = matrix.a;

            const sourceRect = contentArea.getBoundingClientRect();
            const sourceTop = sourceRect.top;

            let breachIndex = -1;
            let breachNode = null;
            let isManualBreak = false;

            const children = Array.from(contentArea.children);

            // 1. ITERASI TOP-DOWN: Cari elemen pertama yang melewati batas atau meminta Page Break
            for (let i = 0; i < children.length; i++) {
                const child = children[i];
                
                // Deteksi Manual Page Break
                if (child.classList.contains('page-break') || window.getComputedStyle(child).pageBreakBefore === 'always') {
                    // Jika elemen page break ini adalah elemen pertama di halaman, JANGAN dipotong, biarkan saja
                    // (Menghindari Infinite Loop halaman kosong)
                    if (i > 0) {
                        breachIndex = i;
                        breachNode = child;
                        isManualBreak = true;
                        break;
                    }
                }

                // Deteksi Overflow Bawah
                const childRect = child.getBoundingClientRect();
                // Relative Bottom = Jarak dari atas konten (sudah dinormalkan dari scale app zoom)
                const relativeBottom = (childRect.bottom - sourceTop) / scaleApp;

                if (relativeBottom > limitHeightPx) {
                    // Jika node yang meluber ini adalah node PERTAMA di halaman,
                    // dan tidak bisa dipecah (misal gambar / no-break), kita paksakan stay agar tidak infinite loop
                    if (i === 0 && (child.tagName === 'IMG' || child.classList.contains('no-break'))) {
                        continue; 
                    }

                    breachIndex = i;
                    breachNode = child;
                    break;
                }
            }

            // Jika tidak ada pelanggaran, halaman ini aman.
            if (breachIndex === -1) return false;

            // 2. KITA MENEMUKAN PELANGGARAN. SIAPKAN HALAMAN TARGET (HALAMAN BERIKUTNYA)
            let nextSheet = sheet.nextElementSibling;
            let targetContentArea;

            // Jika halaman berikutnya tidak ada, atau tipenya embed (tidak boleh ditimpa) -> Buat halaman baru
            if (!nextSheet || nextSheet.dataset.pageType === 'embed') {
                nextSheet = createNewCustomSheet();
                
                // Clone atribut orientasi agar konsisten
                if (sheet.classList.contains('landscape')) {
                    nextSheet.classList.add('landscape');
                    const marker = document.createElement('div');
                    marker.className = 'landscape-marker';
                    marker.style.display = 'none';
                    nextSheet.insertBefore(marker, nextSheet.firstChild);
                } else if (sheet.classList.contains('portrait')) {
                    nextSheet.classList.add('portrait');
                }

                // Sisipkan tepat di bawah halaman saat ini di DOM
                sheet.parentNode.insertBefore(nextSheet, sheet.nextSibling);
                
                // Sinkronisasi DB untuk menampung halaman baru
                const newPageObj = {
                    id: nextSheet.dataset.id,
                    type: 'standard',
                    html: nextSheet.innerHTML,
                    layoutX: 0, layoutY: 0, layoutScale: 1,
                    orientation: sheet.classList.contains('landscape') ? 'landscape' : 'portrait'
                };
                pagesDB.splice(currentIndex + 1, 0, newPageObj);
            }

            targetContentArea = nextSheet.querySelector('.layout-movable .page-content');
            if (!targetContentArea) return false;

            // 3. EKSEKUSI PEMINDAHAN (SPLITTING)
            
            // Skenario A: Manual Break
            if (isManualBreak) {
                // Sembunyikan elemen break secara visual agar rapi (karena sudah berfungsi memotong)
                breachNode.style.display = 'none'; 
                
                // Pindahkan elemen break dan SEMUA elemen setelahnya ke halaman baru (di posisi teratas)
                moveSiblingsToTarget(children, breachIndex, targetContentArea);
                return true;
            }

            // Skenario B: Memecah Table Profesional (Bawa Thead)
            if (breachNode.tagName === 'TABLE' && !breachNode.classList.contains('no-break')) {
                const targetTable = splitTableAndMove(breachNode, targetContentArea, sourceTop, scaleApp, limitHeightPx);
                
                // Setelah tabel terpotong, sisa node di bawah tabel juga HARUS ikut pindah
                moveSiblingsToTarget(children, breachIndex + 1, targetContentArea);
                return true;
            }

            // Skenario C: Normal Element (P, DIV, IMG, dll) -> Pindahkan utuh (Atomic Move)
            moveSiblingsToTarget(children, breachIndex, targetContentArea);

            return true;
        }

        // Helper: Pindahkan kumpulan sibling sekaligus agar urutan HTML tidak hancur
        function moveSiblingsToTarget(childrenArray, startIndex, targetContainer) {
            // Karena kita mau memindah ke halaman 'bawahnya', kita harus taruh di bagian ATAS (prepend)
            // agar nyambung. Jadi kita insertBefore firstChild.
            
            // Buat fragment untuk optimasi (1x re-flow)
            const fragment = document.createDocumentFragment();
            for (let i = startIndex; i < childrenArray.length; i++) {
                fragment.appendChild(childrenArray[i]);
            }
            
            if (targetContainer.firstChild) {
                targetContainer.insertBefore(fragment, targetContainer.firstChild);
            } else {
                targetContainer.appendChild(fragment);
            }
        }

        // Helper: Algoritma Presisi Pemecah Tabel (Menyalin Header)
        function splitTableAndMove(sourceTable, targetContainer, sourceTop, scaleApp, limitHeightPx) {
            const targetTable = sourceTable.cloneNode(false); // Clone bungkus <table> saja
            
            // Clone thead dan colgroup jika ada (Penting untuk layout tabel presisi)
            const thead = sourceTable.querySelector('thead');
            if (thead) targetTable.appendChild(thead.cloneNode(true));
            const colgroup = sourceTable.querySelector('colgroup');
            if (colgroup) targetTable.appendChild(colgroup.cloneNode(true));

            // Siapkan target tbody
            const sourceTbody = sourceTable.querySelector('tbody') || sourceTable;
            const targetTbody = document.createElement('tbody');
            targetTable.appendChild(targetTbody);
            
            const rows = Array.from(sourceTbody.querySelectorAll('tr'));
            let breachRowIndex = -1;

            // Cari <tr> mana yang melewati batas bawah kertas
            for (let i = 0; i < rows.length; i++) {
                const tr = rows[i];
                // Jangan pecah row yang merupakan bagian dari Header (th)
                if (tr.querySelector('th') && sourceTbody === sourceTable) continue;

                const trRect = tr.getBoundingClientRect();
                const relBottom = (trRect.bottom - sourceTop) / scaleApp;
                
                if (relBottom > limitHeightPx) {
                    breachRowIndex = i;
                    break;
                }
            }

            // Pindahkan baris yang meluber ke tabel baru
            if (breachRowIndex !== -1) {
                const fragment = document.createDocumentFragment();
                for (let i = breachRowIndex; i < rows.length; i++) {
                    fragment.appendChild(rows[i]);
                }
                targetTbody.appendChild(fragment);
            } else {
                // Fallback jika perhitungan margin meleset, ambil setidaknya baris terakhir
                if (rows.length > 1) {
                    targetTbody.appendChild(rows[rows.length - 1]);
                }
            }

            // Taruh tabel baru ini di paling atas kontainer target
            if (targetContainer.firstChild) {
                targetContainer.insertBefore(targetTable, targetContainer.firstChild);
            } else {
                targetContainer.appendChild(targetTable);
            }

            return targetTable;
        }
    </script>

    <!-- =========================================
         19. NEW: PAPER SIZE LOGIC (ADDITIVE)
         ========================================= -->
    <script id="paper-size-logic">
        const PAPER_PRESETS = {
            A4: { width: 210, height: 297 },
            F4: { width: 215, height: 330 },
            Letter: { width: 216, height: 279 },
            Legal: { width: 216, height: 356 }
        };

        function openPaperSizeModal() {
            const sheets = document.querySelectorAll('.sheet');
            if(sheets.length === 0){
                uxToast("Tidak ada halaman untuk diubah ukurannya.", "error");
                return;
            }

            const dropdown = document.getElementById('paperSizePageSelect');
            dropdown.innerHTML = '';
            
            sheets.forEach((sheet, i) => {
                const option = document.createElement('option');
                option.value = i;
                
                let title = "Halaman " + (i+1);
                const content = sheet.textContent || sheet.innerText;
                if(content.includes('CUSTOM PAGE')) title += " (Custom)";
                
                const w = sheet.getAttribute('data-paper-width') || 215;
                const h = sheet.getAttribute('data-paper-height') || 330;
                const preset = sheet.getAttribute('data-paper-preset') || 'F4';
                title += ` [${preset}]`;

                option.textContent = title;
                dropdown.appendChild(option);
            });

            updatePaperSizeSelectTarget();
            dropdown.onchange = updatePaperSizeSelectTarget;

            document.getElementById('paperSizeModal').style.display = 'flex';
        }

        function updatePaperSizeSelectTarget() {
            const index = document.getElementById('paperSizePageSelect').value;
            const sheet = document.querySelectorAll('.sheet')[index];
            if(sheet) {
                const preset = sheet.getAttribute('data-paper-preset') || 'F4';
                document.getElementById('paperSizePresetSelect').value = preset;
                document.getElementById('customPaperW').value = sheet.getAttribute('data-paper-width') || 215;
                document.getElementById('customPaperH').value = sheet.getAttribute('data-paper-height') || 330;
                toggleCustomPaperInputs();
            }
        }

        function toggleCustomPaperInputs() {
            const val = document.getElementById('paperSizePresetSelect').value;
            const customDiv = document.getElementById('customPaperInputs');
            if(val === 'Custom') {
                customDiv.style.display = 'flex';
            } else {
                customDiv.style.display = 'none';
            }
        }

        function closePaperSizeModal() {
            document.getElementById('paperSizeModal').style.display = 'none';
        }

        function confirmPaperSizeChange() {
            const index = parseInt(document.getElementById('paperSizePageSelect').value);
            const preset = document.getElementById('paperSizePresetSelect').value;
            const customW = document.getElementById('customPaperW').value;
            const customH = document.getElementById('customPaperH').value;
            
            handleChangePaperSize(index, preset, customW, customH);
            closePaperSizeModal();
        }

        function handleChangePaperSize(index, preset, customW, customH) {
            const sheets = document.querySelectorAll('.sheet');
            const sheet = sheets[index];
            if (!sheet) return;

            let width, height;

            if (preset !== "Custom") {
                width = PAPER_PRESETS[preset].width;
                height = PAPER_PRESETS[preset].height;
            } else {
                width = parseFloat(customW);
                height = parseFloat(customH);
                if (!width || !height) {
                    uxToast("Lebar dan Tinggi harus diisi!", "error");
                    return;
                }
            }

            if (!pagesDB[index]) return;
            if (!pagesDB[index].paperSize) {
                pagesDB[index].paperSize = {};
            }

            pagesDB[index].paperSize = {
                preset,
                width,
                height
            };
            
            // Simpan attribute ke DOM agar saveToStorage tidak loss state
            sheet.setAttribute('data-paper-preset', preset);
            sheet.setAttribute('data-paper-width', width);
            sheet.setAttribute('data-paper-height', height);

            // Terapkan langsung ke DOM (Gunakan !important untuk override default class css jika perlu)
            if (sheet.classList.contains('landscape')) {
                sheet.style.setProperty('width', height + "mm", 'important');
                sheet.style.setProperty('min-height', width + "mm", 'important');
            } else {
                sheet.style.setProperty('width', width + "mm", 'important');
                sheet.style.setProperty('min-height', height + "mm", 'important');
            }

            // Update badge visual
            const badge = sheet.querySelector('.paper-size-badge');
            if(badge) {
                badge.innerText = `${preset} (${width}√ó${height}mm)`;
            }

            saveToStorage();
            triggerAutoFlowEngine(true); // Rapikan layout dengan batasan ukuran kertas yang baru
            uxToast(`Ukuran kertas Halaman ${index+1} diubah ke ${preset}`, "success");
            
            setTimeout(() => {
                sheet.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }
    </script>

    <!-- =========================================
         20. NEW: MARGIN LOGIC (ADDITIVE)
         ========================================= -->
    <script id="margin-logic">
        function openMarginModal() {
            const sheets = document.querySelectorAll('.sheet');
            if(sheets.length === 0){
                uxToast("Tidak ada halaman untuk diubah marginnya.", "error");
                return;
            }

            const dropdown = document.getElementById('marginPageSelect');
            dropdown.innerHTML = '';
            
            sheets.forEach((sheet, i) => {
                const option = document.createElement('option');
                option.value = i;
                
                let title = "Halaman " + (i+1);
                const content = sheet.textContent || sheet.innerText;
                if(content.includes('CUSTOM PAGE')) title += " (Custom)";
                
                option.textContent = title;
                dropdown.appendChild(option);
            });

            updateMarginSelectTarget();
            dropdown.onchange = updateMarginSelectTarget;

            document.getElementById('marginModal').style.display = 'flex';
        }

        function updateMarginSelectTarget() {
            const index = document.getElementById('marginPageSelect').value;
            const sheet = document.querySelectorAll('.sheet')[index];
            if(sheet) {
                document.getElementById('marginTopInput').value = sheet.getAttribute('data-margin-top') || 20;
                document.getElementById('marginRightInput').value = sheet.getAttribute('data-margin-right') || 20;
                document.getElementById('marginBottomInput').value = sheet.getAttribute('data-margin-bottom') || 20;
                document.getElementById('marginLeftInput').value = sheet.getAttribute('data-margin-left') || 20;
            }
        }

        function closeMarginModal() {
            document.getElementById('marginModal').style.display = 'none';
        }

        function confirmMarginChange() {
            const index = parseInt(document.getElementById('marginPageSelect').value);
            const top = document.getElementById('marginTopInput').value;
            const right = document.getElementById('marginRightInput').value;
            const bottom = document.getElementById('marginBottomInput').value;
            const left = document.getElementById('marginLeftInput').value;
            
            handleChangeMargin(index, top, right, bottom, left);
            closeMarginModal();
        }

        function handleChangeMargin(index, top, right, bottom, left) {
            const sheets = document.querySelectorAll('.sheet');
            const sheet = sheets[index];
            if (!sheet) return;

            top = parseFloat(top) || 0;
            right = parseFloat(right) || 0;
            bottom = parseFloat(bottom) || 0;
            left = parseFloat(left) || 0;

            if (!pagesDB[index]) return;
            if (!pagesDB[index].margin) {
                pagesDB[index].margin = {};
            }

            pagesDB[index].margin = { top, right, bottom, left };

            // Save attributes to DOM
            sheet.setAttribute('data-margin-top', top);
            sheet.setAttribute('data-margin-right', right);
            sheet.setAttribute('data-margin-bottom', bottom);
            sheet.setAttribute('data-margin-left', left);

            // Apply visual padding to DOM
            sheet.style.setProperty('padding-top', top + "mm", 'important');
            sheet.style.setProperty('padding-right', right + "mm", 'important');
            sheet.style.setProperty('padding-bottom', bottom + "mm", 'important');
            sheet.style.setProperty('padding-left', left + "mm", 'important');

            // Set local CSS variables for the visual margin guides
            sheet.style.setProperty('--m-top', top + "mm");
            sheet.style.setProperty('--m-right', right + "mm");
            sheet.style.setProperty('--m-bottom', bottom + "mm");
            sheet.style.setProperty('--m-left', left + "mm");

            saveToStorage();
            triggerAutoFlowEngine(true);

            uxToast(`Margin halaman ${index+1} berhasil diubah`, "success");

            setTimeout(() => {
                sheet.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }
    </script>

    <!-- =========================================
         21. NEW: TABLE ADD ROW & AUTO SPLIT LOGIC (ADDITIVE)
         ========================================= -->
    <script id="table-mode-logic">
        let currentActiveTable = null;

        // Toggle Table Mode dari Sidebar
        function toggleTableMode(btn) {
            document.body.classList.toggle('table-mode');
            
            if (document.body.classList.contains('table-mode')) {
                btn.style.background = '#a21caf';
                btn.style.color = '#ffffff';
                btn.innerHTML = '<i class="ph ph-check-circle"></i> ‚úÖ Selesai Mode Tabel';
                
                // Matikan mode drag layout jika aktif agar tidak bentrok
                if (document.body.classList.contains('layout-drag-mode')) {
                    const dragBtn = Array.from(document.querySelectorAll('aside .btn')).find(b => b.innerText.includes('Selesai Geser'));
                    if(dragBtn) toggleLayoutDragMode(dragBtn);
                }

                uxToast("Mode Tabel Aktif! Klik pada tabel untuk memunculkan opsi tambah baris.", "success");
            } else {
                btn.style.background = '#fdf4ff';
                btn.style.color = '#a21caf';
                btn.innerHTML = '<i class="ph ph-table"></i> üßæ Mode Tabel';
                removeExistingToolbar();
                currentActiveTable = null;
                uxToast("Mode Tabel Dinonaktifkan", "info");
            }
        }

        // Event Listener untuk mendeteksi klik pada tabel
        document.addEventListener('click', function(e) {
            if (!document.body.classList.contains('table-mode')) return;
            
            // Abaikan klik jika yang diklik adalah toolbar itu sendiri
            if (e.target.closest('.table-toolbar')) return;

            const table = e.target.closest('table');
            if (!table) {
                removeExistingToolbar();
                currentActiveTable = null;
                return;
            }

            showTableToolbar(table);
        });

        function removeExistingToolbar() {
            const existing = document.querySelectorAll('.table-toolbar');
            existing.forEach(tb => tb.remove());
        }

        function showTableToolbar(table) {
            if (currentActiveTable === table && document.querySelector('.table-toolbar')) return;

            removeExistingToolbar();

            const toolbar = document.createElement('div');
            toolbar.className = 'table-toolbar no-print-in-pdf';

            toolbar.innerHTML = `
                <button type="button" onclick="addTableRow()">
                    <i class="ph ph-plus-circle"></i> Tambah Baris
                </button>
            `;

            // Atur posisi relative di parent agar toolbar melayang dengan tepat
            if (window.getComputedStyle(table.parentElement).position === 'static') {
                table.parentElement.style.position = "relative";
            }
            
            table.parentElement.appendChild(toolbar);
            
            // Kalkulasi posisi di atas tabel
            toolbar.style.top = (table.offsetTop - 45) + "px";
            toolbar.style.right = "0px";

            currentActiveTable = table;
        }

        function addTableRow() {
            if (!currentActiveTable) return;

            const tbody = currentActiveTable.querySelector('tbody') || currentActiveTable;
            const rows = tbody.querySelectorAll('tr');
            if (rows.length === 0) return;
            
            // Pilih baris terakhir sebagai template clone agar style sama persis
            let templateRow = rows[rows.length - 1];
            
            const newRow = templateRow.cloneNode(true);

            // Kosongkan isi text/input
            newRow.querySelectorAll('td').forEach(cell => {
                // Jika td berisi input, kosongkan valuenya, jika text kosongkan HTMLnya
                const input = cell.querySelector('input');
                if(input) {
                    input.value = "";
                    input.setAttribute('value', "");
                } else {
                    cell.innerHTML = "&nbsp;";
                }
            });
            
            // Proteksi: Jangan duplikat jika user tidak sengaja klik tabel yang isinya hanya <th>
            if (!newRow.querySelector('td') && newRow.querySelector('th')) {
                 uxToast("Tidak bisa menambah baris pada area Header Tabel.", "warning");
                 return;
            }

            tbody.appendChild(newRow);

            // Simpan status sebelum di-split
            saveToStorage();

            // Delay kalkulasi overflow agar browser selesai me-render baris baru
            setTimeout(() => {
                checkTableOverflow(currentActiveTable);
            }, 50);
        }

        // Fungsi Helper untuk mengecek overflow spesifik baris yang baru ditambah
        function checkTableOverflow(table) {
            const sheet = table.closest('.sheet');
            if (!sheet) return;

            const computedStyle = window.getComputedStyle(sheet);
            const paddingTop = parseFloat(computedStyle.paddingTop);
            const paddingBottom = parseFloat(computedStyle.paddingBottom);

            // Hitung limit margin fisik kertas
            const limitHeightPx = sheet.clientHeight - paddingTop - paddingBottom - 5;

            let scaleApp = 1;
            const matrix = new DOMMatrixReadOnly(computedStyle.transform);
            if (matrix.a !== 1) scaleApp = matrix.a;

            // Cari batas container (page-content)
            const contentArea = sheet.querySelector('.page-content') || sheet.querySelector('.layout-movable') || sheet;
            const sourceTop = contentArea.getBoundingClientRect().top;
            const tableRect = table.getBoundingClientRect();

            // Posisi relaitf bawah tabel terhadap kanvas kertas
            const relativeBottom = (tableRect.bottom - sourceTop) / scaleApp;

            if (relativeBottom > limitHeightPx) {
                splitTableManual(table);
            }
        }

        // Fungsi Esensial: Membuat Sheet Baru (Juga memperbaiki issue di Auto Flow Engine lama)
        function createNewCustomSheet() {
            const sheet = document.createElement('div');
            sheet.className = 'sheet';
            sheet.dataset.id = Date.now() + "_" + Math.random().toString(36).substr(2, 5);
            sheet.dataset.pageType = 'standard';
            
            const stage = document.createElement('div');
            stage.className = 'layout-stage';
            
            const movable = document.createElement('div');
            movable.className = 'layout-movable';
            movable.setAttribute('data-x', '0');
            movable.setAttribute('data-y', '0');
            movable.setAttribute('data-scale', '1');
            
            const content = document.createElement('div');
            content.className = 'page-content';
            content.setAttribute('contenteditable', 'true'); 
            content.style.flex = "1";
            content.style.outline = "none";
            content.style.padding = "10px";
            
            movable.appendChild(content);
            stage.appendChild(movable);
            sheet.appendChild(stage);
            
            const pageNum = document.createElement('div');
            pageNum.className = 'page-number';
            sheet.appendChild(pageNum);

            return sheet;
        }

        function getSheetIndex(sheet) {
            return Array.from(document.querySelectorAll('.sheet')).indexOf(sheet);
        }

        // Logic Memindahkan Baris yang Meluber secara Manual
        function splitTableManual(sourceTable) {
            const sheet = sourceTable.closest('.sheet');
            if (!sheet) return;

            const nextSheet = sheet.nextElementSibling;
            let targetSheet = nextSheet;

            // Jika halaman selanjutnya tidak valid, buat halaman baru
            if (!targetSheet || targetSheet.dataset.pageType === 'embed') {
                targetSheet = createNewCustomSheet();
                
                // Wariskan atribut (Orientasi, Paper Size, Margin)
                if (sheet.classList.contains('landscape')) targetSheet.classList.add('landscape');
                if (sheet.classList.contains('portrait')) targetSheet.classList.add('portrait');
                
                targetSheet.setAttribute('data-paper-preset', sheet.getAttribute('data-paper-preset') || 'F4');
                targetSheet.setAttribute('data-paper-width', sheet.getAttribute('data-paper-width') || 215);
                targetSheet.setAttribute('data-paper-height', sheet.getAttribute('data-paper-height') || 330);
                targetSheet.setAttribute('data-margin-top', sheet.getAttribute('data-margin-top') || 20);
                targetSheet.setAttribute('data-margin-right', sheet.getAttribute('data-margin-right') || 20);
                targetSheet.setAttribute('data-margin-bottom', sheet.getAttribute('data-margin-bottom') || 20);
                targetSheet.setAttribute('data-margin-left', sheet.getAttribute('data-margin-left') || 20);

                sheet.parentNode.insertBefore(targetSheet, sheet.nextSibling);

                // Update Array Memory (pagesDB)
                pagesDB.splice(
                    getSheetIndex(sheet) + 1,
                    0,
                    {
                        id: targetSheet.dataset.id,
                        type: 'standard',
                        html: targetSheet.innerHTML,
                        layoutX: 0, layoutY: 0, layoutScale: 1,
                        orientation: sheet.classList.contains('landscape') ? 'landscape' : 'portrait',
                        paperSize: {
                            preset: sheet.getAttribute('data-paper-preset') || 'F4',
                            width: parseFloat(sheet.getAttribute('data-paper-width')) || 215,
                            height: parseFloat(sheet.getAttribute('data-paper-height')) || 330
                        },
                        margin: {
                            top: parseFloat(sheet.getAttribute('data-margin-top')) || 20,
                            right: parseFloat(sheet.getAttribute('data-margin-right')) || 20,
                            bottom: parseFloat(sheet.getAttribute('data-margin-bottom')) || 20,
                            left: parseFloat(sheet.getAttribute('data-margin-left')) || 20
                        }
                    }
                );
            }

            const targetContent = targetSheet.querySelector('.layout-movable .page-content') || targetSheet.querySelector('.layout-movable');

            // Copy Header (thead & colgroup)
            const newTable = sourceTable.cloneNode(false);
            const thead = sourceTable.querySelector('thead');
            if (thead) newTable.appendChild(thead.cloneNode(true));
            const colgroup = sourceTable.querySelector('colgroup');
            if (colgroup) newTable.appendChild(colgroup.cloneNode(true));

            // Siapkan body tabel baru
            const newTbody = document.createElement('tbody');
            newTable.appendChild(newTbody);

            // Pindahkan baris terakhir (yang meluber) ke tabel di halaman baru
            const rows = sourceTable.querySelectorAll('tbody tr');
            if (rows.length > 1) {
                newTbody.appendChild(rows[rows.length - 1]);
            }

            // Letakkan tabel lanjutan di atas kontainer halaman baru
            if (targetContent.firstChild) {
                targetContent.insertBefore(newTable, targetContent.firstChild);
            } else {
                targetContent.appendChild(newTable);
            }

            // Rapikan memory dan render ulang DOM agar sinkron
            saveToStorage();
            renderPages(); 
            
            // Scroll fokus ke tabel lanjutan
            setTimeout(() => {
                const sheets = document.querySelectorAll('.sheet');
                const newIndex = getSheetIndex(sheet) + 1;
                if (sheets[newIndex]) {
                    sheets[newIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Kembalikan toolbar otomatis ke tabel baru jika user masih di Mode Tabel
                    const newlyRenderedTable = sheets[newIndex].querySelector('table');
                    if(newlyRenderedTable && document.body.classList.contains('table-mode')) {
                        showTableToolbar(newlyRenderedTable);
                    }
                }
            }, 100);
            
            uxToast("Baris meluber! Dilanjutkan otomatis di halaman baru.", "info");
        }
    </script>

    <!-- =========================================
         22. NEW: HISTORY SHORTCUTS (ADDITIVE)
         ========================================= -->
    <script id="history-shortcuts-logic">
        document.addEventListener('keydown', function(e) {
            // Kita harus tetap membiarkan default undo jika user sedang mengetik 
            // text secara spesifik di dalam input field untuk UX yang lebih natural, 
            // tapi mengikat Shortcut Global ke sistem History pagesDB kita.
            const activeElement = document.activeElement;
            const isInput = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA');

            // Ctrl + Z (Undo)
            if (e.ctrlKey && !e.shiftKey && e.key.toLowerCase() === 'z') {
                if (!isInput) {
                    e.preventDefault();
                    handleUndo();
                }
            }

            // Ctrl + Y (Redo)
            if (e.ctrlKey && e.key.toLowerCase() === 'y') {
                if (!isInput) {
                    e.preventDefault();
                    handleRedo();
                }
            }

            // Ctrl + F (Find)
            if (e.ctrlKey && e.key.toLowerCase() === 'f') {
                e.preventDefault();
                openFindModal();
            }
        });
    </script>

    <!-- =========================================
         23. NEW: FIND & REPLACE LOGIC (ADDITIVE)
         ========================================= -->
    <script id="find-replace-logic">
        let findResults = [];
        let currentFindIndex = -1;
        let currentFindQuery = "";

        function openFindModal() {
            document.getElementById("findReplaceModal").style.display = "flex";
            
            // Highlight text sebelumnya di form input form
            const input = document.getElementById("findInput");
            input.focus();
            input.select();
        }

        function closeFindModal() {
            // Cukup sembunyikan modal, highlight tetap menyala dan state tersimpan
            document.getElementById("findReplaceModal").style.display = "none";
        }

        // Pemisahan fungsi Clear untuk Trigger Manual/Sistem
        function clearFindResults(silent = false) {
            document.querySelectorAll(".find-highlight, .find-active").forEach(el => {
                const parent = el.parentNode;
                if(parent) {
                    // Extract isinya tanpa tag span (hapus highlight)
                    parent.replaceChild(document.createTextNode(el.innerText), el);
                    parent.normalize(); // Gabungkan text node yang terpisah agar DOM rapi kembali
                }
            });

            findResults = [];
            currentFindIndex = -1;
            currentFindQuery = "";

            document.getElementById("findCounter").innerText = "";
            
            if (!silent) {
                uxToast("Highlight dibersihkan", "info");
            }
        }

        function executeFind() {
            const query = document.getElementById("findInput").value.trim();
            if (!query) return;

            // Proteksi: Cegah rendering ulang span jika mencari hal yang sama berturut-turut
            if (currentFindQuery === query && findResults.length > 0) return;

            // Selalu bersihkan pencarian lama secara diam-diam sebelum memproses yang baru
            clearFindResults(true);

            currentFindQuery = query;

            const sheets = document.querySelectorAll(".sheet");

            sheets.forEach(sheet => {
                const content = sheet.querySelector(".layout-movable");
                if(content) highlightInElement(content, query);
            });

            findResults = Array.from(document.querySelectorAll(".find-highlight"));
            
            // Redirect langsung ke hasil pertama jika ada
            if (findResults.length > 0) {
                currentFindIndex = 0;
                updateActiveResult();
            } else {
                uxToast("Teks tidak ditemukan", "warning");
            }
        }

        // FUNGSI HIGHLIGHT AMAN UNTUK CONTENTEDITABLE (MENGHINDARI TAG HTML RUSAK)
        function highlightInElement(element, query) {
            // Kita gunakan TreeWalker untuk mencari murni dari TEXT NODE (isi teks)
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                {
                    acceptNode: function(node) {
                        // Jangan sentuh area yang tidak terlihat atau di dalam input
                        const parentTag = node.parentNode.tagName;
                        if (parentTag === 'STYLE' || parentTag === 'SCRIPT' || parentTag === 'TEXTAREA' || parentTag === 'INPUT') {
                            return NodeFilter.FILTER_REJECT;
                        }
                        return NodeFilter.FILTER_ACCEPT;
                    }
                },
                false
            );

            const nodes = [];
            while (walker.nextNode()) {
                nodes.push(walker.currentNode);
            }

            // Escape string regex (hindari error jika kata yang dicari mengandung titik, kurung, dll)
            const safeQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp("(" + safeQuery + ")", "gi");

            nodes.forEach(node => {
                const text = node.nodeValue;

                if (regex.test(text)) {
                    // Buat wadah container
                    const span = document.createElement("span");
                    // Bungkus teks yang cocok dengan tag khusus
                    span.innerHTML = text.replace(regex, match => `<span class="find-highlight">${match}</span>`);
                    // Ganti teks biasa dengan HTML ini
                    node.parentNode.replaceChild(span, node);
                }
            });
        }

        function findPrevious() {
            if (findResults.length === 0) return;

            currentFindIndex--;
            if (currentFindIndex < 0) {
                currentFindIndex = findResults.length - 1; // Balik ke paling akhir jika sudah di elemen pertama
            }

            updateActiveResult();
        }

        function findNext() {
            if (findResults.length === 0) return;

            currentFindIndex++;
            if (currentFindIndex >= findResults.length) {
                currentFindIndex = 0; // Balik ke awal jika habis
            }

            updateActiveResult();
        }

        function updateActiveResult() {
            // Hapus status aktif lama
            document.querySelectorAll(".find-active")
                .forEach(el => el.classList.remove("find-active"));

            if (findResults.length === 0) return;

            // Terapkan ke hasil saat ini
            const active = findResults[currentFindIndex];
            active.classList.add("find-active");
            
            // üî• STEP 1: Cari halaman (.sheet) tempat kata berada
            const sheet = active.closest(".sheet");

            if (sheet) {
                // üî• STEP 2: Jika halaman tidak terlihat penuh di viewport ‚Üí scroll ke tengah
                const rect = sheet.getBoundingClientRect();

                if (rect.top < 0 || rect.bottom > window.innerHeight) {
                    sheet.scrollIntoView({
                        behavior: "smooth",
                        block: "center"
                    });
                }
            }

            // üî• STEP 3: Scroll ke kata secara presisi dengan sedikit delay agar rendering mulus
            setTimeout(() => {
                active.scrollIntoView({
                    behavior: "smooth",
                    block: "center"
                });

                // Tambah animasi visual glow
                active.style.transition = "box-shadow 0.3s ease";
                active.style.boxShadow = "0 0 0 3px rgba(255,165,0,0.5)";

                setTimeout(() => {
                    active.style.boxShadow = "none";
                }, 800);

            }, 200);

            // üî• Update counter
            document.getElementById("findCounter").innerText = `${currentFindIndex + 1} dari ${findResults.length}`;
        }

        function replaceOne() {
            if (findResults.length === 0) return;

            const replacement = document.getElementById("replaceInput").value;
            const active = findResults[currentFindIndex];

            const parent = active.parentNode;
            if(parent) {
                // Menghapus elemen .find-highlight dan menggantinya dengan teks langsung
                active.outerHTML = replacement;
                parent.normalize();
            }

            saveToStorage(); // Picu history untuk Undo/Redo

            // Reset query agar executeFind mendeteksi ulang indeks hasil tersisa
            currentFindQuery = ""; 
            executeFind();
        }

        function replaceAll() {
            if (findResults.length === 0) {
                currentFindQuery = "";
                executeFind();
            }
            if (findResults.length === 0) return;

            const replacement = document.getElementById("replaceInput").value;

            findResults.forEach(el => {
                const parent = el.parentNode;
                if(parent) {
                    el.outerHTML = replacement;
                    parent.normalize();
                }
            });

            saveToStorage(); // Picu history untuk Undo/Redo
            clearFindResults(true); // Silent clear
            uxToast("Semua teks berhasil diganti", "success");
        }

        // PRO UX: Shortcut Esc untuk menutup modal dengan aman
        document.addEventListener("keydown", function(e) {
            if (e.key === "Escape") {
                const modal = document.getElementById("findReplaceModal");
                if (modal && modal.style.display === "flex") {
                    closeFindModal();
                }
            }
        });
    </script>

    <!-- =========================================
         24. NEW: SMART PASTE CLEANER (ADDITIVE)
         ========================================= -->
    <script id="smart-paste-cleaner">
        document.addEventListener("paste", function(e) {
            // Pastikan event paste terjadi di dalam area konten yang bisa diedit
            const target = e.target.closest(".page-content");
            if (!target) return;

            e.preventDefault(); // Hentikan paste bawaan browser

            let clipboardData = e.clipboardData || window.clipboardData;
            let htmlData = clipboardData.getData("text/html");
            let plainText = clipboardData.getData("text/plain");

            let cleanedHTML = "";

            if (htmlData) {
                // Jika data berbentuk HTML (dari Word, Web, dll), bersihkan!
                cleanedHTML = cleanPastedHTML(htmlData);
            } else {
                // Jika hanya plain text murni (dari Notepad), format spasi dan line break-nya
                cleanedHTML = plainText
                    .replace(/\n/g, "<br>")
                    .replace(/\t/g, "&nbsp;&nbsp;&nbsp;&nbsp;");
            }

            // Masukkan HTML yang sudah steril tepat di mana kursor berada
            insertCleanHTMLAtCursor(cleanedHTML);

            // Trigger sistem penyimpanan & rapikan halaman (Auto Flow)
            if (typeof saveToStorage === "function") {
                saveToStorage();
            }

            if (typeof debouncedAutoFlow === "function") {
                debouncedAutoFlow();
            }

            if (typeof uxToast === "function") {
                uxToast("Paste dibersihkan & dinormalisasi", "success");
            }
        });

        // ========================
        // ENGINE PEMBERSIH HTML
        // ========================
        function cleanPastedHTML(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");

            // 1. Hapus tag yang tidak diperlukan (script, style global)
            doc.querySelectorAll("script, style, meta, link, title").forEach(el => el.remove());

            // --- 1Ô∏è‚É£ WHITELIST TAG FILTER ---
            // Hanya mengizinkan tag dasar, selebihnya "di-unwrap" (isinya tetap diambil)
            const allowedTags = [
                "P","BR","B","STRONG","I","EM","U",
                "UL","OL","LI",
                "TABLE","THEAD","TBODY","TR","TD","TH","COLGROUP","COL",
                "H1","H2","H3","H4","H5","H6",
                "DIV","SPAN"
            ];

            doc.body.querySelectorAll("*").forEach(el => {
                if (el.tagName && !allowedTags.includes(el.tagName.toUpperCase())) {
                    const parent = el.parentNode;
                    if (parent) {
                        // Pindahkan isi child ke luar sebelum menghapus parent-nya yang ilegal
                        while (el.firstChild) parent.insertBefore(el.firstChild, el);
                        parent.removeChild(el);
                    }
                }
            });

            // 2. Hapus SEMUA atribut kotor (style inline, class bawaan word, id)
            doc.querySelectorAll("*").forEach(el => {
                if (!el.tagName) return;

                el.removeAttribute("style");
                el.removeAttribute("class");
                el.removeAttribute("id");

                // --- 2Ô∏è‚É£ JANGAN HAPUS SEMUA data- ATTRIBUTE ---
                // --- 5Ô∏è‚É£ SECURITY SANITIZER (Hapus on*) ---
                [...el.attributes].forEach(attr => {
                    // Hapus attribute sampah dari Word
                    if (attr.name.startsWith("mso-")) {
                        el.removeAttribute(attr.name);
                    }
                    // Hapus Security Threat (XSS)
                    if (attr.name.toLowerCase().startsWith("on")) {
                        el.removeAttribute(attr.name);
                    }
                });

                // --- 3Ô∏è‚É£ PENERAPAN STYLE GLOBAL (Menghapus injeksi "inherit" yang redundant) ---
                // Biarkan CSS eksternal aplikasi yang menormalkan tampilannya
            });

            // 3. Bersihkan <span> yang kosong agar DOM tidak bengkak
            doc.querySelectorAll("span").forEach(span => {
                if (!span.textContent.trim() && span.children.length === 0) {
                    span.remove();
                }
            });

            // --- 6Ô∏è‚É£ SMART PARAGRAPH MERGE ---
            // Normalisasi paragraf Word yang kosong menjadi baris baru (br)
            doc.querySelectorAll("p").forEach(p => {
                const content = p.innerHTML.trim();
                if (content === "&nbsp;" || content === "") {
                    p.innerHTML = "<br>";
                }
            });

            // --- 4Ô∏è‚É£ TABLE NORMALIZER ---
            // Memastikan tabel yang di-paste rapi dan memiliki border/padding default
            doc.querySelectorAll("table").forEach(table => {
                table.style.borderCollapse = "collapse";
                table.querySelectorAll("td, th").forEach(cell => {
                    if (!cell.getAttribute("border")) {
                        cell.style.border = "1px solid #000";
                    }
                    cell.style.padding = "4px";
                });
            });

            // 5. Bersihkan komentar HTML buatan Word (<!--[if gte mso 9]> dll)
            const walker = document.createTreeWalker(doc, NodeFilter.SHOW_COMMENT, null, false);
            let comment;
            const commentsToRemove = [];
            while (comment = walker.nextNode()) {
                commentsToRemove.push(comment);
            }
            commentsToRemove.forEach(c => c.remove());

            return doc.body.innerHTML;
        }

        // ========================
        // INJEKSI KE KURSOR (PRESISI)
        // ========================
        function insertCleanHTMLAtCursor(html) {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            
            // Hapus jika user sedang mem-blok teks saat melakukan paste
            range.deleteContents();

            // Buat HTML menjadi DOM Fragment yang aman
            const fragment = range.createContextualFragment(html);
            
            // Masukkan ke posisi kursor
            range.insertNode(fragment);

            // Pindahkan kursor otomatis ke akhir hasil paste agar user bisa lanjut mengetik
            range.collapse(false);
            selection.removeAllRanges();
            selection.addRange(range);
        }
    </script>

    <!-- =========================================
         25. NEW: PAGE STYLE INSPECTOR LOGIC (ADDITIVE)
         ========================================= -->
    <script id="page-style-inspector">
        // 1Ô∏è‚É£ Buka Modal
        function openPageStyleModal() {
            const dropdown = document.getElementById("pageStyleSelect");
            dropdown.innerHTML = "";

            const sheets = document.querySelectorAll(".sheet");
            if (sheets.length === 0) {
                uxToast("Tidak ada halaman untuk diatur.", "error");
                return;
            }

            sheets.forEach((sheet, i) => {
                const opt = document.createElement("option");
                opt.value = i;
                
                let title = "Halaman " + (i + 1);
                const content = sheet.textContent || sheet.innerText;
                if(content.includes('CUSTOM PAGE')) title += " (Custom)";

                opt.textContent = title;
                dropdown.appendChild(opt);
            });

            loadPageStyle(0);
            dropdown.onchange = () => loadPageStyle(dropdown.value);

            document.getElementById("pageStyleModal").style.display = "flex";
        }

        // 2Ô∏è‚É£ Load Style Halaman secara spesifik
        function loadPageStyle(index) {
            const sheet = document.querySelectorAll(".sheet")[index];
            if (!sheet) return;
            const content = sheet.querySelector(".page-content");
            if (!content) return;

            const style = window.getComputedStyle(content);

            // Membersihkan string font-family dari tanda kutip bawaan browser
            let fontFamily = style.fontFamily.replace(/['"]/g, '').split(',')[0].trim();

            const fontSelect = document.getElementById("pageFontSelect");
            // Cek jika font yang aktif belum ada di dropdown, tambahkan sementara
            let fontExists = Array.from(fontSelect.options).some(opt => opt.value.toLowerCase() === fontFamily.toLowerCase());
            if (!fontExists && fontFamily) {
                const newOpt = document.createElement("option");
                newOpt.value = fontFamily;
                newOpt.textContent = fontFamily;
                fontSelect.appendChild(newOpt);
            }
            fontSelect.value = fontExists ? Array.from(fontSelect.options).find(opt => opt.value.toLowerCase() === fontFamily.toLowerCase()).value : fontFamily;

            document.getElementById("pageFontSizeInput").value = parseFloat(style.fontSize) || 16;
            document.getElementById("pageAlignSelect").value = style.textAlign || "left";
            
            // Konversi nilai line-height (bisa normal/px -> angka relatif)
            let lh = style.lineHeight;
            if (lh === "normal") {
                lh = 1.2; 
            } else {
                lh = parseFloat(lh) / parseFloat(style.fontSize);
            }
            document.getElementById("pageLineHeightInput").value = !isNaN(lh) ? lh.toFixed(1) : 1.5;

            let ls = style.letterSpacing;
            document.getElementById("pageLetterSpacingInput").value = ls === "normal" ? 0 : parseFloat(ls) || 0;
            
            document.getElementById("pageColorInput").value = rgbToHex(style.color || "rgb(0,0,0)");
        }

        // Helper RGB to HEX 
        function rgbToHex(rgb) {
            if (!rgb || rgb === 'transparent') return '#000000';
            const result = rgb.match(/\d+/g);
            if (!result || result.length < 3) return "#000000";
            return "#" + result.slice(0,3).map(x => {
                const hex = parseInt(x).toString(16);
                return hex.length === 1 ? "0" + hex : hex;
            }).join('');
        }

        // 3Ô∏è‚É£ Apply Style Ke Halaman & Memory
        function applyPageStyle() {
            const index = document.getElementById("pageStyleSelect").value;
            const sheet = document.querySelectorAll(".sheet")[index];
            if (!sheet) return;
            const content = sheet.querySelector(".page-content");
            if (!content) return;

            const font = document.getElementById("pageFontSelect").value;
            const size = document.getElementById("pageFontSizeInput").value;
            const align = document.getElementById("pageAlignSelect").value;
            const lineHeight = document.getElementById("pageLineHeightInput").value;
            const letterSpacing = document.getElementById("pageLetterSpacingInput").value;
            const color = document.getElementById("pageColorInput").value;

            // Injeksi langsung ke DOM agar instan terlihat
            content.style.fontFamily = font;
            content.style.fontSize = size + "px";
            content.style.textAlign = align;
            content.style.lineHeight = lineHeight;
            content.style.letterSpacing = letterSpacing + "px";
            content.style.color = color;

            // Simpan Attribute agar dikenali oleh saveToStorage() layaknya sistem margin
            sheet.setAttribute('data-style-font', font);
            sheet.setAttribute('data-style-size', size);
            sheet.setAttribute('data-style-align', align);
            sheet.setAttribute('data-style-lineheight', lineHeight);
            sheet.setAttribute('data-style-letterspacing', letterSpacing);
            sheet.setAttribute('data-style-color', color);

            // Simpan Data
            if (!pagesDB[index]) return;
            if (!pagesDB[index].pageStyle) pagesDB[index].pageStyle = {};

            pagesDB[index].pageStyle = { font, size, align, lineHeight, letterSpacing, color };

            saveToStorage();

            // Karena ukuran font atau line height berubah, AutoFlow perlu menyesuaikan tinggi baris yang baru
            if(typeof triggerAutoFlowEngine === 'function') triggerAutoFlowEngine(true); 

            uxToast(`Gaya Halaman ${parseInt(index) + 1} diperbarui`, "success");

            // Auto-scroll ke halaman yang diedit
            setTimeout(() => {
                sheet.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }

        function closePageStyleModal() {
            document.getElementById("pageStyleModal").style.display = "none";
        }

        // 4Ô∏è‚É£ Bold / Italic / Underline (Dengan Trigger Save)
        function togglePageBold() {
            document.execCommand("bold", false, null);
            triggerInputSave();
        }
        function togglePageItalic() {
            document.execCommand("italic", false, null);
            triggerInputSave();
        }
        function togglePageUnderline() {
            document.execCommand("underline", false, null);
            triggerInputSave();
        }

        // Helper untuk memancing auto-save saat menekan format B/I/U
        function triggerInputSave() {
            if (document.activeElement && document.activeElement.closest('.page-content')) {
                 document.activeElement.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }
    </script>

    <!-- =========================================
         26. NEW: TEXT STYLE INSPECTOR & CUSTOM FONT (ADDITIVE)
         ========================================= -->
    <script id="text-style-inspector-logic-script">
        // Auto Load Custom Fonts pada saat aplikasi dimuat
        document.addEventListener("DOMContentLoaded", function() {
            const fonts = JSON.parse(localStorage.getItem("customFonts") || "[]");
            fonts.forEach(f => {
                const fontFace = new FontFace(f.name, `url(${f.data})`);
                fontFace.load().then(font => {
                    document.fonts.add(font);
                }).catch(e => console.error("Gagal meload custom font:", f.name, e));
            });
        });

        // Event handler upload file Font
        document.getElementById("fontUploader").addEventListener("change", function(e) {
            const file = e.target.files[0];
            if (!file) return;

            uxShowLoader("Mengunggah dan Memproses Font...");

            const reader = new FileReader();
            reader.onload = function(event) {
                const fontName = file.name.replace(/\.[^/.]+$/, "");
                
                // Pengecekan apakah nama font sudah ada
                let fonts = JSON.parse(localStorage.getItem("customFonts") || "[]");
                if (fonts.some(f => f.name === fontName)) {
                    uxHideLoader();
                    uxToast("Font dengan nama ini sudah ada!", "warning");
                    e.target.value = '';
                    return;
                }

                const fontFace = new FontFace(fontName, `url(${event.target.result})`);

                fontFace.load().then(function(loadedFont){
                    document.fonts.add(loadedFont);

                    // Simpan ke storage untuk digunakan kembali nanti
                    fonts.push({
                        name: fontName,
                        data: event.target.result
                    });
                    
                    try {
                        localStorage.setItem("customFonts", JSON.stringify(fonts));
                        loadFontDropdown();
                        uxToast("Font " + fontName + " berhasil ditambahkan!", "success");
                    } catch(err) {
                        uxToast("Gagal menyimpan font (Penyimpanan Penuh)", "error");
                        console.error(err);
                    }
                }).catch(function(error) {
                    uxToast("Gagal memuat format file font ini", "error");
                    console.error(error);
                }).finally(() => {
                    uxHideLoader();
                    e.target.value = ''; // Reset uploader state
                });
            };
            reader.readAsDataURL(file);
        });

        // Memuat font bawaan + font custom pengguna ke dalam dropdown
        function loadFontDropdown() {
            const select = document.getElementById("textFontSelect");
            if (!select) return;

            const defaultFonts = [
                "Times New Roman",
                "Arial",
                "Calibri",
                "Verdana",
                "Tahoma",
                "Courier New"
            ];

            select.innerHTML = "";

            defaultFonts.forEach(f => {
                const opt = document.createElement("option");
                opt.value = f;
                opt.textContent = f;
                select.appendChild(opt);
            });

            const customFonts = JSON.parse(localStorage.getItem("customFonts") || "[]");
            customFonts.forEach(f => {
                const opt = document.createElement("option");
                opt.value = f.name;
                opt.textContent = f.name + " (Custom)";
                select.appendChild(opt);
            });
        }

        let savedSelectionRange = null;

        // Membuka modal khusus style text & mengidentifikasi state seleksi
        function openTextStyleModal() {
            const selection = window.getSelection();
            if (!selection.rangeCount || selection.isCollapsed) {
                uxToast("Silakan blok/pilih teks di dokumen terlebih dahulu.", "warning");
                return;
            }

            // Membekukan seleksi teks pengguna saat ini
            savedSelectionRange = selection.getRangeAt(0).cloneRange();

            loadFontDropdown();

            // Analisis komputasi CSS dari kata yang sedang di-blok
            let node = savedSelectionRange.startContainer;
            if (node.nodeType === 3) { // Deteksi Node text biasa
                node = node.parentNode;
            }
            
            const style = window.getComputedStyle(node);

            // Sterilisasi tanda kutip dari atribut font-family
            let fontFamily = style.fontFamily.replace(/['"]/g, '').split(',')[0].trim();
            
            const fontSelect = document.getElementById("textFontSelect");
            let fontExists = Array.from(fontSelect.options).some(opt => opt.value.toLowerCase() === fontFamily.toLowerCase());
            
            // Tambahkan sebagai opsi jika font teridentifikasi namun belum ada di daftar
            if (!fontExists && fontFamily) {
                const newOpt = document.createElement("option");
                newOpt.value = fontFamily;
                newOpt.textContent = fontFamily;
                fontSelect.appendChild(newOpt);
            }
            fontSelect.value = fontExists ? Array.from(fontSelect.options).find(opt => opt.value.toLowerCase() === fontFamily.toLowerCase()).value : fontFamily;

            document.getElementById("textFontSizeInput").value = parseFloat(style.fontSize) || 14;
            // Memanfaatkan rgbToHex() yang ada dari page style inspector logic
            document.getElementById("textColorInput").value = typeof rgbToHex !== "undefined" ? rgbToHex(style.color || "rgb(0,0,0)") : "#000000";
            
            let ls = style.letterSpacing;
            document.getElementById("textLetterSpacingInput").value = ls === "normal" ? 0 : (parseFloat(ls) || 0);

            // Analisis block parent untuk Alignment dan Line Height
            let blockNode = node;
            const blockTags = ['P', 'DIV', 'TD', 'TH', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'LI'];
            while (blockNode && blockNode !== document.body && !blockTags.includes(blockNode.tagName)) {
                blockNode = blockNode.parentNode;
            }
            if (!blockNode || blockNode === document.body) blockNode = node;
            
            const blockStyle = window.getComputedStyle(blockNode);
            // Tangkap nilai alignment, default ke string kosong agar memakai opsi (Default) jika tidak di-set secara spesifik
            const currentAlign = blockNode.style.textAlign || blockStyle.textAlign;
            document.getElementById("textAlignSelect").value = ['left', 'center', 'right', 'justify'].includes(currentAlign) ? currentAlign : "";
            
            let lh = blockStyle.lineHeight;
            if (lh === "normal") {
                lh = 1.2; 
            } else {
                lh = parseFloat(lh) / parseFloat(blockStyle.fontSize);
            }
            document.getElementById("textLineHeightInput").value = !isNaN(lh) ? lh.toFixed(1) : "";

            document.getElementById("textStyleModal").style.display = "flex";
        }

        function closeTextStyleModal() {
            document.getElementById("textStyleModal").style.display = "none";
            savedSelectionRange = null;
        }

        // Fitur utama melilitkan tag Span (Bungkus) untuk membidik elemen spesifik
        function applyTextStyle() {
            if (!savedSelectionRange) {
                uxToast("Memori blok teks hilang. Silakan blok kembali.", "error");
                return;
            }

            // Kembalikan seleksi (berguna untuk browser tertentu yang rewel)
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(savedSelectionRange);

            const font = document.getElementById("textFontSelect").value;
            const size = document.getElementById("textFontSizeInput").value;
            const color = document.getElementById("textColorInput").value;
            const letterSpacing = document.getElementById("textLetterSpacingInput").value;
            
            const align = document.getElementById("textAlignSelect").value;
            const lineHeight = document.getElementById("textLineHeightInput").value;

            try {
                const span = document.createElement("span");
                span.style.fontFamily = font;
                span.style.fontSize = size + "px";
                span.style.color = color;
                span.style.letterSpacing = letterSpacing + "px";

                // Ekstrak konten yang dipilih secara murni tanpa merusak siblings
                const extracted = savedSelectionRange.extractContents();
                span.appendChild(extracted);
                
                // Suntik span ke dalam node asalnya
                savedSelectionRange.insertNode(span);
                
                // Terapkan pengaturan block (Alignment & Line Height) ke parent terdekat
                let blockNode = span;
                const blockTags = ['P', 'DIV', 'TD', 'TH', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'LI'];
                while (blockNode && blockNode !== document.body && !blockTags.includes(blockNode.tagName)) {
                    blockNode = blockNode.parentNode;
                }
                
                if (blockNode && blockNode !== document.body && blockNode.closest('.sheet')) {
                    if (align) blockNode.style.textAlign = align;
                    if (lineHeight) blockNode.style.lineHeight = lineHeight;
                }

                // Rekam perubahan di sistem engine
                if (typeof triggerInputSave === 'function') triggerInputSave();
                saveToStorage();
                
                // Cek kemungkinan meluber (AutoFlow) 
                if (typeof debouncedAutoFlow === 'function') debouncedAutoFlow();

                closeTextStyleModal();
                uxToast("Gaya teks spesifik diperbarui!", "success");
            } catch (e) {
                console.error("Gagal menerapkan gaya teks seleksi", e);
                uxToast("Gagal membungkus style. Coba seleksi yang lebih rata (Jangan menyilang kolom tabel).", "error");
            }
        }

        function toggleTextStyleCmd(cmd) {
            // Karena button memuat mousedown preventDefault(), seleksi di layar tidak akan pudar
            document.execCommand(cmd, false, null);
            if (typeof triggerInputSave === 'function') triggerInputSave();
            saveToStorage();
        }
    </script>

    <!-- =========================================
         27. NEW: PAGE CUSTOM FONT SYSTEM (ADDITIVE)
         ========================================= -->
    <script id="page-custom-font-system">
        // 1Ô∏è‚É£ HANDLE UPLOAD FONT
        document.getElementById("pageFontUploader").addEventListener("change", function(e){
            const file = e.target.files[0];
            if (!file) return;

            const allowedTypes = [
                "font/ttf",
                "font/otf",
                "font/woff",
                "font/woff2"
            ];

            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(ttf|otf|woff|woff2)$/i)) {
                if (typeof uxToast === "function") uxToast("Format font tidak didukung", "error");
                return;
            }

            if (typeof uxShowLoader === "function") uxShowLoader("Memproses font...");

            const reader = new FileReader();

            reader.onload = function(event) {
                const fontName = file.name.replace(/\.[^/.]+$/, "");

                const fontFace = new FontFace(
                    fontName,
                    `url(${event.target.result})`
                );

                fontFace.load().then(function(loadedFont){
                    document.fonts.add(loadedFont);

                    let fonts = JSON.parse(localStorage.getItem("customPageFonts") || "[]");

                    // Hindari duplikat
                    if (!fonts.find(f => f.name === fontName)) {
                        fonts.push({
                            name: fontName,
                            data: event.target.result
                        });

                        try {
                            localStorage.setItem("customPageFonts", JSON.stringify(fonts));
                        } catch(err) {
                            if (typeof uxToast === "function") uxToast("Penyimpanan Browser Penuh!", "error");
                            console.error("Storage full:", err);
                        }
                    }

                    refreshPageFontDropdown();
                    if (typeof uxToast === "function") uxToast("Font berhasil ditambahkan", "success");
                }).catch(function(err){
                    console.error("Gagal load font:", err);
                    if (typeof uxToast === "function") uxToast("File font korup atau tidak valid", "error");
                }).finally(() => {
                    if (typeof uxHideLoader === "function") uxHideLoader();
                    e.target.value = ''; // Reset uploader status
                });
            };

            reader.readAsDataURL(file);
        });

        // 2Ô∏è‚É£ REFRESH DROPDOWN FONT PAGE STYLE
        function refreshPageFontDropdown() {
            const select = document.getElementById("pageFontSelect");
            if (!select) return;

            const currentValue = select.value;
            select.innerHTML = "";

            // Default fonts
            const defaultFonts = [
                "Times New Roman",
                "Arial",
                "Calibri",
                "Verdana",
                "Tahoma",
                "Courier New"
            ];

            defaultFonts.forEach(f => {
                const opt = document.createElement("option");
                opt.value = f;
                opt.textContent = f;
                select.appendChild(opt);
            });

            // Custom fonts
            const customFonts = JSON.parse(localStorage.getItem("customPageFonts") || "[]");

            customFonts.forEach(f => {
                const opt = document.createElement("option");
                opt.value = f.name;
                opt.textContent = f.name + " (Custom)";
                select.appendChild(opt);
            });

            // Restore previously selected value if it exists in options
            if (currentValue && Array.from(select.options).some(o => o.value === currentValue)) {
                select.value = currentValue;
            } else if (currentValue) {
                const opt = document.createElement("option");
                opt.value = currentValue;
                opt.textContent = currentValue;
                select.appendChild(opt);
                select.value = currentValue;
            }
        }

        // 3Ô∏è‚É£ AUTO LOAD FONT SAAT PAGE LOAD
        document.addEventListener("DOMContentLoaded", function(){
            const fonts = JSON.parse(localStorage.getItem("customPageFonts") || "[]");

            fonts.forEach(f => {
                const fontFace = new FontFace(
                    f.name,
                    `url(${f.data})`
                );

                fontFace.load().then(font => {
                    document.fonts.add(font);
                }).catch(e => console.error("Gagal load font custom:", f.name, e));
            });

            refreshPageFontDropdown();
        });
    </script>
</body>
</html>
