<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Laporan Administrasi Sekolah - Ultimate Enterprise Edition</title>
    
    <!-- LIBRARIES FOR PDF GENERATION -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- LIBRARIES FOR ZIP EXPORT/IMPORT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- PHOSPHOR ICONS -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* =========================================
           1. RESET & UI SYSTEM (TAMPILAN WEB)
           ========================================= */
        :root {
            --bg-app: #f8fafc;
            --sidebar-width: 320px;
            --paper-width: 215mm; 
            --paper-height: 330mm; 
            --margin-doc: 20mm;
            --primary-dark: #0f172a;
            --accent-blue: #3b82f6;
            --danger-red: #ef4444;
            --code-purple: #8b5cf6;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            color: #334155;
        }

        body.printing {
            pointer-events: none;
            user-select: none;
        }

        body.exporting .btn-remove-page, 
        body.exporting .no-print-in-pdf,
        body.exporting .edit-badge {
            display: none !important;
        }

        .app-container {
            display: flex;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        aside {
            width: var(--sidebar-width);
            background: var(--primary-dark);
            color: #f8fafc;
            padding: 25px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #334155;
            overflow-y: auto;
            z-index: 200;
            box-shadow: 4px 0 24px rgba(0,0,0,0.15);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        aside h2 { 
            font-size: 1.1rem; 
            margin-top: 0; 
            margin-bottom: 25px;
            border-bottom: 1px solid #334155; 
            padding-bottom: 15px; 
            letter-spacing: 0.5px;
            font-weight: 600;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group { margin-bottom: 18px; }
        .control-group label { 
            display: block; 
            font-size: 0.75rem; 
            margin-bottom: 6px; 
            color: #94a3b8; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        .control-group input,
        .control-group select { 
            width: 100%; 
            padding: 10px 12px; 
            border-radius: 6px; 
            border: 1px solid #475569; 
            background: #1e293b;
            color: white;
            font-size: 0.9rem; 
            transition: all 0.2s;
            outline: none;
        }
        .control-group input:focus,
        .control-group select:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%; 
            padding: 12px; 
            margin-bottom: 10px;
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            gap: 8px;
        }
        .btn-add { 
            background: #334155; 
            color: #e2e8f0; 
            border: 1px solid #475569;
        }
        .btn-add:hover { 
            background: var(--accent-blue); 
            color: white; 
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }
        .btn-print { 
            background: #10b981; 
            color: white; 
            margin-top: 20px; 
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        .btn-print:hover { 
            background: #059669; 
            transform: translateY(-1px);
        }
        
        .btn-danger { 
            background: rgba(239, 68, 68, 0.1); 
            color: #ef4444; 
            border: 1px solid rgba(239, 68, 68, 0.3);
            margin-top: 10px;
        }
        .btn-danger:hover {
            background: #ef4444;
            color: white;
        }

        .btn-edit {
            background: #e0e7ff; 
            color: #4338ca; 
            border: 1px solid #c7d2fe; 
            margin-top: 10px;
        }
        .btn-edit:hover { background: #c7d2fe; }

        .btn-html-edit {
            background: #f3e8ff;
            color: #7e22ce;
            border: 1px solid #d8b4fe;
            margin-top: 5px;
        }
        .btn-html-edit:hover { background: #d8b4fe; }

        .btn-reset {
            background: transparent;
            color: #94a3b8;
            border: 1px dashed #475569;
            margin-top: 20px;
            font-size: 0.8rem;
        }
        .btn-reset:hover {
            background: rgba(255,255,255,0.05);
            color: #cbd5e1;
            border-color: #cbd5e1;
        }
        
        .section-divider {
            margin: 25px 0 15px 0;
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            padding-left: 10px;
        }
        .section-divider::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            background: #64748b;
            border-radius: 50%;
        }

        .menu-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 500;
            background: var(--primary-dark);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            font-size: 24px;
            display: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        .menu-toggle:active { transform: scale(0.95); }

        main {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: transparent;
            scroll-behavior: smooth;
        }

        /* =========================================
           2. RESPONSIVE LOGIC
           ========================================= */
        @media (max-width: 1024px) {
            .menu-toggle { display: flex; }
            aside {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100%;
                width: 280px;
                transform: translateX(0);
                transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            aside.active { left: 0; }
            aside.active::before {
                content: '';
                position: fixed;
                top: 0; left: 280px;
                width: 100vw; height: 100vh;
                background: rgba(0,0,0,0.5);
                z-index: -1;
            }
            main { padding-top: 80px; width: 100%; }
        }

        @media (min-width: 769px) and (max-width: 1200px) {
            .sheet { transform: scale(0.75); transform-origin: top center; margin-bottom: -200px !important; }
        }

        @media (max-width: 768px) {
            .sheet { transform: scale(0.55); transform-origin: top center; margin-bottom: -400px !important; }
            main { padding-left: 0; padding-right: 0; }
        }

        @media (min-width: 1600px) {
            main { max-width: 1800px; margin: 0 auto; }
        }

        /* =========================================
           3. DOCUMENT STYLE (TAMPILAN KERTAS)
           ========================================= */
        .sheet {
            background: white;
            width: var(--paper-width);
            min-height: var(--paper-height);
            padding: var(--margin-doc);
            margin-bottom: 40px;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.25);
            position: relative;
            font-family: 'Times New Roman', Times, serif;
            color: #000;
            line-height: 1.15;
            font-size: 12pt;
            transition: width 0.4s ease, min-height 0.4s ease, transform 0.3s ease !important;
            pointer-events: auto;
            break-inside: avoid;
        }

        [contenteditable="true"]:hover { background-color: rgba(255, 230, 0, 0.1); outline: 1px dashed #e2e8f0; cursor: text; }
        [contenteditable="true"]:focus { background-color: rgba(255, 245, 157, 0.3); outline: none; border-bottom: 2px solid var(--accent-blue); }
        
        textarea.print-safe {
            width: 100%;
            border: 1px dashed #cbd5e1;
            font-family: inherit;
            font-size: inherit;
            resize: none;
            background: transparent;
            overflow: hidden;
            min-height: 40px;
            padding: 5px;
            transition: border 0.2s;
        }
        textarea.print-safe:focus { border: 1px solid var(--accent-blue); background: #f8fafc; outline: none; }
        
        .text-center { text-align: center; }
        .text-bold { font-weight: bold; }
        .text-upper { text-transform: uppercase; }
        .full-width { width: 100%; }
        .mt-2 { margin-top: 10mm; }
        .mb-2 { margin-bottom: 10mm; }
        .text-small { font-size: 10pt; }

        .kop-surat { display: flex; align-items: center; border-bottom: 3px double #000; padding-bottom: 10px; margin-bottom: 20px; gap: 20px; }
        .kop-img { width: 80px; height: 90px; object-fit: contain; cursor: pointer; transition: opacity 0.2s; }
        .kop-img:hover { opacity: 0.7; }
        .kop-text { text-align: center; flex: 1; }
        .kop-text h3 { margin: 0; font-size: 14pt; font-weight: bold; }
        .kop-text h2 { margin: 0; font-size: 16pt; font-weight: bold; }
        .kop-text p { margin: 0; font-size: 10pt; }

        table.dinas { width: 100%; border-collapse: collapse; margin: 10px 0; }
        table.dinas th, table.dinas td { border: 1px solid #000; padding: 4px 8px; vertical-align: middle; }
        table.dinas th { background-color: #f3f4f6; text-align: center; font-weight: bold; }

        table.table-padat { width: 100%; border-collapse: collapse; font-size: 10pt; margin: 10px 0; }
        table.table-padat th, table.table-padat td { border: 1px solid #000; padding: 2px 4px; vertical-align: middle; }
        table.table-padat th { background-color: #f3f4f6; text-align: center; font-weight: bold; }
        table.table-padat input { border: none; width: 100%; text-align: center; font-family: inherit; font-size: inherit; outline: none; background: transparent; }

        .col-nilai-akhir { border-left: 2px solid #000 !important; border-right: 2px solid #000 !important; font-weight: bold; font-size: 1.1em; background: #fafafa; }

        table.table-grid { width: 100%; border-collapse: collapse; font-size: 9pt; table-layout: fixed; margin: 10px 0; page-break-inside: auto; }
        table.table-grid th, table.table-grid td { border: 1px solid #000; padding: 2px 0; text-align: center; vertical-align: middle; overflow: hidden; }
        table.table-grid th { font-size: 8pt; background: #eee; }
        table.table-grid tr { page-break-inside: avoid; }

        table.list-data { width: 100%; border: none; }
        table.list-data td { border: none; padding: 4px 0; vertical-align: top; }
        table.list-data td:first-child { width: 200px; }
        table.list-data td:nth-child(2) { width: 20px; text-align: center; }

        .program-list { list-style: none; padding: 0; margin: 0; }
        .program-list li { margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        input[type="checkbox"] { width: 16px; height: 16px; accent-color: #000; cursor: pointer; }

        .photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .photo-card { border: 1px solid #000; padding: 5px; page-break-inside: avoid; }
        .photo-placeholder { width: 100%; height: 200px; background: #f8fafc; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; border: 1px dashed #94a3b8; transition: background 0.2s; }
        .photo-placeholder:hover { background: #f1f5f9; }
        .photo-placeholder img { width: 100%; height: 100%; object-fit: cover; }
        .photo-caption { margin-top: 5px; font-size: 10pt; min-height: 20px; border-top: 1px dotted #ccc; }

        .signature-section { display: flex; justify-content: space-between; margin-top: 30px; page-break-inside: avoid; }
        .ttd-box { width: 40%; text-align: center; }
        .ttd-space { height: 80px; }
        
        .nama-ttd {
            display: inline-block;
            border-bottom: 1px solid #000;
            font-weight: bold;
            padding-bottom: 2px;
        }

        .cover-border {
            border: 3px double #000;
            height: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            text-align: center;
        }

        .page-number { position: absolute; bottom: 10mm; left: 0; right: 0; text-align: center; font-size: 9pt; color: #444; }

        /* KELAS KHUSUS LANDSCAPE */
        .sheet.landscape {
            width: 330mm !important;
            min-height: 215mm !important;
            padding: 20mm 25mm !important;
        }

        @media print {
            .sheet.landscape {
                width: 100% !important;
                min-height: 215mm !important;
                padding: 20mm 25mm !important;
                page-break-after: always;
            }
        }

        /* OVERRIDES & FIXES */
        .cover-border .text-upper, .cover-border h1, .cover-border h2, .cover-border h3, .cover-border p, .cover-border span { text-transform: none !important; }
        .data-guru, .data-kepsek, .signature-section .text-upper, .text-upper .data-guru, .text-upper .data-kepsek { text-transform: none !important; }
        
        body, .sheet, .cover-border, table, td, th, input, textarea, select, .embed-safe-zone, .embed-safe-zone * { font-family: "Times New Roman", Times, serif !important; }
        .sheet img, .embed-safe-zone img { max-width: 100%; height: auto; }
        .logo-img { width: 80px; height: auto; }

        body.global-landscape .sheet {
            width: 330mm !important;
            min-height: 215mm !important;
            padding: 20mm 25mm !important;
        }
        body.global-landscape table.table-grid, body.global-landscape table.table-padat, body.global-landscape table.dinas, body.global-landscape table.list-data, body.global-landscape p, body.global-landscape div { font-size: 10.5pt !important; line-height: 1.15 !important; }
        body.global-landscape table.table-grid th, body.global-landscape table.table-grid td { padding: 2px 1px !important; }

        @media print {
            body.global-landscape .sheet { width: 100% !important; min-height: 215mm !important; margin: 0 !important; page-break-after: always; }
        }

        /* =========================================
           4. PREMIUM EDIT MODE UI
           ========================================= */
        .sheet.editing {
            outline: 3px solid var(--accent-blue);
            box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.15);
            z-index: 100; 
            cursor: text;
        }
        .sheet.editing [contenteditable="true"]:hover {
            background-color: #fff7ed;
            outline: 1px dashed #fdba74;
            border-radius: 2px;
        }
        .edit-badge {
            position: absolute;
            top: -15px;
            left: 20px;
            background: var(--accent-blue);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            pointer-events: none;
            animation: slideDown 0.3s ease;
            z-index: 1001;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .sheet.editing .sheet-controls,
        .sheet.editing input[type="checkbox"], 
        .sheet.editing input[type="text"],
        .sheet.editing textarea {
            pointer-events: none; 
            opacity: 0.7;
        }

        /* =========================================
           5. MODERN MODAL UI (COMMON)
           ========================================= */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.45);
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(6px);
            z-index: 99999;
        }
        .modal-box {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 340px;
            box-shadow: 0 25px 60px rgba(0,0,0,.25);
            animation: fadeIn .25s ease;
            font-family: 'Segoe UI', sans-serif;
            position: relative;
        }
        .modal-box.modal-large {
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            display: flex;
            flex-direction: column;
        }
        .modal-box h3 { margin-top: 0; color: #1e293b; }
        .modal-box select { width: 100%; padding: 12px; margin: 15px 0 25px 0; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; outline: none; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: auto; }
        .modal-actions button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        
        #deleteModal .modal-actions button:first-child { background: #ef4444; color: white; }
        #deleteModal .modal-actions button:first-child:hover { background: #dc2626; }
        #editModal .modal-actions button:first-child { background: var(--accent-blue); color: white; }
        #editModal .modal-actions button:first-child:hover { background: #2563eb; }
        #htmlEditorModal .modal-actions button.btn-save-html { background: var(--code-purple); color: white; }
        #htmlEditorModal .modal-actions button.btn-save-html:hover { background: #7c3aed; }
        #htmlEditorModal .modal-actions button.btn-preview-html { background: #e0e7ff; color: #4338ca; border: 1px solid #c7d2fe; }
        #htmlEditorModal .modal-actions button.btn-preview-html:hover { background: #c7d2fe; }
        .modal-actions button:last-child { background: #e2e8f0; color: #475569; }
        .modal-actions button:last-child:hover { background: #cbd5e1; }

        .code-editor-container { flex: 1; margin: 15px 0; border: 1px solid #cbd5e1; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; background: #1e1e1e; }
        .code-textarea { flex: 1; width: 100%; padding: 20px; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 14px; line-height: 1.5; color: #d4d4d4; background: #1e1e1e; border: none; resize: none; outline: none; white-space: pre; overflow: auto; }
        .code-textarea::selection { background: #264f78; }
        .code-toolbar { padding: 8px 15px; background: #2d2d2d; border-bottom: 1px solid #404040; color: #ccc; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; }

        @keyframes fadeIn{ from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

        /* =========================================
           6. PRINT QUERY
           ========================================= */
        @media print {
            @page { size: 215mm 330mm; margin: 0; }
            body { background: white; display: block; height: auto; overflow: visible; }
            aside, .btn, .menu-toggle, .modal { display: none !important; }
            .app-container { display: block !important; height: auto !important; overflow: visible !important; }
            main { display: block !important; padding: 0; margin: 0; max-width: none; overflow: visible !important; }
            .sheet { width: 100%; min-height: 330mm; margin: 0; box-shadow: none; page-break-after: always; transform: none !important; margin-bottom: 0 !important; }
            [contenteditable="true"] { outline: none !important; background: transparent !important; border-bottom: none !important; }
            textarea.print-safe { border: none; resize: none; padding: 0; margin: 0; }
            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            input[type="checkbox"] { appearance: none; -webkit-appearance: none; width: 15px; height: 15px; border: 1px solid #000; background: #fff; display: inline-block; vertical-align: middle; }
            input[type="checkbox"]:checked { background: #000; position: relative; }
            input[type="checkbox"]:checked:after { content: '‚úì'; color: #fff; font-size: 12px; position: absolute; top: -2px; left: 1px; }
        }

        .embed-safe-zone { width: 100%; overflow: hidden; position: relative; font-family: initial; font-size: initial; line-height: initial; color: initial; }
        .sheet[data-page-type="embed"]::before { content: "RAW HTML EMBED"; position: absolute; top: 0; left: 0; background: #f1f5f9; color: #94a3b8; font-size: 9px; padding: 2px 5px; opacity: 0.5; pointer-events: none; }
        
        /* UX Toast & Loaders */
        .ux-toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 100000; display: flex; flex-direction: column; gap: 15px; pointer-events: none; }
        .ux-toast { background: white; border-left: 5px solid; padding: 16px 20px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.15), 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 12px; min-width: 300px; transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); pointer-events: auto; font-family: 'Segoe UI', sans-serif; font-size: 0.95rem; }
        .ux-toast.visible { transform: translateX(0); }
        .ux-toast.success { border-color: #10b981; } .ux-toast.error { border-color: #ef4444; } .ux-toast.info { border-color: #3b82f6; }
        .ux-toast i { font-size: 1.4rem; } .ux-toast.success i { color: #10b981; } .ux-toast.error i { color: #ef4444; } .ux-toast.info i { color: #3b82f6; }
        
        .ux-loader-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); z-index: 200000; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .ux-loader-overlay.active { opacity: 1; pointer-events: all; }
        .ux-spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
        .ux-loader-text { color: white; font-weight: 500; letter-spacing: 0.5px; font-size: 1.1rem; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .btn.ux-btn-loading { position: relative; color: transparent !important; pointer-events: none; }
        .btn.ux-btn-loading::after { content: ''; position: absolute; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        .ux-confirm-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 100001; display: none; align-items: center; justify-content: center; font-family: 'Segoe UI', sans-serif; }
        .ux-confirm-box { background: white; padding: 30px; border-radius: 16px; width: 400px; max-width: 90vw; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transform: scale(0.9); opacity: 0; transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        .ux-confirm-modal.active { display: flex; } .ux-confirm-modal.active .ux-confirm-box { transform: scale(1); opacity: 1; }
        .ux-confirm-icon { width: 48px; height: 48px; background: #fee2e2; color: #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 20px; }
        .ux-confirm-title { font-size: 1.25rem; font-weight: 700; color: #1e293b; margin: 0 0 10px 0; }
        .ux-confirm-desc { color: #64748b; margin: 0 0 25px 0; line-height: 1.5; }
        .ux-confirm-actions { display: flex; gap: 12px; justify-content: flex-end; }
        .ux-btn { padding: 10px 18px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; transition: 0.2s; }
        .ux-btn-cancel { background: #f1f5f9; color: #475569; } .ux-btn-cancel:hover { background: #e2e8f0; }
        .ux-btn-confirm { background: #ef4444; color: white; } .ux-btn-confirm:hover { background: #dc2626; }

        .ux-save-indicator { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: #0f172a; color: #e2e8f0; padding: 8px 16px; border-radius: 30px; font-size: 0.8rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 999; transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); display: flex; align-items: center; gap: 8px; }
        .ux-save-indicator.active { transform: translateX(-50%) translateY(0); }
        .ux-save-spinner { width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.2); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
    </style>
</head>
<body>

    <!-- HAMBURGER MENU BUTTON -->
    <button class="menu-toggle">‚ò∞</button>

    <!-- APP WRAPPER -->
    <div class="app-container">

        <!-- SIDEBAR -->
        <aside>
            <h2>
                <i class="ph ph-buildings" style="font-size: 24px;"></i> Admin Sekolah
            </h2>

            <!-- TOGGLE ORIENTASI KERTAS GLOBAL -->
            <div class="control-group">
                <label><i class="ph ph-arrows-out-line-horizontal"></i> Orientasi Global</label>
                <select id="global_orientation" onchange="changeOrientation(this.value)">
                    <option value="portrait">Portrait Semua (215 x 330mm)</option>
                    <option value="landscape">Landscape Semua (330 x 215mm)</option>
                </select>
            </div>

            <!-- MANAJEMEN HALAMAN TINGKAT LANJUT -->
            <div class="section-divider">Manajemen Halaman</div>
            
            <div class="control-group" style="background:#1e293b; padding:10px; border-radius:8px; margin-bottom:10px;">
                <label style="color:#e2e8f0;"><i class="ph ph-swap"></i> Tukar Posisi (Swap)</label>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <select id="swapPageA" style="font-size:0.8rem; padding:8px;"></select>
                    <span style="color:#64748b; align-self:center;">‚áÑ</span>
                    <select id="swapPageB" style="font-size:0.8rem; padding:8px;"></select>
                </div>
                <button class="btn btn-add" style="margin:0; padding:8px; font-size:0.8rem; background:#3b82f6;" onclick="applyPageSwap()">Tukar Posisi</button>
            </div>

            <div class="control-group" style="background:#1e293b; padding:10px; border-radius:8px;">
                <label style="color:#e2e8f0;"><i class="ph ph-frame-corners"></i> Orientasi Per Halaman</label>
                <select id="orientPageSelect" style="font-size:0.8rem; padding:8px; margin-bottom:5px;"></select>
                <select id="orientPageMode" style="font-size:0.8rem; padding:8px; margin-bottom:10px;">
                    <option value="portrait">Portrait</option>
                    <option value="landscape">Landscape</option>
                </select>
                <button class="btn btn-add" style="margin:0; padding:8px; font-size:0.8rem; background:#10b981;" onclick="applyPageOrientation()">Terapkan Ukuran</button>
            </div>

            <div class="section-divider">Administrasi PJP</div>
            <button class="btn btn-add" onclick="handleAddPage('program_semester', this)"><i class="ph ph-chart-bar"></i> Program Semester</button>
            <button class="btn btn-add" onclick="handleAddPage('rekap_nilai', this)"><i class="ph ph-calculator"></i> Rekap Nilai Harian</button>
            <button class="btn btn-add" onclick="handleAddPage('rekap_ujian', this)"><i class="ph ph-graduation-cap"></i> Rekap Ujian BTQ</button>
            
            <button class="btn btn-add" onclick="handleAddPage('setoran_hafalan_juz30', this)">
                <i class="ph ph-book-open"></i> Setoran Hafalan Juz 30
            </button>

            <button class="btn btn-add" onclick="handleAddPage('absensi_guru', this)"><i class="ph ph-users-three"></i> Absensi Guru (Grid)</button>
            <button class="btn btn-add" onclick="handleAddPage('absensi_siswa', this)"><i class="ph ph-student"></i> Absensi Siswa (Super)</button>
            <button class="btn btn-add" onclick="handleAddPage('hadir_ujian', this)"><i class="ph ph-pencil-simple-line"></i> Tanda Tangan Ujian</button>
            <button class="btn btn-add" onclick="handleAddPage('custom', this)"><i class="ph ph-magic-wand"></i> Halaman Custom</button>
            <button class="btn btn-add" style="border-style: dashed;" onclick="openEmbedModal()"><i class="ph ph-code"></i> Embed HTML / Code</button>

            <div class="section-divider">Actions</div>
            
            <button class="btn btn-danger" onclick="openDeleteModal()">
                <i class="ph ph-trash"></i> Hapus Halaman
            </button>

            <button class="btn btn-edit" onclick="openEditModal()">
                <i class="ph ph-pencil"></i> Edit Custom Halaman
            </button>

            <button class="btn-html-edit" onclick="openHtmlEditSelectionModal()">
                <i class="ph ph-code-block"></i> üß© Edit HTML Halaman
            </button>

            <div class="section-divider">Data Management</div>

            <button class="btn btn-add" style="background:#4f46e5; border-color:#4338ca;" onclick="exportToZip()">
                <i class="ph ph-package"></i> Export ZIP (Dengan Gambar)
            </button>
            <button class="btn btn-add" style="background:#0284c7; border-color:#3730a3;" onclick="importFromZipTrigger()">
                <i class="ph ph-file-zip"></i> Import ZIP
            </button>
            <input type="file" id="zipLoader" accept=".zip" style="display:none;" onchange="processZipImport(event)">

            <button class="btn btn-print" onclick="handleSafePrint(this)"><i class="ph ph-printer"></i> Download PDF (F4)</button>

            <button class="btn btn-reset" onclick="handleResetAllPages()"><i class="ph ph-arrows-counter-clockwise"></i> Reset Semua Halaman</button>
            
            <p style="font-size:0.7rem; color:#94a3b8; text-align:center; margin-top:20px;">
                v10.0 Enterprise ‚Ä¢ Native Embed ‚Ä¢ HTML Editor (Clean)
            </p>
        </aside>

        <!-- MAIN DOCUMENT AREA -->
        <main id="document-area"></main>
    
    </div> <!-- End App Container -->

    <!-- MODAL DELETE SYSTEM -->
    <div id="deleteModal" class="modal">
       <div class="modal-box">
            <h3>Hapus Halaman</h3>
            <p style="font-size:0.9rem; color:#64748b; margin-bottom:5px;">Pilih halaman yang ingin dihapus:</p>
            <select id="deletePageSelect"></select>
            <div class="modal-actions">
                <button onclick="handleConfirmDelete()">Hapus</button>
                <button onclick="closeDeleteModal()">Batal</button>
            </div>
       </div>
    </div>

    <!-- MODAL EDIT SYSTEM -->
    <div id="editModal" class="modal">
       <div class="modal-box">
            <h3>Edit Custom Halaman</h3>
            <p style="font-size:0.9rem; color:#64748b; margin-bottom:5px;">Pilih halaman untuk masuk mode edit:</p>
            <select id="editPageSelect"></select>
            <div class="modal-actions">
                <button onclick="handleConfirmEditMode()">‚úÖ Aktifkan Edit</button>
                <button onclick="closeEditModal()">Batal</button>
            </div>
       </div>
    </div>

    <!-- MODAL HTML SELECT SYSTEM -->
    <div id="htmlEditSelectModal" class="modal">
       <div class="modal-box">
            <h3><i class="ph ph-code-block" style="color:var(--code-purple)"></i> Edit HTML Halaman</h3>
            <p style="font-size:0.9rem; color:#64748b; margin-bottom:5px;">Pilih halaman yang ingin diedit kode sumbernya:</p>
            <select id="htmlPageSelect"></select>
            <div class="modal-actions">
                <button style="background:var(--code-purple); color:white;" onclick="handleOpenHtmlEditor()">Buka Editor</button>
                <button onclick="closeHtmlEditSelectModal()">Batal</button>
            </div>
       </div>
    </div>

    <!-- MODAL LARGE HTML EDITOR -->
    <div id="htmlEditorModal" class="modal">
       <div class="modal-box modal-large">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;"><i class="ph ph-file-code"></i> Source Code Editor</h3>
                <span id="editorPageInfo" style="font-size:0.8rem; background:#f1f5f9; padding:4px 8px; border-radius:4px; color:#64748b;">Halaman ?</span>
            </div>
            
            <div class="code-editor-container">
                <div class="code-toolbar">
                    <span>HTML / Embed Source</span>
                    <span style="font-size:0.7rem; opacity:0.7;">Auto-Sanitized ‚Ä¢ Monospace</span>
                </div>
                <textarea id="htmlCodeInput" class="code-textarea" spellcheck="false"></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn-preview-html" onclick="handlePreviewHtml()">üëÅ Preview</button>
                <button class="btn-save-html" onclick="handleSaveHtmlChange()">üíæ Simpan Perubahan</button>
                <button onclick="closeHtmlEditorModal()">Batal</button>
            </div>
       </div>
    </div>

    <!-- MODAL EMBED HTML SYSTEM -->
    <div id="embedModal" class="modal">
       <div class="modal-box" style="width: 600px; max-width: 90vw;">
            <h3>Embed HTML Code</h3>
            <p style="font-size:0.9rem; color:#64748b; margin-bottom:15px;">
                Tempel kode HTML Anda di bawah. Script tag akan dihapus otomatis demi keamanan.
            </p>
            <textarea id="embedInput" style="width:100%; height:300px; padding:10px; border:1px solid #cbd5e1; border-radius:8px; font-family:monospace; font-size:12px; resize:vertical; outline:none;" placeholder="<!-- Paste your HTML here... -->&#10;<div>&#10;  <h1>Judul Dokumen</h1>&#10;  <p>Isi dokumen...</p>&#10;</div>"></textarea>
            <div class="modal-actions" style="margin-top: 20px;">
                <button onclick="handleConfirmEmbed()" style="background: #10b981; color: white;">‚úÖ Tambahkan Halaman</button>
                <button onclick="closeEmbedModal()">Batal</button>
            </div>
       </div>
    </div>

    <!-- UX OVERLAYS -->
    <div id="uxLoader" class="ux-loader-overlay">
        <div class="ux-spinner"></div>
        <div class="ux-loader-text" id="uxLoaderText">Memproses data...</div>
    </div>
    <div id="uxToastContainer" class="ux-toast-container"></div>
    <div id="uxConfirmModal" class="ux-confirm-modal">
        <div class="ux-confirm-box">
            <div class="ux-confirm-icon"><i class="ph ph-warning"></i></div>
            <h3 class="ux-confirm-title" id="uxConfirmTitle">Konfirmasi</h3>
            <p class="ux-confirm-desc" id="uxConfirmDesc">Apakah Anda yakin ingin melakukan tindakan ini?</p>
            <div class="ux-confirm-actions">
                <button class="ux-btn ux-btn-cancel" id="uxBtnCancel">Batal</button>
                <button class="ux-btn ux-btn-confirm" id="uxBtnConfirm">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>
    <div id="uxSaveIndicator" class="ux-save-indicator">
        <div class="ux-save-spinner"></div>
        <span>Menyimpan...</span>
    </div>

    <script>
        // ================= GLOBAL STATE MANAGEMENT =================
        let pagesDB = [];
        const STORAGE_KEY = "school_pages_db";

        // ================= STORAGE HELPER FUNCTIONS =================
        function saveToStorage() {
            document.querySelectorAll('.sheet input[type="text"], .sheet input[type="number"]').forEach(el => el.setAttribute('value', el.value));
            document.querySelectorAll('.sheet textarea').forEach(el => el.innerHTML = el.value);
            document.querySelectorAll('.sheet input[type="checkbox"]').forEach(el => el.checked ? el.setAttribute('checked', 'checked') : el.removeAttribute('checked'));

            const sheets = document.querySelectorAll('.sheet');
            
            pagesDB = Array.from(sheets).map((sheet, index) => {
                const isEmbed = sheet.dataset.pageType === 'embed';
                const pageId = parseInt(sheet.dataset.id) || (Date.now() + index);
                const isLandscape = sheet.classList.contains('landscape');

                if (isEmbed) {
                    const rawStorage = sheet.querySelector('.raw-storage');
                    return {
                        id: pageId,
                        type: 'embed',
                        rawHTML: rawStorage ? rawStorage.value : '',
                        orientation: isLandscape ? 'landscape' : 'portrait'
                    };
                } else {
                    return {
                        id: pageId,
                        type: 'standard',
                        html: sheet.innerHTML,
                        orientation: isLandscape ? 'landscape' : 'portrait'
                    };
                }
            });
            
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(pagesDB));
            } catch (e) {
                console.error("Storage Full or Error", e);
            }
        }

        function loadFromStorage() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                try {
                    pagesDB = JSON.parse(data);
                    return true;
                } catch (e) {
                    console.error("Storage corrupt", e);
                    localStorage.removeItem(STORAGE_KEY);
                    return false;
                }
            }
            return false;
        }

        function resetAllPages() {
            localStorage.removeItem(STORAGE_KEY);
            pagesDB = [];
            location.reload(); 
        }

        // ================= RENDER ENGINE =================
        function renderPages() {
            const container = document.getElementById('document-area');
            container.innerHTML = '';

            pagesDB.forEach((page, index) => {
                const sheet = document.createElement('div');
                sheet.className = 'sheet';
                sheet.dataset.id = page.id || Date.now();

                if (page.type === 'embed') {
                    sheet.dataset.pageType = 'embed';
                    const rawStorage = document.createElement('textarea');
                    rawStorage.className = 'raw-storage';
                    rawStorage.style.display = 'none';
                    rawStorage.value = page.rawHTML;
                    sheet.appendChild(rawStorage);

                    const wrapper = document.createElement('div');
                    wrapper.className = 'embed-safe-zone';
                    try {
                        wrapper.innerHTML = page.rawHTML;
                        sheet.appendChild(wrapper);
                    } catch (e) {
                        wrapper.innerHTML = '<p style="color:red; text-align:center;">Gagal merender HTML Embed.</p>';
                        sheet.appendChild(wrapper);
                    }
                } else {
                    sheet.innerHTML = page.html;
                }

                if (page.orientation === 'landscape' || sheet.querySelector('.landscape-marker')) {
                    sheet.classList.add('landscape');
                } else {
                    sheet.classList.remove('landscape');
                }

                if (!sheet.querySelector('.page-number')) {
                    const pageNum = document.createElement('div');
                    pageNum.className = 'page-number';
                    sheet.appendChild(pageNum);
                }

                container.appendChild(sheet);
            });

            updatePageNumbers();
            updateAllPageSelectors();
        }

        // ================= AUTO SAVE ENGINE =================
        let saveTimeout;
        let paginationTimeout;

        document.addEventListener("input", function(e) {
            if(e.target.closest('.sheet') || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                if (e.target.closest('.page-content')) {
                    clearTimeout(paginationTimeout);
                    paginationTimeout = setTimeout(() => {
                        autoPaginateCustomPages();
                    }, 1000);
                }

                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    saveToStorage();
                    if (e.target.closest('.page-content')) {
                         autoPaginateCustomPages();
                    }
                }, 500); 
            }
        });

        // ================= EMBED ARCHITECTURE =================
        function cleanHTML(htmlString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');

            const bannedTags = ['script', 'iframe', 'object', 'embed', 'form']; 
            bannedTags.forEach(tag => {
                doc.querySelectorAll(tag).forEach(el => el.remove());
            });

            const allElements = doc.body.querySelectorAll('*');
            allElements.forEach(el => {
                Array.from(el.attributes).forEach(attr => {
                    // Safe guard to prevent our own auto calculation scripts from being purged on edit
                    if (attr.name.startsWith('on')) {
                        const val = attr.value;
                        const allowed = ['calculateScore(this)', 'calculateExamScore(this)', 'calculateSetoranRow(this)', 'triggerUpload(this)', 'previewImage(this)'];
                        if (!allowed.includes(val)) {
                            el.removeAttribute(attr.name);
                        }
                    }
                });
            });
            return doc.body.innerHTML;
        }

        function addEmbedPage(userHTML) {
            try {
                const safeContent = cleanHTML(userHTML);
                const newPage = {
                    id: Date.now(),
                    type: 'embed',
                    rawHTML: safeContent
                };
                pagesDB.push(newPage);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(pagesDB));
                renderPages();

                setTimeout(() => {
                    const newSheet = document.getElementById('document-area').lastElementChild;
                    if(newSheet) newSheet.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);

                if (window.innerWidth <= 1024) sidebar.classList.remove('active');
            } catch (err) {
                console.error(err);
                alert("Gagal membuat halaman embed. Periksa kode HTML Anda.");
            }
        }

        function openEmbedModal() {
            document.getElementById('embedInput').value = ''; 
            document.getElementById('embedModal').style.display = 'flex';
            setTimeout(() => document.getElementById('embedInput').focus(), 100);
        }

        function closeEmbedModal() {
            document.getElementById('embedModal').style.display = 'none';
        }

        function handleConfirmEmbed() {
            const code = document.getElementById('embedInput').value;
            if(!code || code.trim().length < 5) {
                alert("Kode HTML terlalu pendek.");
                return;
            }
            addEmbedPage(code);
            closeEmbedModal();
        }

        // ================= SYSTEM CORE UI UPDATE =================
        function openDeleteModal() {
            const sheets = document.querySelectorAll('.sheet');
            if(sheets.length === 0){
                uxToast("Tidak ada halaman untuk dihapus.", "error");
                return;
            }
            updateAllPageSelectors();
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }

        function updateAllPageSelectors() {
            const dropdown = document.getElementById('deletePageSelect');
            if(!dropdown) return;

            dropdown.innerHTML = '';
            document.querySelectorAll('.sheet').forEach((sheet, i)=>{
                const option = document.createElement('option');
                option.value = i;
                
                let title = "Halaman " + (i+1);
                const content = sheet.textContent || sheet.innerText;
                const isEmbed = sheet.dataset.pageType === 'embed';

                if(content.includes('LAPORAN KEGIATAN')) title += " (Laporan)";
                else if(content.includes('DOKUMENTASI')) title += " (Foto)";
                else if(content.includes('JADWAL')) title += " (Jadwal)";
                else if(content.includes('REKAP NILAI')) title += " (Nilai)";
                else if(content.includes('REKAP SETORAN HAFALAN')) title += " (Hafalan)";
                else if(content.includes('ABSENSI')) title += " (Absen)";
                else if(content.includes('PROGRAM KEGIATAN')) title += " (Program)";
                else if(content.includes('CUSTOM PAGE')) title += " (Custom)";
                
                if(isEmbed) title += " [EMBED]";
                
                option.textContent = title;
                dropdown.appendChild(option);
            });

            const sourceHTML = dropdown.innerHTML;
            ['swapPageA', 'swapPageB', 'orientPageSelect', 'editPageSelect', 'htmlPageSelect'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = sourceHTML;
            });
        }

        function handleConfirmDelete() {
            const index = parseInt(document.getElementById('deletePageSelect').value);
            const sheets = document.querySelectorAll('.sheet');

            if(isNaN(index) || index < 0 || index >= sheets.length) return;

            const sheet = sheets[index];
            sheet.style.transition = "all .25s ease";
            sheet.style.opacity = "0";
            sheet.style.transform = "scale(.9)";

            setTimeout(() => {
                sheet.remove();
                saveToStorage();
                updatePageNumbers(); 
                updateAllPageSelectors();
                uxToast("Halaman dihapus", "info");
            }, 250);
            
            closeDeleteModal();
        }

        // ================= PDF ENGINE =================
        async function safePrint(){
            const { jsPDF } = window.jspdf;
            const sheets = document.querySelectorAll('.sheet');

            if(!sheets.length){
                alert('Tidak ada halaman untuk didownload!');
                return;
            }

            document.body.classList.add('exporting');
            void document.body.offsetHeight;

            try {
                const isGlobalLandscape = document.body.classList.contains('global-landscape');
                const firstIsLandscape = isGlobalLandscape || sheets[0].classList.contains('landscape');
                
                const pdf = new jsPDF({
                    orientation: firstIsLandscape ? 'landscape' : 'portrait',
                    unit: 'mm',
                    format: firstIsLandscape ? [330, 215] : [215, 330] 
                });

                for(let i=0; i<sheets.length; i++){
                    const isPageLandscape = isGlobalLandscape || sheets[i].classList.contains('landscape');
                    
                    const canvas = await html2canvas(sheets[i], {
                        scale: 2,
                        useCORS: true,
                        logging: false
                    });

                    const imgData = canvas.toDataURL('image/jpeg', 1.0);

                    if(i !== 0){
                        pdf.addPage(isPageLandscape ? [330, 215] : [215, 330], isPageLandscape ? 'landscape' : 'portrait');
                    }

                    if (isPageLandscape) {
                        pdf.addImage(imgData, 'JPEG', 0, 0, 330, 215);
                    } else {
                        pdf.addImage(imgData, 'JPEG', 0, 0, 215, 330);
                    }
                }
                pdf.save('Laporan-Sekolah.pdf');
            } catch (error) {
                console.error("PDF Generation Error:", error);
                alert("Gagal membuat PDF. Coba refresh halaman.");
            } finally {
                document.body.classList.remove('exporting');
            }
        }

        // ================= UI LOGIC =================
        const menuToggle = document.querySelector('.menu-toggle');
        const sidebar = document.querySelector('aside');
        
        menuToggle.addEventListener('click', () => sidebar.classList.toggle('active'));

        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 1024) {
                if (!sidebar.contains(e.target) && !menuToggle.contains(e.target) && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                }
            }
        });

        // ================= DATA LOGIC =================
        function calculateScore(row) {
            const getVal = (cls) => {
                const el = row.querySelector('.' + cls);
                return el ? (parseFloat(el.innerText.replace(/,/g, '.')) || 0) : 0;
            };
            const s1 = getVal('score-lancar'), s2 = getVal('score-tajwid'), s3 = getVal('score-irama'), s4 = getVal('score-adab');
            const total = s1 + s2 + s3 + s4;
            const totalEl = row.querySelector('.score-total'), finalEl = row.querySelector('.score-final');
            if(totalEl) totalEl.innerText = total;
            if(finalEl) finalEl.innerText = total;
        }

        function calculateExamScore(row) {
            const getVal = (cls) => {
                const el = row.querySelector('.' + cls);
                return el ? (parseFloat(el.innerText.replace(/,/g, '.')) || 0) : 0;
            };
            const s1 = getVal('exam-lancar'), s2 = getVal('exam-tajwid'), s3 = getVal('exam-irama'), s4 = getVal('exam-adab');
            const total = s1 + s2 + s3 + s4;
            const finalEl = row.querySelector('.exam-final');
            if(finalEl) finalEl.innerText = total;
        }

        function calculateSetoranRow(checkbox) {
            const row = checkbox.closest('tr');
            if(!row) return;
            const checkboxes = row.querySelectorAll('input[type="checkbox"]');
            let total = 0;
            checkboxes.forEach(cb => { if(cb.checked) total++; });
            const totalEl = row.querySelector('.total-setor');
            if(totalEl) totalEl.innerText = total;
        }

        function addPage(type) {
            const htmlContent = templates[type];
            if (!htmlContent) return;

            pagesDB.push({ id: Date.now(), type: 'standard', html: htmlContent });
            renderPages();
            saveToStorage();
            
            const newSheet = document.getElementById('document-area').lastElementChild;
            if(newSheet) newSheet.scrollIntoView({ behavior: 'smooth', block: 'start' });

            if (window.innerWidth <= 1024) sidebar.classList.remove('active');
        }

        function updatePageNumbers() {
            document.querySelectorAll('.page-number').forEach((el, index) => { el.innerText = `- ${index + 1} -`; });
        }

        function triggerUpload(el) { el.querySelector('input').click(); }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = input.parentElement.querySelector('img');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    saveToStorage();
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ================= PREMIUM EDIT ENGINE =================
        function toggleEditMode(sheet) {
            document.querySelectorAll('.sheet').forEach(s => { if (s !== sheet) deactivateEditMode(s); });
            if (sheet.classList.contains('editing')) deactivateEditMode(sheet);
            else activateEditMode(sheet);
        }

        function activateEditMode(sheet) {
            sheet.classList.add('editing');
            const badge = document.createElement('div');
            badge.className = 'edit-badge';
            badge.innerText = '‚úèÔ∏è EDITING MODE';
            sheet.appendChild(badge);

            const textElements = sheet.querySelectorAll('p, span, td, th, div, h1, h2, h3, h4, h5, h6, li, u, b, strong, em');
            textElements.forEach(el => {
                if (el.closest('.sheet-controls') || el.closest('.page-number') || el.closest('.photo-placeholder') || el.classList.contains('edit-badge') || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT' || el.contentEditable === 'true') {
                    return;
                }
                if(el.children.length === 0 || el.tagName === 'DIV' || el.tagName === 'TD') el.setAttribute('contenteditable', 'true');
            });
        }

        function deactivateEditMode(sheet) {
            sheet.classList.remove('editing');
            const badge = sheet.querySelector('.edit-badge');
            if(badge) badge.remove();

            sheet.querySelectorAll('[contenteditable="true"]').forEach(el => {
                if(['P','H1','H2','H3','H4','H5','H6','SPAN','LI','DIV'].includes(el.tagName)) el.removeAttribute('contenteditable');
            });
            saveToStorage();
        }

        function openEditModal() {
            const sheets = document.querySelectorAll('.sheet');
            if(sheets.length === 0) {
                uxToast("Belum ada halaman untuk diedit.", "error");
                return;
            }
            updateAllPageSelectors();
            document.getElementById('editModal').style.display = 'flex';
        }

        function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }

        function handleConfirmEditMode() {
            const index = parseInt(document.getElementById('editPageSelect').value);
            const sheets = document.querySelectorAll('.sheet');
            
            if(!isNaN(index) && sheets[index]) {
                toggleEditMode(sheets[index]);
                sheets[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
                uxToast("Mode Edit Diaktifkan", "info");
            }
            closeEditModal();
        }

        document.addEventListener('dblclick', function(e) {
            const sheet = e.target.closest('.sheet');
            if (sheet && !e.target.closest('.sheet-controls') && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                toggleEditMode(sheet);
            }
        });

        // ================= AUTO PAGINATION =================
        function autoPaginateCustomPages() {
            const sheets = document.getElementsByClassName('sheet'); 
            const MAX_HEIGHT_PX = 330 * 3.78; 

            for (let i = 0; i < sheets.length; i++) {
                const sheet = sheets[i];
                const content = sheet.querySelector('.page-content');
                if (!content) continue; 

                while (sheet.scrollHeight > (MAX_HEIGHT_PX + 5)) {
                    const lastChild = content.lastElementChild;
                    if (!lastChild || content.children.length <= 1) break; 

                    let nextSheet = sheet.nextElementSibling;
                    let nextContent;

                    if (nextSheet && nextSheet.querySelector('.page-content')) {
                          nextContent = nextSheet.querySelector('.page-content');
                    } else {
                        nextSheet = createNewCustomSheet();
                        sheet.parentNode.insertBefore(nextSheet, sheet.nextSibling);
                        nextContent = nextSheet.querySelector('.page-content');
                    }

                    if (nextContent.firstChild) nextContent.insertBefore(lastChild, nextContent.firstChild);
                    else nextContent.appendChild(lastChild);
                }
            }
            updatePageNumbers();
        }

        function createNewCustomSheet() {
            const div = document.createElement('div');
            div.className = 'sheet';
            div.dataset.id = Date.now() + Math.random(); 
            div.innerHTML = templates.custom; 
            const content = div.querySelector('.page-content');
            if(content) content.innerHTML = ''; 
            return div;
        }

        // ================= TEMPLATES (Natively Editable Without syncData) =================
        const getKop = () => `
            <div class="kop-surat">
                <div class="kop-img" onclick="triggerUpload(this)" title="Klik untuk ganti logo">
                    <img src="https://via.placeholder.com/100x120?text=LOGO" alt="Logo" style="width:100%; height:100%; object-fit:contain;">
                    <input type="file" accept="image/*" style="display:none" onchange="previewImage(this)">
                </div>
                <div class="kop-text">
                    <h3>PEMERINTAH KOTA BANJAR</h3>
                    <h3>DINAS PENDIDIKAN DAN KEBUDAYAAN</h3>
                    <h2 class="data-sekolah" contenteditable="true" spellcheck="false">UPTD SD NEGERI 1 BATULAWANG</h2>
                    <p class="data-alamat" contenteditable="true" spellcheck="false">Alamat Sekolah Here</p>
                    <p>Email: sdn1batulawang@banjarkota.go.id</p>
                </div>
            </div>
        `;

        const getTTD = (jabatan = "Guru PJP PAI") => `
            <div class="signature-section">
                <div class="ttd-box">
                    <p>Mengetahui,<br>Kepala Sekolah</p>
                    <div class="ttd-space"></div>
                    <p class="text-upper data-kepsek format-ttd" contenteditable="true" spellcheck="false"><span class="nama-ttd">NAMA KEPALA</span></p>
                    <p>NIP. <span class="data-nip1" contenteditable="true" spellcheck="false">...</span></p>
                </div>
                <div class="ttd-box">
                    <p>Banjar, <span contenteditable="true" class="data-tgl" spellcheck="false">...</span><br>${jabatan}</p>
                    <div class="ttd-space"></div>
                    <p class="text-upper data-guru format-ttd" contenteditable="true" spellcheck="false"><span class="nama-ttd">NAMA GURU</span></p>
                    <p>NIP. <span class="data-nip2" contenteditable="true" spellcheck="false">...</span></p>
                </div>
            </div>
        `;

        const get31DaysHeader = () => { let cols = ''; for(let i=1; i<=31; i++) cols += `<th>${i}</th>`; return cols; };
        const get31DaysCells = () => { let cols = ''; for(let i=1; i<=31; i++) cols += `<td contenteditable="true"></td>`; return cols; };

        const templates = {
            custom: `
                <div style="min-height: 100%; display: flex; flex-direction: column;">
                    <div class="text-center text-bold" style="margin-bottom: 20px; font-size: 14pt;">CUSTOM PAGE</div>
                    <div class="page-content" contenteditable="true" style="flex: 1; outline: none; border: 1px dashed #e2e8f0; padding: 10px;">
                        <p>Silakan ketik atau tempel konten Anda di sini...</p><p>&nbsp;</p>
                    </div>
                    <div class="page-number"></div>
                </div>
            `,
            laporan_convert: `
                ${getKop()}
                <div class="text-center" style="margin-bottom:20px;">
                    <h3 class="text-bold" style="text-decoration: underline;">LAPORAN PELAKSANAAN KEGIATAN</h3>
                    <p>Nomor: 421.2/...../SD/..../2025</p>
                </div>
                <div style="margin-bottom: 15px; text-align: justify;">
                    <p class="text-bold">A. PENDAHULUAN</p>
                    <div contenteditable="true" style="margin-left: 20px;">
                        <p>Puji syukur ke hadirat Allah SWT, berkat rahmat dan karunia-Nya, kami dapat menyelesaikan penyusunan laporan kegiatan ini.</p>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <p class="text-bold">B. DATA PELAKSANA</p>
                    <table class="list-data" style="margin-left: 20px;">
                        <tr><td width="150">Nama</td><td>:</td><td class="data-guru text-bold" contenteditable="true" spellcheck="false">NAMA GURU</td></tr>
                        <tr><td>NIP</td><td>:</td><td class="data-nip2" contenteditable="true" spellcheck="false">...</td></tr>
                        <tr><td>Jabatan</td><td>:</td><td contenteditable="true">Guru PJP PAI</td></tr>
                        <tr><td>Unit Kerja</td><td>:</td><td class="data-sekolah" contenteditable="true" spellcheck="false">NAMA SEKOLAH</td></tr>
                    </table>
                </div>
                <div style="margin-bottom: 15px;">
                    <p class="text-bold">C. HASIL KEGIATAN</p>
                    <table class="dinas">
                        <thead><tr><th width="5%">No</th><th width="30%">Nama Kegiatan</th><th width="20%">Waktu</th><th width="45%">Hasil / Output</th></tr></thead>
                        <tbody>
                            <tr><td class="text-center">1</td><td contenteditable="true">Bimbingan BTQ</td><td contenteditable="true">Setiap Hari</td><td contenteditable="true">Siswa lancar baca Iqra</td></tr>
                        </tbody>
                    </table>
                </div>
                <div style="flex:1"></div>
                ${getTTD()}
                <div class="page-number"></div>
            `,
            cover: `
                <div class="cover-border">
                    <div class="mt-2">
                        <h2 class="text-bold" contenteditable="true">LAPORAN KEGIATAN</h2>
                        <h2 class="text-bold" contenteditable="true">GURU PENAMBAHAN JAM PELAJARAN PAI</h2>
                        <h3 class="text-bold" contenteditable="true">TAHUN PELAJARAN 2025/2026</h3>
                    </div>
                    <div>
                        <h3 class="text-bold data-sekolah" contenteditable="true" spellcheck="false">UPTD SD NEGERI 1 BATULAWANG</h3>
                        <h3 class="text-bold text-upper data-tgl" contenteditable="true" spellcheck="false">BULAN ...</h3>
                    </div>
                    <div style="width:150px; height:180px; margin:0 auto; cursor:pointer;" onclick="triggerUpload(this)" title="Klik Ganti Logo">
                        <img src="https://via.placeholder.com/150x180?text=LOGO+BESAR" style="width:100%; height:100%; object-fit:contain;">
                        <input type="file" accept="image/*" style="display:none" onchange="previewImage(this)">
                    </div>
                    <div>
                        <p>DISUSUN OLEH :</p>
                        <h3 class="text-bold text-upper data-guru" contenteditable="true" spellcheck="false">NAMA GURU</h3>
                        <p class="data-nip2" contenteditable="true" spellcheck="false">NIP ...</p>
                    </div>
                    <div class="mb-2">
                        <h3 class="text-bold">PEMERINTAH KOTA BANJAR</h3>
                        <h3 class="text-bold">DINAS PENDIDIKAN DAN KEBUDAYAAN</h3>
                        <h3 class="text-bold" contenteditable="true">TAHUN 2025</h3>
                    </div>
                </div>
                <div class="page-number"></div>
            `,
            laporan: `
                <div style="min-height:100%; display:flex; flex-direction:column; font-family:'Times New Roman'; font-size:12pt; line-height:1.2;">
                    ${getKop()}
                    <div style="text-align:center; margin-bottom:15px;">
                        <div style="font-weight:bold;">LAPORAN KEGIATAN</div>
                        <div style="font-weight:bold;">TENAGA PENDIDIK PELAKSANA PENAMBAHAN JAM PELAJARAN (PJP)</div>
                        <div style="font-weight:bold;">PENDIDIKAN AGAMA ISLAM (PAI)</div>
                    </div>
                    <div style="flex:1;">
                        <table style="width:100%; margin-bottom:15px; border-collapse:collapse;">
                            <tr><td style="width:120px;">Nama</td><td>:</td><td class="data-guru text-bold" contenteditable="true" spellcheck="false">NAMA GURU</td></tr>
                            <tr><td>Sekolah</td><td>:</td><td class="data-sekolah" contenteditable="true" spellcheck="false">NAMA SEKOLAH</td></tr>
                            <tr><td>Kelas</td><td>:</td><td contenteditable="true">V (Lima)</td></tr>
                        </table>
                        <table style="width:100%; border-collapse:collapse;">
                            <tr><td style="width:280px; vertical-align:top;"><b>1. Jumlah Peserta Didik (PD) yang Dihadapi</b></td><td><b>:</b></td><td><div contenteditable="true"><p>a. Kelas V = 10 Orang Siswa</p></div></td></tr>
                        </table>
                    </div>
                    <div style="margin-top:50px;">${getTTD("Guru PJP PAI")}</div>
                    <div class="page-number"></div>
                </div>
            `,
            foto: `
                <div class="text-center text-bold" style="margin-bottom:15px; border-bottom:1px solid #000; padding-bottom:10px;">
                    <h3 contenteditable="true">LAPORAN DOKUMENTASI KEGIATAN</h3>
                    <p class="data-tgl" contenteditable="true" style="font-size:10pt; font-weight:normal;">...</p>
                </div>
                <div class="photo-grid">
                    ${Array(6).fill(0).map((_, i) => `<div class="photo-card"><div class="photo-placeholder" onclick="triggerUpload(this)"><img src="" alt="Klik Upload" style="display:none;"><span style="color:#999; font-size:10pt;">+ Foto ${i+1}</span><input type="file" accept="image/*" style="display:none" onchange="previewImage(this)"></div><div class="photo-caption" contenteditable="true">Kegiatan Siswa ${i+1}...</div></div>`).join('')}
                </div>
                <div class="page-number"></div>
            `,
            jadwal: `
                ${getKop()}
                <div class="text-center" style="margin-bottom:20px;">
                    <h3 class="text-bold" contenteditable="true">JADWAL ASESMEN SUMATIF<br>AKHIR SEMESTER GANJIL</h3>
                </div>
                <table class="dinas">
                    <thead><tr><th width="5%">No</th><th width="20%">Hari / Tanggal</th><th width="10%">Jam Ke</th><th width="15%">Pukul</th><th width="35%">Mata Pelajaran</th><th width="15%">Ket</th></tr></thead>
                    <tbody>${Array(5).fill(0).map((_, i) => `<tr><td class="text-center">${i+1}</td><td contenteditable="true">Senin, ...</td><td class="text-center" contenteditable="true">1</td><td class="text-center" contenteditable="true">07.30 - 09.00</td><td contenteditable="true">PAI</td><td contenteditable="true"></td></tr>`).join('')}</tbody>
                </table>
                <div style="flex:1"></div>
                ${getTTD()}
                <div class="page-number"></div>
            `,
            rekap_nilai: `
                <div class="text-center text-bold" style="margin-bottom:15px; text-transform:uppercase; line-height:1.5;">
                    <h3 contenteditable="true">REKAP NILAI HARIAN BTQ SISWA KELAS V (LIMA)</h3>
                    <h3 class="data-sekolah" contenteditable="true" spellcheck="false">UPTD SD NEGERI ...</h3>
                </div>
                <table class="table-padat">
                    <thead>
                        <tr><th rowspan="2" width="4%">No</th><th rowspan="2" width="10%">NISN</th><th rowspan="2" width="20%">Nama Siswa</th><th colspan="4">Komponen Penilaian</th><th rowspan="2" width="5%">Jml</th><th rowspan="2" width="5%">NA</th><th rowspan="2" width="15%">Deskripsi</th><th colspan="3" width="9%">Absensi</th></tr>
                        <tr><th width="6%">Lancar</th><th width="6%">Tajwid</th><th width="6%">Irama</th><th width="6%">Adab</th><th width="3%">S</th><th width="3%">I</th><th width="3%">A</th></tr>
                    </thead>
                    <tbody>
                        ${Array(20).fill(0).map((_, i) => `<tr oninput="calculateScore(this)"><td class="text-center">${i+1}</td><td contenteditable="true"></td><td contenteditable="true">Nama Siswa ${i+1}</td><td contenteditable="true" class="text-center score-lancar">0</td><td contenteditable="true" class="text-center score-tajwid">0</td><td contenteditable="true" class="text-center score-irama">0</td><td contenteditable="true" class="text-center score-adab">0</td><td class="text-center text-bold score-total" style="background:#f1f5f9;">0</td><td class="text-center text-bold score-final" style="background:#f1f5f9;">0</td><td contenteditable="true" style="font-size:8pt;">Sangat Baik</td><td contenteditable="true" class="text-center">-</td><td contenteditable="true" class="text-center">-</td><td contenteditable="true" class="text-center">-</td></tr>`).join('')}
                    </tbody>
                </table>
                <div style="margin-top:20px; text-align:right;">
                    <div style="display:inline-block; width:200px; text-align:center;">
                        <p>Banjar, <span contenteditable="true" class="data-tgl">...</span></p><p>Guru BTQ</p><br><br><br>
                        <p class="text-upper data-guru format-ttd" contenteditable="true" spellcheck="false"><span class="nama-ttd">Nama Guru</span></p>
                    </div>
                </div>
                <div class="page-number"></div>
            `,
            rekap_ujian: `
                ${getKop()}
                <div class="text-center text-bold text-upper" style="margin-bottom:20px;">
                    <h3 contenteditable="true">REKAPITULASI HASIL UJIAN BACA TULIS AL-QURAN</h3>
                    <h3 class="data-sekolah" contenteditable="true" spellcheck="false">UPTD SD NEGERI ...</h3>
                </div>
                <table class="dinas">
                    <thead><tr><th width="5%">No</th><th width="25%">Nama Siswa</th><th width="10%">Kelancaran (30)</th><th width="10%">Tajwid (40)</th><th width="10%">Irama (20)</th><th width="10%">Adab (10)</th><th width="10%" class="col-nilai-akhir">Nilai Akhir</th><th width="20%">Keterangan</th></tr></thead>
                    <tbody>
                         ${Array(20).fill(0).map((_, i) => `<tr oninput="calculateExamScore(this)"><td class="text-center">${i+1}</td><td contenteditable="true">Nama Siswa ${i+1}</td><td contenteditable="true" class="text-center exam-lancar">0</td><td contenteditable="true" class="text-center exam-tajwid">0</td><td contenteditable="true" class="text-center exam-irama">0</td><td contenteditable="true" class="text-center exam-adab">0</td><td class="text-center col-nilai-akhir exam-final">0</td><td contenteditable="true" class="text-center">LULUS</td></tr>`).join('')}
                    </tbody>
                </table>
                <div style="flex:1"></div>
                ${getTTD()}
                <div class="page-number"></div>
            `,
            setoran_hafalan_juz30: `
                <div class="landscape-marker" style="display:none;"></div>
                ${getKop()}
                <div class="text-center" style="margin-top: 15px; margin-bottom: 25px; padding-bottom: 12px; border-bottom: 1px solid #000;">
                    <h3 contenteditable="true" style="margin: 0 0 6px 0; font-weight: 700; font-size: 14pt; text-transform: uppercase;">REKAP SETORAN HAFALAN JUZ 30</h3>
                    <h3 class="data-sekolah" contenteditable="true" spellcheck="false" style="margin: 0; font-weight: 700; font-size: 12pt; text-transform: uppercase;">UPTD SD NEGERI 1 BATULAWANG</h3>
                </div>
                <table style="width: 100%; border-collapse: collapse; font-family: 'Times New Roman', Times, serif; font-size: 7pt; border: 2px solid #000; table-layout: fixed;">
                    <thead>
                        <tr><th rowspan="2" style="width: 3%; border: 1px solid #000; background-color: #e5e7eb;">No</th><th rowspan="2" style="width: 16%; border: 1px solid #000; background-color: #e5e7eb;">Nama Siswa</th><th colspan="37" style="border: 1px solid #000; background-color: #e5e7eb;">SURAH JUZ 30</th><th rowspan="2" style="width: 5%; border: 1px solid #000; background-color: #eef2ff;">Jml<br>Setor</th><th rowspan="2" style="width: 8%; border: 1px solid #000; background-color: #e5e7eb;">Ket</th></tr>
                        <tr>${["ANB","ANZ","ABS","ATK","AIF","AMF","AIS","ABR","ATR","AAL","AGS","AFJ","ABL","ASY","ALL","ADH","SRH","ATN","ALQ","AQD","ABY","AZL","ADY","AQR","TKT","ASR","AHM","AFL","QRS","AMN","AKT","AKF","NSR","LHB","IKH","FLQ","NAS"].map(surah => `<th style="border: 1px solid #000; background-color: #e5e7eb; height: 80px; width: 12px; padding: 0;"><div style="transform: rotate(-90deg); font-size: 6.5pt; font-weight: bold;">${surah}</div></th>`).join('')}</tr>
                    </thead>
                    <tbody>
                        ${["Annisa", "Arda", "Azzam", "Darnel", "Felari", "Lutfi", "Nadira", "Nur Fauzah", "Salma", "Septi", "Nayla"].map((nama, i) => `<tr><td class="text-center" style="border: 1px solid #000;">${i+1}</td><td contenteditable="true" style="border: 1px solid #000;">${nama}</td>${Array(37).fill(0).map(() => `<td class="text-center" style="border: 1px solid #000;"><input type="checkbox" onchange="calculateSetoranRow(this)" style="transform: scale(0.7); cursor: pointer;"></td>`).join('')}<td contenteditable="true" class="text-center text-bold total-setor" style="border: 1px solid #000; background-color: #eef2ff;">0</td><td contenteditable="true" class="text-center" style="border: 1px solid #000;">-</td></tr>`).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 30px; display: flex; justify-content: flex-end; padding-right: 25px; page-break-inside: avoid;">
                    <div style="text-align: center; width: 220px;">
                        <p>Banjar, <span contenteditable="true" class="data-tgl">...</span></p><p>Guru PAI / BTQ</p><div style="height: 65px;"></div>
                        <p class="text-upper data-guru format-ttd" contenteditable="true" spellcheck="false"><span class="nama-ttd">Nama Guru</span></p>
                        <p>NIP. <span class="data-nip2" contenteditable="true" spellcheck="false">...</span></p>
                    </div>
                </div>
                <div class="page-number"></div>
            `,
            absensi_guru: `
                ${getKop()}
                <div class="text-center text-bold text-upper" style="margin-bottom:20px;">
                    <h3 contenteditable="true">DAFTAR HADIR GURU PJP PAI</h3>
                    <h3 class="data-tgl" contenteditable="true" spellcheck="false">BULAN ...</h3>
                </div>
                <table class="table-grid">
                    <thead><tr><th width="40px" rowspan="2">No</th><th width="200px" rowspan="2">Nama Guru / NIP</th><th colspan="31">Tanggal</th></tr><tr>${get31DaysHeader()}</tr></thead>
                    <tbody>
                        <tr><td class="text-center">1</td><td style="text-align:left; padding-left:5px;"><span class="text-bold text-upper data-guru" contenteditable="true" spellcheck="false">Nama Guru</span><br>NIP. <span class="data-nip2" contenteditable="true" spellcheck="false">-</span></td>${get31DaysCells()}</tr>
                        <tr><td class="text-center">2</td><td style="text-align:left; padding-left:5px;"><span class="text-bold text-upper data-kepsek" contenteditable="true" spellcheck="false">Nama Kepala</span><br>NIP. <span class="data-nip1" contenteditable="true" spellcheck="false">-</span></td>${get31DaysCells()}</tr>
                    </tbody>
                </table>
                <div style="flex:1"></div>
                ${getTTD()}
                <div class="page-number"></div>
            `,
            absensi_siswa: `
                <div class="text-center text-bold text-upper" style="margin-bottom:15px;">
                    <h3 contenteditable="true">DAFTAR HADIR SISWA</h3>
                    <h3 class="data-sekolah" contenteditable="true" spellcheck="false">UPTD SD NEGERI ...</h3>
                </div>
                <table class="table-grid">
                    <thead><tr><th width="30px" rowspan="2">No</th><th width="150px" rowspan="2">Nama Siswa</th><th colspan="31">Tanggal</th></tr><tr>${get31DaysHeader()}</tr></thead>
                    <tbody>${Array(25).fill(0).map((_, i) => `<tr><td class="text-center">${i+1}</td><td contenteditable="true" style="text-align:left;">Nama Siswa ${i+1}</td>${get31DaysCells()}</tr>`).join('')}</tbody>
                </table>
                <div style="flex:1"></div>
                 <div style="margin-top:20px; text-align:right;">
                    <div style="display:inline-block; width:200px; text-align:center;">
                        <p>Banjar, <span contenteditable="true" class="data-tgl">...</span></p><p>Guru BTQ</p><br><br><br>
                        <p class="text-upper data-guru format-ttd" contenteditable="true" spellcheck="false"><span class="nama-ttd">Nama Guru</span></p>
                    </div>
                </div>
                <div class="page-number"></div>
            `,
            program_semester: `
                ${getKop()}
                <div class="text-center text-bold text-upper" style="margin-bottom:15px; border-bottom:1px solid #000; padding-bottom:10px;">
                    <h3 contenteditable="true">PROGRAM KEGIATAN SEMESTER</h3>
                </div>
                <div style="margin-bottom:15px;">
                    <table class="list-data">
                        <tr><td>Nama</td><td>:</td><td class="data-guru text-bold" contenteditable="true" spellcheck="false">NAMA GURU</td></tr>
                        <tr><td>Sekolah</td><td>:</td><td class="data-sekolah" contenteditable="true" spellcheck="false">NAMA SEKOLAH</td></tr>
                    </table>
                </div>
                <div class="text-bold" style="margin-bottom:5px;">I. PELAKSANAAN PEMBELAJARAN</div>
                <div style="margin-left:20px; margin-bottom:15px;"><label><input type="checkbox" checked> Bimbingan Klasikal</label><br><label><input type="checkbox"> Bimbingan Individual</label></div>
                
                <div class="text-bold" style="margin-bottom:5px;">II. TEMPAT PELAKSANAAN</div>
                <div style="margin-left:20px; margin-bottom:10px;"><label><input type="checkbox" checked> Sekolah</label><label style="margin-left:15px;"><input type="checkbox"> Masjid</label></div>
                
                <div class="text-bold" style="margin-bottom:5px;">III. WAKTU PELAKSANAAN</div>
                <div style="margin-left:20px; margin-bottom:15px;"><p>‚Ä¢ Kelas: <span contenteditable="true">V (Lima)</span></p></div>

                <div class="text-bold" style="margin-bottom:5px;">IV. DAFTAR MATERI DAN PELAKSANAANNYA</div>
                <table class="dinas">
                    <thead><tr><th rowspan="2" width="40%">Materi</th><th colspan="6">Bulan Pelaksanaan</th></tr><tr><th>Jul</th><th>Agt</th><th>Sep</th><th>Okt</th><th>Nov</th><th>Des</th></tr></thead>
                    <tbody>
                        <tr><td contenteditable="true">Membaca Al-Qur'an / Iqra</td><td class="text-center"><input type="checkbox"></td><td class="text-center"><input type="checkbox"></td><td class="text-center"><input type="checkbox"></td><td class="text-center"><input type="checkbox"></td><td class="text-center"><input type="checkbox"></td><td class="text-center"><input type="checkbox"></td></tr>
                    </tbody>
                </table>
                <div style="flex:1"></div>
                ${getTTD()}
                <div class="page-number"></div>
            `,
            hadir_ujian: `
                <div class="text-center text-bold text-upper" style="margin-bottom:20px; padding-top:20px;">
                    <h3 contenteditable="true">DAFTAR HADIR UJIAN BTQ SISWA KELAS V</h3>
                    <h3 class="data-sekolah" contenteditable="true" spellcheck="false">UPTD SD NEGERI ...</h3>
                </div>
                <table class="dinas">
                    <thead><tr><th width="5%">No</th><th width="15%">NISN</th><th width="35%">Nama Siswa</th><th width="45%">Tanda Tangan</th></tr></thead>
                    <tbody>${Array(20).fill(0).map((_, i) => `<tr><td class="text-center" style="height:35px;">${i+1}</td><td contenteditable="true"></td><td contenteditable="true">Nama Siswa ${i+1}</td><td style="vertical-align:top; font-size:9pt; color:#ccc;">${i+1}....................</td></tr>`).join('')}</tbody>
                </table>
                <div style="flex:1"></div>
                 <div style="margin-top:20px; text-align:right;">
                    <div style="display:inline-block; width:200px; text-align:center;">
                        <p>Banjar, <span contenteditable="true" class="data-tgl">...</span></p><p>Penguji</p><br><br><br>
                        <p class="text-upper data-guru format-ttd" contenteditable="true" spellcheck="false"><span class="nama-ttd">Nama Guru</span></p>
                    </div>
                </div>
                <div class="page-number"></div>
            `
        };

        window.onload = function() {
            if (!loadFromStorage()) {
                addPage('cover');
                addPage('laporan');
            } else {
                renderPages();
            }
        }
    </script>
    
    <!-- =========================================
       UX & UTILITY LOGIC
       ========================================= -->
    <script id="ux-logic">
        function uxToast(message, type = 'success') {
            const container = document.getElementById('uxToastContainer');
            const toast = document.createElement('div');
            let iconClass = type === 'error' ? 'ph-warning-circle' : type === 'info' ? 'ph-info' : 'ph-check-circle';

            toast.className = `ux-toast ${type}`;
            toast.innerHTML = `<i class="ph ${iconClass}"></i><span>${message}</span>`;
            container.appendChild(toast);
            
            requestAnimationFrame(() => toast.classList.add('visible'));
            setTimeout(() => { toast.classList.remove('visible'); setTimeout(() => toast.remove(), 400); }, 3000);
        }

        function uxShowLoader(text = "Memproses...") {
            document.getElementById('uxLoaderText').innerText = text;
            document.getElementById('uxLoader').classList.add('active');
        }

        function uxHideLoader() { document.getElementById('uxLoader').classList.remove('active'); }

        function uxBtnLoad(btn, start = true) {
            if(!btn) return;
            if (start) {
                btn.classList.add('ux-btn-loading');
                btn.dataset.originalText = btn.innerText;
            } else {
                btn.classList.remove('ux-btn-loading');
            }
        }

        function uxConfirm(title, desc) {
            return new Promise((resolve) => {
                const modal = document.getElementById('uxConfirmModal');
                document.getElementById('uxConfirmTitle').innerText = title;
                document.getElementById('uxConfirmDesc').innerText = desc;
                modal.classList.add('active');

                const cleanup = () => {
                    modal.classList.remove('active');
                    document.getElementById('uxBtnConfirm').removeEventListener('click', onConfirm);
                    document.getElementById('uxBtnCancel').removeEventListener('click', onCancel);
                };

                const onConfirm = () => { cleanup(); resolve(true); };
                const onCancel = () => { cleanup(); resolve(false); };

                document.getElementById('uxBtnConfirm').addEventListener('click', onConfirm);
                document.getElementById('uxBtnCancel').addEventListener('click', onCancel);
            });
        }

        const saveIndicator = document.getElementById('uxSaveIndicator');
        let hideSaveIndicatorTimeout;
        document.addEventListener('input', (e) => {
            if(e.target.closest('.sheet') || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                saveIndicator.classList.add('active');
                clearTimeout(hideSaveIndicatorTimeout);
                hideSaveIndicatorTimeout = setTimeout(() => { saveIndicator.classList.remove('active'); }, 1500);
            }
        });

        function handleAddPage(type, btn) {
            uxBtnLoad(btn, true);
            setTimeout(() => {
                try {
                    addPage(type);
                    uxToast("Halaman berhasil ditambahkan");
                } catch(e) {
                    uxToast("Gagal menambah halaman", "error");
                    console.error(e);
                } finally { uxBtnLoad(btn, false); }
            }, 300);
        }

        async function handleSafePrint(btn) {
            uxShowLoader("Menyiapkan PDF...");
            uxBtnLoad(btn, true);
            try {
                await new Promise(r => setTimeout(r, 100));
                await safePrint();
                uxToast("PDF Berhasil Diunduh!", "success");
            } catch (e) {
                uxToast("Gagal membuat PDF", "error");
            } finally {
                uxHideLoader();
                uxBtnLoad(btn, false);
            }
        }

        async function handleResetAllPages() {
            const confirmed = await uxConfirm("Reset Semua Data?", "Tindakan ini akan menghapus semua halaman dan data tersimpan. Tidak bisa dibatalkan.");
            if (confirmed) {
                const originalConfirm = window.confirm;
                window.confirm = () => true; 
                uxShowLoader("Mereset Sistem...");
                setTimeout(() => {
                    resetAllPages(); 
                    window.confirm = originalConfirm; 
                }, 500);
            }
        }

        let currentEditingIndex = -1;

        function openHtmlEditSelectionModal() {
            updateAllPageSelectors();
            const sheets = document.querySelectorAll('.sheet');
            if(sheets.length === 0) {
                uxToast("Tidak ada halaman.", "error");
                return;
            }
            document.getElementById('htmlEditSelectModal').style.display = 'flex';
        }

        function closeHtmlEditSelectModal() { document.getElementById('htmlEditSelectModal').style.display = 'none'; }

        function handleOpenHtmlEditor() {
            const index = document.getElementById('htmlPageSelect').value;
            if(index === "") return;

            currentEditingIndex = parseInt(index);
            const sheet = document.querySelectorAll('.sheet')[currentEditingIndex];
            if(!sheet) return;

            closeHtmlEditSelectModal();

            let contentToEdit = "";
            const isEmbed = sheet.dataset.pageType === 'embed';

            if(isEmbed) {
                const storage = sheet.querySelector('.raw-storage');
                contentToEdit = storage ? storage.value : "<!-- Error: Raw Storage not found -->";
                document.getElementById('editorPageInfo').innerText = `Halaman ${currentEditingIndex+1} (Embed Mode)`;
            } else {
                contentToEdit = sheet.innerHTML;
                document.getElementById('editorPageInfo').innerText = `Halaman ${currentEditingIndex+1} (Standard Mode)`;
            }

            document.getElementById('htmlCodeInput').value = formatHtmlForEditor(contentToEdit);
            document.getElementById('htmlEditorModal').style.display = 'flex';
        }

        function closeHtmlEditorModal() {
            document.getElementById('htmlEditorModal').style.display = 'none';
            currentEditingIndex = -1;
        }

        function handlePreviewHtml() {
            if(currentEditingIndex === -1) return;
            const code = document.getElementById('htmlCodeInput').value;
            const sheet = document.querySelectorAll('.sheet')[currentEditingIndex];
            const isEmbed = sheet.dataset.pageType === 'embed';

            try {
                const safeCode = cleanHTML(code);
                if(isEmbed) {
                    let wrapper = sheet.querySelector('.embed-safe-zone');
                    if(!wrapper) {
                         wrapper = document.createElement('div');
                         wrapper.className = 'embed-safe-zone';
                         sheet.innerHTML = '';
                         sheet.appendChild(wrapper);
                    }
                    wrapper.innerHTML = safeCode;
                } else {
                    sheet.innerHTML = safeCode;
                }
                uxToast("Preview diperbarui", "info");
                sheet.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch(e) {
                uxToast("HTML Invalid. Cek tag.", "error");
            }
        }

        function handleSaveHtmlChange() {
            if(currentEditingIndex === -1) return;
            const code = document.getElementById('htmlCodeInput').value;
            const sheet = document.querySelectorAll('.sheet')[currentEditingIndex];
            const isEmbed = sheet.dataset.pageType === 'embed';

            try {
                const safeCode = cleanHTML(code);
                if (isEmbed) {
                    let wrapper = sheet.querySelector('.embed-safe-zone');
                    if(!wrapper) {
                         wrapper = document.createElement('div');
                         wrapper.className = 'embed-safe-zone';
                         sheet.innerHTML = '';
                         sheet.appendChild(wrapper);
                    }
                    wrapper.innerHTML = safeCode;

                    let storage = sheet.querySelector('.raw-storage');
                    if(!storage) {
                        storage = document.createElement('textarea');
                        storage.className = 'raw-storage';
                        storage.style.display = 'none';
                        sheet.appendChild(storage);
                    }
                    storage.value = safeCode;
                    if(pagesDB[currentEditingIndex]) pagesDB[currentEditingIndex].rawHTML = safeCode;
                } else {
                    sheet.innerHTML = safeCode;
                    if(pagesDB[currentEditingIndex]) pagesDB[currentEditingIndex].html = safeCode;
                }

                saveToStorage();
                updatePageNumbers();
                uxToast("HTML Berhasil Disimpan", "success");
                closeHtmlEditorModal();
                setTimeout(() => { sheet.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 300);
            } catch(e) { uxToast("Gagal menyimpan. Cek error console.", "error"); }
        }

        function formatHtmlForEditor(html) {
            return html.replace(/<\/div>/g, '</div>\n').replace(/<\/p>/g, '</p>\n').replace(/<\/tr>/g, '</tr>\n').replace(/<br>/g, '<br>\n');
        }
    </script>

    <!-- ZIP EXPORT & IMPORT LOGIC -->
    <script id="zip-logic">
        async function exportToZip() {
            uxShowLoader("Menyiapkan file ZIP...");
            saveToStorage();

            let exportDB = JSON.parse(JSON.stringify(pagesDB));
            const zip = new JSZip();
            const imgFolder = zip.folder("images");
            let imgCounter = 1;

            exportDB.forEach((page, pageIndex) => {
                if (page.type === 'standard' && page.html) {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(page.html, 'text/html');
                    
                    doc.querySelectorAll('img').forEach((img, imgIndex) => {
                        const src = img.getAttribute('src');
                        if (src && src.startsWith('data:image/')) {
                            try {
                                const parts = src.split(',');
                                const mimeInfo = parts[0].match(/:(.*?);/);
                                if (mimeInfo) {
                                    const mime = mimeInfo[1];
                                    const ext = mime.split('/')[1] || 'png';
                                    const b64Data = parts[1];
                                    const fileName = `img_p${pageIndex}_${imgIndex}_${imgCounter++}.${ext}`;
                                    
                                    imgFolder.file(fileName, b64Data, {base64: true});
                                    img.setAttribute('src', `images/${fileName}`);
                                }
                            } catch(e) {}
                        }
                    });

                    doc.querySelectorAll('input[type="file"]').forEach(inp => inp.removeAttribute('value'));
                    page.html = doc.body.innerHTML;
                }
            });

            zip.file("data.json", JSON.stringify(exportDB, null, 2));

            try {
                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, "Laporan-Sekolah-Lengkap.zip");
                uxToast("Export ZIP Berhasil!", "success");
            } catch (err) {
                uxToast("Gagal men-generate ZIP", "error");
            } finally { uxHideLoader(); }
        }

        function importFromZipTrigger() { document.getElementById('zipLoader').click(); }

        function processZipImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            uxShowLoader("Mengekstrak file ZIP...");
            const zip = new JSZip();
            zip.loadAsync(file).then(async (loadedZip) => {
                try {
                    const jsonFile = loadedZip.file("data.json");
                    if (!jsonFile) throw new Error("File data.json tidak ditemukan!");

                    const jsonDataStr = await jsonFile.async("string");
                    let importedDB = JSON.parse(jsonDataStr);

                    for (let i = 0; i < importedDB.length; i++) {
                        const page = importedDB[i];
                        if (page.type === 'standard' && page.html) {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(page.html, 'text/html');
                            
                            const images = Array.from(doc.querySelectorAll('img'));
                            for (let img of images) {
                                const src = img.getAttribute('src');
                                if (src && src.startsWith('images/')) {
                                    const imgFileInZip = loadedZip.file(src);
                                    if (imgFileInZip) {
                                        const b64 = await imgFileInZip.async("base64");
                                        const ext = src.split('.').pop().toLowerCase();
                                        let mime = 'image/png';
                                        if(ext === 'jpg' || ext === 'jpeg') mime = 'image/jpeg';
                                        else if(ext === 'gif') mime = 'image/gif';
                                        else if(ext === 'svg') mime = 'image/svg+xml';
                                        else if(ext === 'webp') mime = 'image/webp';

                                        img.setAttribute('src', `data:${mime};base64,${b64}`);
                                    }
                                }
                            }
                            page.html = doc.body.innerHTML;
                        }
                    }

                    pagesDB = importedDB;
                    renderPages();      
                    saveToStorage();  
                    uxToast("Import ZIP Berhasil!", "success");
                } catch (err) {
                    uxToast(err.message || "Gagal memproses file ZIP", "error");
                } finally {
                    uxHideLoader();
                    event.target.value = ''; 
                }
            }).catch(err => {
                uxToast("Gagal membaca ZIP. File corrupt.", "error");
                uxHideLoader();
                event.target.value = '';
            });
        }
    </script>

    <!-- TAB INDENTATION & ORIENTATION LOGIC -->
    <script id="misc-logic">
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                const activeElement = document.activeElement;
                if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'SELECT')) return; 

                const isContentEditable = activeElement && activeElement.isContentEditable || (e.target && e.target.closest && e.target.closest('[contenteditable="true"]'));
                if (isContentEditable) {
                    e.preventDefault(); 
                    const selection = window.getSelection();
                    if (!selection.rangeCount) return;
                    const range = selection.getRangeAt(0);

                    if (!e.shiftKey) {
                        if (!range.collapsed) range.deleteContents(); 
                        const tabText = document.createTextNode('\u00a0\u00a0\u00a0\u00a0');
                        range.insertNode(tabText);
                        range.setStartAfter(tabText);
                        range.setEndAfter(tabText);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    } else {
                        if (!range.collapsed) return; 
                        if (range.startContainer.nodeType === Node.TEXT_NODE) {
                            const text = range.startContainer.textContent;
                            const offset = range.startOffset;
                            let spacesToRemove = 0;
                            for (let i = 1; i <= 4; i++) {
                                const charIndex = offset - i;
                                if (charIndex >= 0 && (text[charIndex] === ' ' || text[charIndex] === '\u00a0')) {
                                    spacesToRemove++;
                                } else break;
                            }
                            if (spacesToRemove > 0) {
                                range.startContainer.textContent = text.slice(0, offset - spacesToRemove) + text.slice(offset);
                                range.setStart(range.startContainer, offset - spacesToRemove);
                                range.setEnd(range.startContainer, offset - spacesToRemove);
                                selection.removeAllRanges();
                                selection.addRange(range);
                            }
                        }
                    }
                    if (e.target && e.target.dispatchEvent) e.target.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
        });

        function changeOrientation(mode) {
            const body = document.body;
            mode === 'landscape' ? body.classList.add('global-landscape') : body.classList.remove('global-landscape');
            
            let styleEl = document.getElementById('dynamic-print-style');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'dynamic-print-style';
                document.head.appendChild(styleEl);
            }
            styleEl.innerHTML = mode === 'landscape' ? '@media print { @page { size: 330mm 215mm !important; margin: 0; } }' : '@media print { @page { size: 215mm 330mm !important; margin: 0; } }';
            
            localStorage.setItem('global_orientation', mode);
            if(typeof autoPaginateCustomPages === 'function') setTimeout(autoPaginateCustomPages, 450);
        }

        window.addEventListener('DOMContentLoaded', () => {
            const savedMode = localStorage.getItem('global_orientation') || 'portrait';
            const selectEl = document.getElementById('global_orientation');
            if (selectEl) selectEl.value = savedMode;
            changeOrientation(savedMode);
        });

        function applyPageOrientation() {
            saveToStorage(); 
            const index = parseInt(document.getElementById('orientPageSelect').value);
            const mode = document.getElementById('orientPageMode').value;
            
            if (isNaN(index) || !pagesDB[index]) return;
            pagesDB[index].orientation = mode; 

            const sheet = document.querySelectorAll('.sheet')[index];
            if (sheet) {
                mode === 'landscape' ? sheet.classList.add('landscape') : sheet.classList.remove('landscape');
                sheet.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            saveToStorage(); 
            uxToast(`Halaman ${index + 1} diubah ke ${mode.toUpperCase()}`, "success");
        }

        function applyPageSwap() {
            const indexA = parseInt(document.getElementById('swapPageA').value);
            const indexB = parseInt(document.getElementById('swapPageB').value);
            
            if (isNaN(indexA) || isNaN(indexB) || indexA === indexB) {
                uxToast("Pilih halaman yang berbeda untuk ditukar.", "info");
                return;
            }

            saveToStorage(); 
            const temp = pagesDB[indexA];
            pagesDB[indexA] = pagesDB[indexB];
            pagesDB[indexB] = temp;

            renderPages(); 
            saveToStorage();
            
            const targetSheet = document.querySelectorAll('.sheet')[indexB];
            if(targetSheet) targetSheet.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            uxToast(`Halaman ${indexA + 1} ‚áÑ ${indexB + 1} berhasil ditukar!`, "success");
        }
    </script>
</body>
</html>
